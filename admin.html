<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <!-- Include the ban system script -->
    <script src="ban-system.js"></script>
    <style>
        table { border-collapse: collapse; width: 100%; margin-top: 24px; }
        th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
        th { background: #f8f8f8; }
        .ban-btn, .unban-btn, .delete-btn {
            padding: 5px 14px;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            margin-right: 6px;
        }
        .ban-btn { background: #dc3545; }
        .unban-btn { background: #28a745; }
        .delete-btn { background: #888; }
        /* Modal styles */
        #user-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        #user-detail-modal > div {
            background: #fff;
            padding: 32px 24px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 90vw;
        }
        /* Product admin styles */
        #product-form input, #product-form textarea { margin-bottom: 8px; display: block; width: 100%; }
        #product-list img { max-width: 60px; max-height: 60px; }
        .edit-btn { background: #007bff; color: #fff; border: none; border-radius: 4px; padding: 5px 14px; cursor: pointer; margin-right: 6px; }
        .admin-nav-btn {
            padding: 8px 18px;
            margin-right: 10px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
        }
        .admin-nav-btn.active {
            background: #0056b3;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
</head>
<body>
    <!-- Loading animation overlay -->
    <div id="loading-overlay" style="display:flex; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:99999; align-items:center; justify-content:center;">
        <div style="border:6px solid #f3f3f3; border-top:6px solid #007bff; border-radius:50%; width:48px; height:48px; animation:spin 1s linear infinite;"></div>
    </div>
    <h1>Admin Panel</h1>
    <!-- Admin navigation buttons -->
    <div style="margin-bottom:24px;">
        <button class="admin-nav-btn active" id="show-users-btn">User Details</button>
        <button class="admin-nav-btn" id="show-products-btn">Product Management</button>
        <button class="admin-nav-btn" id="show-mail-btn" title="Send Announcement">&#9993; Mail</button>
    </div>

    <!-- User Details Section -->
    <div id="user-section">
        <table id="user-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Age</th>
                    <th>Password</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- User rows will be rendered here -->
            </tbody>
        </table>
        <!-- User detail modal -->
        <div id="user-detail-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000; align-items:center; justify-content:center;">
            <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:300px; max-width:90vw;">
                <h2>User Details</h2>
                <div id="user-detail-content"></div>
                <button id="close-user-detail" style="margin-top:18px; padding:8px 18px; background:#007bff; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Product Management Section -->
    <div id="product-section" style="display:none;">
        <form id="product-form">
            <input type="hidden" id="product-id">
            <label>Product Name: <input type="text" id="product-name" required></label>
            <!-- Image upload and preview -->
            <label>Image: <input type="file" id="product-image-file" accept="image/*"></label>
            <input type="hidden" id="product-image">
            <img id="product-image-preview" src="" alt="Preview" style="display:none;max-width:80px;max-height:80px;margin-bottom:8px;">
            <label>Description: <textarea id="product-desc" required></textarea></label>
            <label>Price: <input type="number" id="product-price" min="1" required></label>
            <button type="submit" id="product-save-btn">Add Product</button>
            <button type="button" id="product-cancel-btn" style="display:none;">Cancel</button>
        </form>
        <table id="product-list">
            <thead>
                <tr>
                    <th>Photo</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Product rows will be rendered here -->
            </tbody>
        </table>
    </div>

    <!-- Mailbox Modal for Admin -->
    <div id="admin-mail-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:320px; max-width:90vw;">
            <h2 style="margin-top:0;">Send Announcement</h2>
            <form id="admin-mail-form">
                <label>Title: <input type="text" id="mail-title" required></label><br>
                <label>Message:<br>
                    <textarea id="mail-body" required style="width:100%;height:80px;"></textarea>
                </label><br>
                <button type="submit" style="padding:8px 18px; background:#007bff; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer;">Send</button>
                <button type="button" id="close-admin-mail" style="padding:8px 18px; background:#888; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer; margin-left:10px;">Cancel</button>
            </form>
            <hr style="margin:18px 0;">
            <h3>All Announcements</h3>
            <div id="admin-mailbox-messages" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
        </div>
    </div>

    <script>
        // --- Simple login protection: redirect to login.html if not logged in ---
        if (!localStorage.getItem('token')) {
            window.location.href = 'login.html';
        }
        // Enforce admin-only access
        if (localStorage.getItem('isAdmin') !== 'true') {
            window.location.href = 'index.html';
        }

        // Make sure isLoggedIn flag is set (needed for cart and mailbox access)
        if (localStorage.getItem('token') && !localStorage.getItem('isLoggedIn')) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // Make sure currentUser is set (needed for cart functionality)
        if (!localStorage.getItem('currentUser') && localStorage.getItem('username')) {
            localStorage.setItem('currentUser', localStorage.getItem('username'));
        }

        let users = [];
        let products = [];
        let announcements = [];

        // Load users from backend
        async function fetchUsers() {
            try {
                const res = await fetch('https://tridex1.onrender.com/users');
                users = await res.json();
                renderUsers();
            } catch (e) {
                users = [];
                renderUsers();
                alert('Failed to load users from database.');
            }
        }

        function renderUsers() {
            const tbody = document.querySelector('#user-table tbody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="username-link" style="color:#007bff; cursor:pointer; text-decoration:underline;">
                        ${user.username || ''} ${user.verified ? '<span title="Verified" style="color:#1da1f2; font-size:1.1em;vertical-align:middle;">&#10004;&#65039;</span>' : ''}
                    </td>
                    <td>${user.email || ''}</td>
                    <td>${user.phone || ''}</td>
                    <td>${user.age || ''}</td>
                    <td>${user.password || ''}</td>
                    <td>${user.banned ? '<span style="color:red;">Banned</span>' : 'Active'}</td>
                    <td>
                        <button type="button" class="ban-btn"${user.banned ? ' style="display:none;"' : ''}>Ban</button>
                        <button type="button" class="unban-btn"${!user.banned ? ' style="display:none;"' : ''}>Unban</button>
                        <button type="button" class="delete-btn">Delete</button>
                        <button type="button" class="verify-btn"${user.verified ? ' style="display:none;"' : ''}>Verify</button>
                    </td>
                `;
                // Show user details on username click
                tr.querySelector('.username-link').onclick = function() {
                    showUserDetail(user);
                };
                // Ban user (update DB in real app)
                tr.querySelector('.ban-btn').onclick = async function() {
                    if (confirm(`Ban ${user.username}?`)) {
                        try {
                            // Call the server to ban the user
                            await fetch(`https://tridex1.onrender.com/users/${user._id}/ban`, { method: 'PUT' });

                            // Also ban the user locally using our ban system
                            if (window.banSystem) {
                                window.banSystem.banUser(user.username);
                                console.log(`User ${user.username} banned locally`);
                            }

                            fetchUsers();
                        } catch (e) {
                            console.error('Failed to ban user on server:', e);

                            // If server fails, still ban locally
                            if (window.banSystem) {
                                window.banSystem.banUser(user.username);
                                console.log(`User ${user.username} banned locally (server failed)`);
                                fetchUsers();
                            } else {
                                alert('Failed to ban user.');
                            }
                        }
                    }
                };
                // Unban user (update DB in real app)
                tr.querySelector('.unban-btn').onclick = async function() {
                    if (confirm(`Unban ${user.username}?`)) {
                        try {
                            // Call the server to unban the user
                            await fetch(`https://tridex1.onrender.com/users/${user._id}/unban`, { method: 'PUT' });

                            // Also unban the user locally using our ban system
                            if (window.banSystem) {
                                window.banSystem.unbanUser(user.username);
                                console.log(`User ${user.username} unbanned locally`);
                            }

                            fetchUsers();
                        } catch (e) {
                            console.error('Failed to unban user on server:', e);

                            // If server fails, still unban locally
                            if (window.banSystem) {
                                window.banSystem.unbanUser(user.username);
                                console.log(`User ${user.username} unbanned locally (server failed)`);
                                fetchUsers();
                            } else {
                                alert('Failed to unban user.');
                            }
                        }
                    }
                };
                // Delete user (update DB in real app)
                tr.querySelector('.delete-btn').onclick = async function() {
                    if (confirm(`Delete ${user.username}?`)) {
                        try {
                            await fetch(`https://tridex1.onrender.com/users/${user._id}`, { method: 'DELETE' });
                            fetchUsers();
                        } catch (e) { alert('Failed to delete user.'); }
                    }
                };
                // Verify user (update DB in real app)
                tr.querySelector('.verify-btn').onclick = async function() {
                    try {
                        await fetch(`https://tridex1.onrender.com/users/${user._id}/verify`, { method: 'PUT' });
                        fetchUsers();
                    } catch (e) { alert('Failed to verify user.'); }
                };
                tbody.appendChild(tr);
            });
        }

        function showUserDetail(user) {
            const modal = document.getElementById('user-detail-modal');
            const content = document.getElementById('user-detail-content');
            // Show all fields dynamically
            let html = '';
            for (const key in user) {
                if (user.hasOwnProperty(key)) {
                    html += `<p><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${user[key]}</p>`;
                }
            }
            content.innerHTML = html;
            modal.style.display = 'flex';
        }

        document.getElementById('close-user-detail').onclick = function() {
            document.getElementById('user-detail-modal').style.display = 'none';
        };

        // --- Product Management (DB version) ---
        async function fetchProducts() {
            try {
                const res = await fetch('https://tridex1.onrender.com/products');
                products = await res.json();
                renderProducts();
            } catch (e) {
                products = [];
                renderProducts();
                alert('Failed to load products from database.');
            }
        }
        function renderProducts() {
            const tbody = document.querySelector('#product-list tbody');
            tbody.innerHTML = '';
            (products || []).forEach(product => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${product.image || ''}" alt="${product.name}" style="cursor:pointer;" class="product-img" data-id="${product._id}"></td>
                    <td>${product.name}</td>
                    <td>${product.desc}</td>
                    <td>₹${product.price}</td>
                    <td>
                        <button class="edit-btn" data-id="${product._id}">Edit</button>
                        <button class="delete-btn" data-id="${product._id}">Delete</button>
                    </td>
                `;
                tr.querySelector('.product-img').onclick = function() {
                    window.location.href = `product-details.html?id=${product._id}`;
                };
                tr.querySelector('.edit-btn').onclick = function() {
                    setProductForm(product);
                };
                tr.querySelector('.delete-btn').onclick = async function() {
                    if (confirm('Delete this product?')) {
                        try {
                            await fetch(`https://tridex1.onrender.com/products/${product._id}`, { method: 'DELETE' });
                            fetchProducts();
                        } catch (e) { alert('Failed to delete product.'); }
                    }
                };
                tbody.appendChild(tr);
            });
        }
        // Set form fields for editing, including image preview
        function setProductForm(product) {
            document.getElementById('product-id').value = product._id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-image').value = product.image;
            document.getElementById('product-desc').value = product.desc;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-save-btn').textContent = 'Update Product';
            document.getElementById('product-cancel-btn').style.display = '';
            if (product.image) {
                document.getElementById('product-image-preview').src = product.image;
                document.getElementById('product-image-preview').style.display = '';
            } else {
                document.getElementById('product-image-preview').style.display = 'none';
            }
            document.getElementById('product-image-file').value = '';
        }
        // Handle image file upload and convert to base64
        document.getElementById('product-image-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file size (limit to 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size exceeds 5MB. Please choose a smaller image.');
                    this.value = ''; // Clear the file input
                    return;
                }

                // Show loading indicator
                showLoading();

                const reader = new FileReader();
                reader.onload = function(event) {
                    // Set the base64 string to the hidden input
                    document.getElementById('product-image').value = event.target.result;
                    // Show preview
                    document.getElementById('product-image-preview').src = event.target.result;
                    document.getElementById('product-image-preview').style.display = '';
                    hideLoading();
                };
                reader.onerror = function() {
                    alert('Failed to read the image file. Please try again.');
                    hideLoading();
                };
                reader.readAsDataURL(file);
            }
        });

        // Add/Edit Product (DB version)
        document.getElementById('product-form').onsubmit = async function(e) {
            e.preventDefault();

            // Show loading indicator
            showLoading();

            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value.trim();
            let image = document.getElementById('product-image').value.trim();
            const desc = document.getElementById('product-desc').value.trim();
            const price = document.getElementById('product-price').value.trim();

            // Validate inputs
            if (!name) {
                alert('Product name is required');
                hideLoading();
                return;
            }

            if (!price || isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                hideLoading();
                return;
            }

            try {
                if (id) {
                    // Update
                    const response = await fetch(`https://tridex1.onrender.com/products/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, image, desc, price })
                    });

                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }

                    alert('Product updated successfully!');
                } else {
                    // Add
                    const response = await fetch('https://tridex1.onrender.com/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, image, desc, price })
                    });

                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }

                    alert('Product added successfully!');
                }

                // Reset form
                this.reset();
                document.getElementById('product-save-btn').textContent = 'Add Product';
                document.getElementById('product-cancel-btn').style.display = 'none';
                document.getElementById('product-image-preview').style.display = 'none';
                document.getElementById('product-image').value = '';

                // Refresh product list
                fetchProducts();
            } catch (e) {
                console.error('Product operation failed:', e);
                alert(`Failed to ${id ? 'update' : 'add'} product: ${e.message}`);
            } finally {
                hideLoading();
            }
        };
        // Cancel edit
        document.getElementById('product-cancel-btn').onclick = function() {
            document.getElementById('product-form').reset();
            document.getElementById('product-save-btn').textContent = 'Add Product';
            this.style.display = 'none';
            document.getElementById('product-image-preview').style.display = 'none';
            document.getElementById('product-image').value = '';
        };

        // --- Announcement Management (DB version) ---
        async function fetchAnnouncements() {
            try {
                const res = await fetch('https://tridex1.onrender.com/announcements');
                announcements = await res.json();
                renderAdminMessages();
            } catch (e) {
                announcements = [];
                renderAdminMessages();
                alert('Failed to load announcements from database.');
            }
        }
        document.getElementById('admin-mail-form').onsubmit = async function(e) {
            e.preventDefault();

            // Show loading indicator
            showLoading();

            const title = document.getElementById('mail-title').value.trim();
            const message = document.getElementById('mail-body').value.trim();

            // Validate inputs
            if (!title) {
                alert('Announcement title is required');
                hideLoading();
                return;
            }

            if (!message) {
                alert('Announcement message is required');
                hideLoading();
                return;
            }

            try {
                const response = await fetch('https://tridex1.onrender.com/announcements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, message })
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                alert('Announcement sent successfully!');
                document.getElementById('admin-mail-modal').style.display = 'none';
                this.reset();
                fetchAnnouncements();
            } catch (e) {
                console.error('Failed to send announcement:', e);
                alert(`Failed to send announcement: ${e.message}`);
            } finally {
                hideLoading();
            }
        };
        function renderAdminMessages() {
            const messagesDiv = document.getElementById('admin-mailbox-messages');
            if (!announcements || announcements.length === 0) {
                messagesDiv.innerHTML = '<p style="color:#888;">No messages.</p>';
            } else {
                messagesDiv.innerHTML = announcements.map((msg, idx) =>
                    `<div style="border-bottom:1px solid #eee; padding:8px 0;">
                        <strong>${msg.title || 'Announcement'}</strong>
                        <div style="font-size:0.97em; margin-top:4px;">${msg.message}</div>
                        <div style="font-size:0.85em; color:#888; margin-top:2px;">${new Date(msg.createdAt).toLocaleString() || ''}</div>
                        <button class="delete-msg-btn" data-id="${msg._id}" style="margin-top:6px; padding:4px 12px; background:#dc3545; color:#fff; border:none; border-radius:4px; font-size:0.95em; cursor:pointer;">Delete</button>
                    </div>`
                ).join('');
                // Add delete handlers
                messagesDiv.querySelectorAll('.delete-msg-btn').forEach(btn => {
                    btn.onclick = async function() {
                        const id = this.getAttribute('data-id');
                        if (confirm('Delete this message?')) {
                            // Show loading indicator
                            showLoading();

                            try {
                                const response = await fetch(`https://tridex1.onrender.com/announcements/${id}`, { method: 'DELETE' });

                                if (!response.ok) {
                                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                                }

                                fetchAnnouncements();
                            } catch (e) {
                                console.error('Failed to delete announcement:', e);
                                alert(`Failed to delete announcement: ${e.message}`);
                            } finally {
                                hideLoading();
                            }
                        }
                    };
                });
            }
        }
        // Show mailbox modal and fetch announcements
        document.getElementById('show-mail-btn').onclick = function() {
            document.getElementById('admin-mail-modal').style.display = 'flex';
            fetchAnnouncements();
        };
        document.getElementById('close-admin-mail').onclick = function() {
            document.getElementById('admin-mail-modal').style.display = 'none';
        };

        // --- Navigation between sections ---
        document.getElementById('show-users-btn').onclick = function() {
            document.getElementById('user-section').style.display = '';
            document.getElementById('product-section').style.display = 'none';
            document.getElementById('show-users-btn').classList.add('active');
            document.getElementById('show-products-btn').classList.remove('active');
        };
        document.getElementById('show-products-btn').onclick = function() {
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('product-section').style.display = '';
            document.getElementById('show-products-btn').classList.add('active');
            document.getElementById('show-users-btn').classList.remove('active');
        };

        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        window.addEventListener('load', function() {
            hideLoading();
        });
        window.addEventListener('beforeunload', function() {
            showLoading();
        });

        // On load
        fetchUsers();
        fetchProducts();
    </script>
</body>
</html>
