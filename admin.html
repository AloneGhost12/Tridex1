<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/product-media-gallery.css">
    <link rel="stylesheet" href="css/color-variant-manager.css">
    <link rel="stylesheet" href="css/admin-responsive.css">
    <!-- Comprehensive Responsive Styles -->
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/navigation-responsive.css">
    <link rel="stylesheet" href="css/forms-responsive.css">
    <link rel="stylesheet" href="css/ecommerce-responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom Popup System -->
    <link rel="stylesheet" href="css/custom-popups.css">

    <link rel="stylesheet" href="css/wishlist.css">
    <script src="js/custom-popups.js"></script>
    <script>
        // --- Strict Admin-Only Authentication Check ---
(async function enforceStrictAdminAuth() {
    console.log('Admin Panel: Starting strict authentication check...');

    // Clear any existing redirect loops by removing history
    if (document.referrer && document.referrer.includes('admin.html')) {
        console.log('Admin Panel: Potential redirect loop detected, clearing history');
        history.replaceState(null, '', 'admin.html');
    }

    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';

    console.log('Admin Panel: Auth check - Token:', !!token, 'Username:', username, 'IsAdmin:', isAdmin);

    // First level check: Basic requirements
    if (!token || !username || !isAdmin) {
        console.log('Admin Panel: Basic auth requirements not met, redirecting to login');
        localStorage.removeItem('token');
        localStorage.removeItem('isAdmin');
        localStorage.removeItem('username');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('isLoggedIn');
        window.location.replace('login.html?error=admin_access_required');
        return;
    }

    // Second level check: Verify admin credentials are from proper login method
    const adminLoginMethod = localStorage.getItem('adminLoginMethod');
    if (!adminLoginMethod || adminLoginMethod !== 'admin_form_login') {
        console.log('Admin Panel: Invalid admin login method, redirecting to login');
        localStorage.removeItem('token');
        localStorage.removeItem('isAdmin');
        localStorage.removeItem('username');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('adminLoginMethod');
        window.location.replace('login.html?error=invalid_admin_access');
        return;
    }

    // Third level check: Verify with backend for extra security (with fallback)
    try {
        console.log('Admin Panel: Verifying admin status with server...');

        let userData = null;
        let verificationSuccessful = false;

        // Try the new user endpoint first with better error handling
        try {
            console.log('Admin Panel: Trying user endpoint...');

            // Add timeout to prevent hanging requests
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

            const userResponse = await fetch(`https://tridex1.onrender.com/users/${username}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (userResponse.ok) {
                userData = await userResponse.json();
                verificationSuccessful = true;
                console.log('Admin Panel: User endpoint successful, user data:', userData);
            } else {
                console.warn(`Admin Panel: User endpoint failed with status: ${userResponse.status} ${userResponse.statusText}`);
                if (userResponse.status === 404) {
                    console.log('Admin Panel: User endpoint not found (404) - this is expected if server is not updated');
                }
            }
        } catch (userError) {
            console.warn('Admin Panel: User endpoint error:', userError.message);
            if (userError.name === 'AbortError') {
                console.log('Admin Panel: User endpoint request timed out');
            }
        }

        // Fallback: If server verification failed, check if it's the hardcoded admin
        if (!verificationSuccessful) {
            if (username === 'admin') {
                console.log('Admin Panel: Server verification failed, but user is hardcoded admin - allowing access');
                verificationSuccessful = true;
                userData = { username: 'admin', isAdmin: true };
            } else {
                console.log('Admin Panel: Server verification failed for non-admin user:', username);
            }
        }

        // Evaluate the verification result
        if (verificationSuccessful && userData) {
            if (userData.isAdmin || username === 'admin') {
                // Update localStorage with server-confirmed admin status
                localStorage.setItem('isAdmin', 'true');
                console.log('Admin Panel: Authentication successful, admin access granted');
            } else {
                console.log('Admin Panel: Server confirms user is not admin, redirecting');
                localStorage.removeItem('token');
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('username');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('adminLoginMethod');
                window.location.replace('login.html?error=not_admin');
                return;
            }
        } else {
            // If server verification failed but user is hardcoded admin, allow access with warning
            if (username === 'admin') {
                console.log('Admin Panel: Server verification failed, but allowing hardcoded admin access');
                localStorage.setItem('isAdmin', 'true');

                // Show a warning message about server connectivity
                setTimeout(() => {
                    if (typeof tridexWarning !== 'undefined') {
                        tridexWarning('Server verification failed, but you are logged in as the hardcoded admin. Some features may not work properly until server connectivity is restored.', 'Server Connection Warning');
                    }
                }, 1000);
            } else {
                console.log('Admin Panel: Server verification failed, redirecting to login');
                localStorage.removeItem('token');
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('username');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('adminLoginMethod');
                window.location.replace('login.html?error=server_verification_failed');
                return;
            }
        }
    } catch (error) {
        console.error('Admin Panel: Error verifying admin status:', error);

        // If it's the hardcoded admin and server is unreachable, allow access
        if (username === 'admin') {
            console.log('Admin Panel: Server unreachable but user is hardcoded admin - allowing access');
            localStorage.setItem('isAdmin', 'true');
        } else {
            localStorage.removeItem('token');
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('username');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('adminLoginMethod');
            window.location.replace('login.html?error=verification_error');
            return;
        }
    }
})();
        // Fallback functions in case custom popups don't load
        window.tridexConfirm = window.tridexConfirm || function(message) { return Promise.resolve(confirm(message)); };
        window.tridexSuccess = window.tridexSuccess || function(message) { alert(message); return Promise.resolve(); };
        window.tridexError = window.tridexError || function(message) { alert(message); return Promise.resolve(); };
        window.tridexWarning = window.tridexWarning || function(message) { alert(message); return Promise.resolve(); };
        window.tridexInfo = window.tridexInfo || function(message) { alert(message); return Promise.resolve(); };
    </script>
    <!-- Include the ban system script -->
    <script src="ban-system.js"></script>
    <style>
        table { border-collapse: collapse; width: 100%; margin-top: 24px; }
        th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
        th { background: #f8f8f8; }
        .ban-btn, .unban-btn, .delete-btn {
            padding: 5px 14px;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            margin-right: 6px;
        }
        .ban-btn { background: #dc3545; }
        .unban-btn { background: #28a745; }
        .delete-btn { background: #888; }
        /* Modal styles */
        #user-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        #user-detail-modal > div {
            background: #fff;
            padding: 32px 24px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 90vw;
        }
        /* Product admin styles */
        #product-form input, #product-form textarea { margin-bottom: 8px; display: block; width: 100%; }
        #product-list img { max-width: 60px; max-height: 60px; }
        .edit-btn { background: #007bff; color: #fff; border: none; border-radius: 4px; padding: 5px 14px; cursor: pointer; margin-right: 6px; }
        .admin-nav-btn {
            padding: 8px 18px;
            margin-right: 10px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
        }
        .admin-nav-btn.active {
            background: #0056b3;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
</head>
<body>
    <!-- Loading animation overlay -->
    <div id="loading-overlay" style="display:flex; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:99999; align-items:center; justify-content:center;">
        <div style="border:6px solid #f3f3f3; border-top:6px solid #007bff; border-radius:50%; width:48px; height:48px; animation:spin 1s linear infinite;"></div>
    </div>
    <h1>Admin Panel</h1>
    <!-- Admin controls -->
    <div class="admin-controls">
        <button id="verify-cloudinary-btn" class="btn btn-info btn-sm" style="background:#17a2b8; color:white; border:none; border-radius:4px; cursor:pointer;">
            <i class="fas fa-cloud-upload-alt"></i> Check Cloudinary
        </button>
        <button id="verify-product-images-btn" class="btn btn-info btn-sm" style="background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">
            <i class="fas fa-images"></i> Verify Images
        </button>
        <span id="cloudinary-status" style="font-size:0.9em;"></span>
    </div>

    <!-- Admin navigation buttons -->
    <div class="admin-nav-container">
        <button class="admin-nav-btn active" id="show-users-btn"><i class="fas fa-users"></i> Users</button>
        <button class="admin-nav-btn" id="show-products-btn"><i class="fas fa-box"></i> Products</button>
        <button class="admin-nav-btn" id="show-categories-btn"><i class="fas fa-tags"></i> Categories</button>
        <button class="admin-nav-btn" id="show-reviews-btn" title="Review Management"><i class="fas fa-star"></i> Reviews</button>
        <button class="admin-nav-btn" id="show-orders-btn" title="Order Management"><i class="fas fa-shipping-fast"></i> Orders</button>
        <button class="admin-nav-btn" id="show-analytics-btn" title="Sales Analytics"><i class="fas fa-chart-bar"></i> Analytics</button>
        <button class="admin-nav-btn" id="show-coupons-btn" title="Coupon Management"><i class="fas fa-ticket-alt"></i> Coupons</button>
        <button class="admin-nav-btn" id="show-flash-sales-btn" title="Flash Sale Management"><i class="fas fa-bolt"></i> Flash Sales</button>
        <button class="admin-nav-btn" id="show-mail-btn" title="Send Announcement"><i class="fas fa-envelope"></i> Mail</button>
        <button class="admin-nav-btn" id="show-contact-btn" title="Contact Messages"><i class="fas fa-phone"></i> Messages</button>
    </div>

    <!-- User Details Section -->
    <div id="user-section">
        <div class="admin-controls">
            <button id="debug-ban-system" style="background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-bug"></i> Debug Ban System
            </button>
            <button id="force-check-ban-status" style="background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-sync-alt"></i> Check Ban Status
            </button>
            <span id="debug-output" style="font-family: monospace;"></span>
        </div>
        <div class="table-responsive">
            <table id="user-table" class="mobile-optimized-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- User rows will be rendered here -->
                </tbody>
            </table>
        </div>
        <!-- User detail modal -->
        <div id="user-detail-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000; align-items:center; justify-content:center;">
            <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:300px; max-width:90vw;">
                <h2>User Details</h2>
                <div id="user-detail-content"></div>
                <button id="close-user-detail" style="margin-top:18px; padding:8px 18px; background:#007bff; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Product Management Section -->
    <div id="product-section" style="display:none;">
        <div style="margin-bottom: 20px;">
            <button type="button" id="regenerate-all-summaries-btn" class="admin-nav-btn">
                <i class="fas fa-sync-alt"></i> Regenerate All AI Summaries
            </button>
            <span id="regenerate-status" style="margin-left: 10px; font-style: italic; color: #666;"></span>
        </div>
        <form id="product-form">
            <input type="hidden" id="product-id">
            <label>Product Name: <input type="text" id="product-name" required></label>

            <!-- Product Media Gallery -->
            <div class="media-gallery-container" id="media-gallery-container">
                <h3>Product Media Gallery</h3>
                <div class="media-upload-controls">
                    <label for="media-file-input" class="media-upload-btn">
                        <i class="fas fa-cloud-upload-alt"></i> Upload Images/Videos
                    </label>
                    <input type="file" id="media-file-input" multiple accept="image/*,video/*" style="display:none;">

                    <div style="display:flex; flex:1; margin-left:10px;">
                        <input type="text" id="video-url-input" class="video-url-input" placeholder="Add video URL (YouTube, Vimeo, etc.)">
                        <button type="button" id="add-video-btn" class="add-video-btn">
                            <i class="fas fa-plus"></i> Add Video
                        </button>
                    </div>
                </div>

                <div id="media-preview-container" class="media-preview-container">
                    <!-- Media previews will be rendered here -->
                </div>

                <!-- Legacy image field for backward compatibility -->
                <input type="hidden" id="product-image">
                <img id="product-image-preview" src="" alt="Preview" style="display:none;max-width:80px;max-height:80px;margin-bottom:8px;">
            </div>

            <label>Description: <textarea id="product-desc" required></textarea></label>
            <label>Price: <input type="number" id="product-price" min="1" required></label>
            <label>Category:
                <select id="product-category" name="category" required>
                    <option value="">-- Select Category --</option>
                    <!-- Categories will be loaded dynamically -->
                </select>
            </label>

            <!-- Color Variant Management -->
            <div id="color-variant-container"></div>

            <button type="submit" id="product-save-btn">Add Product</button>
            <button type="button" id="product-cancel-btn" style="display:none;">Cancel</button>
            <button type="button" id="regenerate-summary-btn" style="display:none;">Regenerate AI Summary</button>
        </form>
        <div class="table-responsive">
            <table id="product-list" class="mobile-optimized-table">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Price</th>
                        <th>Category</th>
                        <th>AI Summary</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Product rows will be rendered here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Category Management Section -->
    <div id="category-section" style="display:none;">
        <form id="category-form">
            <input type="hidden" id="category-id">
            <div class="form-group">
                <label for="category-name">Category Name:</label>
                <input type="text" id="category-name" required>
            </div>
            <!-- Icon upload and preview -->
            <div class="form-group">
                <label for="category-icon-file">Icon:</label>
                <input type="file" id="category-icon-file" accept="image/*">
            </div>
            <input type="hidden" id="category-icon">
            <div class="form-group">
                <img id="category-icon-preview" src="" alt="Preview" style="display:none;max-width:80px;max-height:80px;margin-bottom:8px;">
            </div>
            <div class="form-group">
                <label for="category-desc">Description:</label>
                <textarea id="category-desc"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" id="category-save-btn">Add Category</button>
                <button type="button" id="category-cancel-btn" style="display:none;">Cancel</button>
            </div>
        </form>
        <div class="table-responsive">
            <table id="category-list" class="mobile-optimized-table">
                <thead>
                    <tr>
                        <th>Icon</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Products</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Category rows will be rendered here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Orders Section -->
    <div id="orders-section" style="display:none;">
        <h2>Order Management</h2>
        <div class="orders-filters" style="margin-bottom:20px;">
            <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center; margin-bottom:15px;">
                <div>
                    <label for="order-status-filter">Status:</label>
                    <select id="order-status-filter" style="padding:5px; border-radius:4px; border:1px solid #ddd;">
                        <option value="">All</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div>
                    <label for="order-customer-search">Customer:</label>
                    <input type="text" id="order-customer-search" placeholder="Username or email..." style="padding:5px; border-radius:4px; border:1px solid #ddd; width:200px;">
                </div>
                <div>
                    <label for="order-date-from">From:</label>
                    <input type="date" id="order-date-from" style="padding:5px; border-radius:4px; border:1px solid #ddd;">
                </div>
                <div>
                    <label for="order-date-to">To:</label>
                    <input type="date" id="order-date-to" style="padding:5px; border-radius:4px; border:1px solid #ddd;">
                </div>
                <button id="order-search-btn" style="padding:5px 10px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Search</button>
                <button id="order-reset-btn" style="padding:5px 10px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">Reset</button>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <button id="export-orders-csv" style="padding:5px 10px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer;">
                        <i class="fas fa-file-csv"></i> Export to CSV
                    </button>
                </div>
                <div>
                    <label for="orders-per-page">Orders per page:</label>
                    <select id="orders-per-page" style="padding:5px; border-radius:4px; border:1px solid #ddd;">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="orders-table-container" style="overflow-x:auto;">
            <table id="orders-table" style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr>
                        <th style="cursor:pointer;" data-sort="createdAt">Order Date <i class="fas fa-sort"></i></th>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th style="cursor:pointer;" data-sort="totalAmount">Total <i class="fas fa-sort"></i></th>
                        <th>Payment</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orders-list">
                    <!-- Orders will be rendered here -->
                    <tr>
                        <td colspan="8" style="text-align:center; padding:20px;">Loading orders...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="orders-pagination" style="margin-top:20px; text-align:center;">
            <!-- Pagination controls will be rendered here -->
        </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics-section" style="display:none;">
        <h2>Sales Analytics</h2>

        <!-- Analytics Controls -->
        <div class="analytics-controls" style="margin-bottom:30px; display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
            <div>
                <label for="analytics-year">Year:</label>
                <select id="analytics-year" style="padding:8px; border-radius:4px; border:1px solid #ddd; margin-left:10px;">
                    <!-- Years will be populated dynamically -->
                </select>
            </div>
            <div>
                <button id="refresh-analytics-btn" style="padding:8px 16px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
            <div>
                <button id="download-chart-btn" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer;">
                    <i class="fas fa-download"></i> Download Chart
                </button>
            </div>
        </div>

        <!-- Analytics Stats Cards -->
        <div class="analytics-stats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:30px;">
            <div class="stat-card" style="background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center;">
                <h3 style="margin:0 0 10px 0; color:#666; font-size:14px;">Total Orders</h3>
                <div id="total-orders-stat" style="font-size:24px; font-weight:bold; color:#007bff;">0</div>
            </div>
            <div class="stat-card" style="background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center;">
                <h3 style="margin:0 0 10px 0; color:#666; font-size:14px;">Total Revenue</h3>
                <div id="total-revenue-stat" style="font-size:24px; font-weight:bold; color:#28a745;">₹0</div>
            </div>
            <div class="stat-card" style="background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center;">
                <h3 style="margin:0 0 10px 0; color:#666; font-size:14px;">Average Order Value</h3>
                <div id="avg-order-stat" style="font-size:24px; font-weight:bold; color:#ffc107;">₹0</div>
            </div>
            <div class="stat-card" style="background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center;">
                <h3 style="margin:0 0 10px 0; color:#666; font-size:14px;">Growth Rate</h3>
                <div id="growth-rate-stat" style="font-size:24px; font-weight:bold; color:#17a2b8;">0%</div>
            </div>
        </div>

        <!-- Chart Container -->
        <div class="chart-container" style="background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:30px;">
            <h3 style="margin:0 0 20px 0; color:#333;">Monthly Sales Overview</h3>
            <div style="position:relative; height:400px;">
                <canvas id="monthly-sales-chart"></canvas>
            </div>
        </div>

        <!-- Additional Charts -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(400px, 1fr)); gap:20px;">
            <!-- Order Status Distribution -->
            <div class="chart-container" style="background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin:0 0 20px 0; color:#333;">Order Status Distribution</h3>
                <div style="position:relative; height:300px;">
                    <canvas id="order-status-chart"></canvas>
                </div>
            </div>

            <!-- Top Products -->
            <div class="chart-container" style="background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin:0 0 20px 0; color:#333;">Top Selling Products</h3>
                <div style="position:relative; height:300px;">
                    <canvas id="top-products-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; overflow-y:auto;">
        <div style="background:white; margin:50px auto; padding:20px; max-width:800px; border-radius:8px; position:relative;">
            <button id="close-order-details" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
            <h2>Order Details</h2>
            <div id="order-details-content">
                <!-- Order details will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Contact Messages Section -->
    <div id="contact-section" style="display:none;">
        <div class="admin-controls">
            <div class="contact-filters">
                <select id="contact-status-filter" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
                    <option value="">All Statuses</option>
                    <option value="New">New</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Resolved">Resolved</option>
                    <option value="Closed">Closed</option>
                </select>
                <input type="text" id="contact-search" placeholder="Search messages..." style="padding:8px; border-radius:4px; border:1px solid #ccc; margin-left:10px; width:250px;">
                <button id="contact-search-btn" style="padding:8px 15px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; margin-left:10px;">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            <div class="contact-pagination">
                <span id="contact-pagination-info" style="margin-right:15px;">Showing 1-20 of 0</span>
                <button id="contact-prev-page" style="padding:5px 10px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button id="contact-next-page" style="padding:5px 10px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer; margin-left:5px;">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table id="contact-table" class="mobile-optimized-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Contact message rows will be rendered here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Contact Message Detail Modal -->
    <div id="contact-detail-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:600px; max-width:90vw; max-height:90vh; overflow-y:auto;">
            <h2 style="margin-top:0;">Contact Message Details</h2>
            <div id="contact-detail-content">
                <!-- Contact message details will be rendered here -->
            </div>
            <hr style="margin:18px 0;">
            <h3>Respond to Message</h3>
            <form id="contact-response-form">
                <input type="hidden" id="contact-id">
                <textarea id="contact-response" style="width:100%; height:100px; padding:8px; border-radius:4px; border:1px solid #ccc;" placeholder="Type your response here..."></textarea>
                <div style="margin-top:15px;">
                    <button type="submit" style="padding:8px 18px; background:#28a745; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer;">Send Response</button>
                    <button type="button" id="close-contact-detail" style="padding:8px 18px; background:#888; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer; margin-left:10px;">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mailbox Modal for Admin -->
    <div id="admin-mail-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:320px; max-width:90vw;">
            <h2 style="margin-top:0;">Send Announcement</h2>
            <form id="admin-mail-form">
                <label>Title: <input type="text" id="mail-title" required></label><br>
                <label>Message:<br>
                    <textarea id="mail-body" required style="width:100%;height:80px;"></textarea>
                </label><br>
                <button type="submit" style="padding:8px 18px; background:#007bff; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer;">Send</button>
                <button type="button" id="close-admin-mail" style="padding:8px 18px; background:#888; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer; margin-left:10px;">Cancel</button>
            </form>
            <hr style="margin:18px 0;">
            <h3>All Announcements</h3>
            <div id="admin-mailbox-messages" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
        </div>
    </div>

    <!-- Include the product media gallery script -->
    <script src="js/product-media-gallery.js"></script>
    <!-- Include the color variant manager script -->
    <script src="js/color-variant-manager.js"></script>

    <script>
        // Global error handler to catch 404s and other errors
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
            console.error('Error details:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno
            });
        });

        // Catch unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });

        // --- Admin Panel Initialization ---
        console.log('Admin panel loading...');
        console.log('Token:', !!localStorage.getItem('token'));
        console.log('isAdmin:', localStorage.getItem('isAdmin'));
        console.log('Username:', localStorage.getItem('username'));

        // Verify admin authentication is still valid
        (function checkAdminAuth() {
            const token = localStorage.getItem('token');
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const adminLoginMethod = localStorage.getItem('adminLoginMethod');

            if (!token || !isAdmin || adminLoginMethod !== 'admin_form_login') {
                console.log('Admin panel: Authentication invalid, redirecting to login');
                window.location.replace('login.html?error=session_invalid');
                return; // Now this return is valid inside the function
            }
        })();

        // Function to get Cloudinary configuration from server
        async function getCloudinaryConfig() {
            try {
                // First try the local server since it's running
                let response;
                try {
                    console.log('Trying local server first...');
                    response = await fetch('http://localhost:3000/cloudinary-config');
                    console.log('Local server response status:', response.status);
                } catch (fetchError) {
                    console.warn('Could not reach local server, trying production server...', fetchError);
                    // If local server fails, try production server
                    response = await fetch('https://tridex1.onrender.com/cloudinary-config');
                    console.log('Production server response status:', response.status);
                }

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.cloudName || data.cloudName === 'your_cloud_name') {
                    throw new Error('Cloudinary cloud name not properly configured on the server');
                }

                // Check if API key is missing
                if (!data.apiKey) {
                    console.error('Cloudinary API key not provided by the server');
                    console.error('Please check your server .env file and make sure it contains a valid CLOUDINARY_API_KEY');

                    // Show a more detailed error message
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position:fixed; top:20px; right:20px; background:#f8d7da; color:#721c24; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                    errorDiv.innerHTML = `
                        <h3 style="margin-top:0;">Cloudinary Configuration Error</h3>
                        <p>The API key is missing from the server configuration.</p>
                        <p>Images will be stored as base64 until this is fixed.</p>
                        <p><strong>To fix this:</strong></p>
                        <ol>
                            <li>Check your server's .env file</li>
                            <li>Make sure CLOUDINARY_API_KEY is set correctly</li>
                            <li>Restart the server</li>
                        </ol>
                        <button onclick="this.parentNode.remove()" style="padding:5px 10px; background:#721c24; color:white; border:none; border-radius:3px; cursor:pointer;">Close</button>
                    `;
                    document.body.appendChild(errorDiv);
                }

                console.log('Successfully retrieved Cloudinary configuration');
                return data;
            } catch (error) {
                console.error('Error fetching Cloudinary config:', error);

                // Show a more detailed error message
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed; top:20px; right:20px; background:#f8d7da; color:#721c24; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                errorDiv.innerHTML = `
                    <h3 style="margin-top:0;">Cloudinary Configuration Error</h3>
                    <p>${error.message}</p>
                    <p>Images will be stored as base64 until this is fixed.</p>
                    <p><strong>To fix this:</strong></p>
                    <ol>
                        <li>Check your server's .env file</li>
                        <li>Make sure CLOUDINARY_CLOUD_NAME and CLOUDINARY_API_KEY are set correctly</li>
                        <li>Restart the server</li>
                    </ol>
                    <button onclick="this.parentNode.remove()" style="padding:5px 10px; background:#721c24; color:white; border:none; border-radius:3px; cursor:pointer;">Close</button>
                `;
                document.body.appendChild(errorDiv);

                // Fallback to a placeholder - this will fail but won't expose credentials
                return { cloudName: 'your_cloud_name', apiKey: 'missing_api_key' };
            }
        }

        // Make sure isLoggedIn flag is set (needed for cart and mailbox access)
        if (localStorage.getItem('token') && !localStorage.getItem('isLoggedIn')) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // Make sure currentUser is set (needed for cart functionality)
        if (!localStorage.getItem('currentUser') && localStorage.getItem('username')) {
            localStorage.setItem('currentUser', localStorage.getItem('username'));
        }

        // --- Admin Session Validation ---
        // Periodically validate admin session to prevent unauthorized access
        function validateAdminSession() {
            const token = localStorage.getItem('token');
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const adminLoginMethod = localStorage.getItem('adminLoginMethod');
            const username = localStorage.getItem('username');

            console.log('Admin Panel: Validating session...');

            if (!token || !isAdmin || adminLoginMethod !== 'admin_form_login' || !username) {
                console.log('Admin Panel: Session validation failed, redirecting to login');
                localStorage.removeItem('token');
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('username');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('adminLoginMethod');
                window.location.replace('login.html?error=session_expired');
                return false;
            }

            console.log('Admin Panel: Session validation successful');
            return true;
        }

        // Validate session every 5 minutes
        setInterval(validateAdminSession, 5 * 60 * 1000);

        // Validate session when page becomes visible (user switches back to tab)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('Admin Panel: Page became visible, validating session...');
                validateAdminSession();
            }
        });

        // Validate session on page focus
        window.addEventListener('focus', function() {
            console.log('Admin Panel: Window focused, validating session...');
            validateAdminSession();
        });

        // --- Prevent Direct URL Access ---
        // Check if user came from login page or has valid session
        function checkAccessMethod() {
            const referrer = document.referrer;
            const hasValidSession = localStorage.getItem('adminLoginMethod') === 'admin_form_login';

            // If no valid session and didn't come from login page, redirect
            if (!hasValidSession && !referrer.includes('login.html')) {
                console.log('Admin Panel: Direct URL access detected without valid session');
                localStorage.removeItem('token');
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('username');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('adminLoginMethod');
                window.location.replace('login.html?error=direct_access_denied');
                return false;
            }

            return true;
        }

        // Check access method on page load
        checkAccessMethod();

        let users = [];
        let products = [];
        let announcements = [];
        let mediaGallery; // Media gallery instance
        let colorVariantManager; // Color variant manager instance

        // Load users from backend
        async function fetchUsers() {
            try {
                // Show loading indicator
                showLoading();

                // Fetch users from the server (try local first)
                let res;
                try {
                    console.log('Fetching users from local server...');
                    res = await fetch('http://localhost:3000/users');
                    console.log('Local server users response status:', res.status);
                } catch (fetchError) {
                    console.warn('Could not reach local server for users, trying production server...', fetchError);
                    res = await fetch('https://tridex1.onrender.com/users');
                    console.log('Production server users response status:', res.status);
                }

                if (!res.ok) {
                    throw new Error(`Failed to fetch users: ${res.status} ${res.statusText}`);
                }

                users = await res.json();
                console.log('Successfully fetched users:', users.length);

                // Synchronize ban status with the ban system
                if (window.banSystem) {
                    console.log('Synchronizing ban status with ban system...');

                    // Get the current list of banned users from localStorage
                    const bannedUsers = window.banSystem.getBannedUsers();
                    console.log('Current banned users in localStorage:', bannedUsers);

                    // Create a new array to store the updated banned users list
                    const updatedBannedUsers = [];

                    // Process each user
                    for (const user of users) {
                        try {
                            // Check the server ban status for this user
                            const response = await fetch(`https://tridex1.onrender.com/users/check-ban/${user.username}`);

                            if (response.ok) {
                                const data = await response.json();
                                console.log(`Server ban status for ${user.username}:`, data.isBanned);

                                // Update the user object with the server ban status
                                user.banned = data.isBanned;

                                // If the user is banned according to the server, add to the updated list
                                if (data.isBanned) {
                                    updatedBannedUsers.push(user.username);
                                }
                            } else {
                                console.error(`Failed to check ban status for ${user.username}:`, response.status);

                                // If we can't check with the server, use the current ban status
                                if (user.banned) {
                                    updatedBannedUsers.push(user.username);
                                }
                            }
                        } catch (error) {
                            console.error(`Error checking ban status for ${user.username}:`, error);

                            // If there's an error, use the current ban status
                            if (user.banned) {
                                updatedBannedUsers.push(user.username);
                            }
                        }
                    }

                    // Update the bannedUsers list in localStorage
                    localStorage.setItem('bannedUsers', JSON.stringify(updatedBannedUsers));
                    sessionStorage.setItem('bannedUsers', JSON.stringify(updatedBannedUsers));

                    console.log('Updated banned users in localStorage:', updatedBannedUsers);
                }

                // Render the users
                renderUsers();
            } catch (e) {
                console.error('Failed to load users from database:', e);
                users = [];
                renderUsers();
                alert('Failed to load users from database.');
            } finally {
                // Hide loading indicator
                hideLoading();
            }
        }

        function renderUsers() {
            const tbody = document.querySelector('#user-table tbody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');

                // Determine user type and display appropriate info
                const userType = user.isGoogleUser ?
                    '<span style="color:#4285f4; font-weight:bold;">📧 Google</span>' :
                    '<span style="color:#28a745; font-weight:bold;">🔐 Regular</span>';

                // Format phone number display
                const phoneDisplay = user.phone || '<span style="color:#999;">Not provided</span>';

                // Format age display
                const ageDisplay = user.age || '<span style="color:#999;">Not provided</span>';

                // Format gender display
                const genderDisplay = user.gender ?
                    user.gender.charAt(0).toUpperCase() + user.gender.slice(1) :
                    '<span style="color:#999;">Not provided</span>';

                tr.innerHTML = `
                    <td class="username-link" style="color:#007bff; cursor:pointer; text-decoration:underline; text-transform:uppercase; letter-spacing:0.5px; font-weight:500;">
                        ${user.username || ''} ${user.verified ? '<span title="Verified" style="color:#1da1f2; font-size:1.1em;vertical-align:middle;">✓</span>' : ''}
                    </td>
                    <td style="font-weight:500;">${user.name || '<span style="color:#999;">Not provided</span>'}</td>
                    <td>${user.email || ''}</td>
                    <td>${phoneDisplay}</td>
                    <td>${ageDisplay}</td>
                    <td>${genderDisplay}</td>
                    <td>${userType}</td>
                    <td>${user.banned ? '<span style="color:red; font-weight:bold;">❌ Banned</span>' : '<span style="color:green; font-weight:bold;">✅ Active</span>'}</td>
                    <td>
                        <button type="button" class="ban-btn"${user.banned ? ' style="display:none;"' : ''}>Ban</button>
                        <button type="button" class="unban-btn"${!user.banned ? ' style="display:none;"' : ''}>Unban</button>
                        <button type="button" class="delete-btn">Delete</button>
                        <button type="button" class="verify-btn"${user.verified ? ' style="display:none;"' : ''} style="background:#1da1f2; color:white; border:none; border-radius:4px; padding:5px 14px; cursor:pointer; margin-right:6px;">Verify</button>
                        <button type="button" class="unverify-btn"${!user.verified ? ' style="display:none;"' : ''} style="background:#6c757d; color:white; border:none; border-radius:4px; padding:5px 14px; cursor:pointer;">Unverify</button>
                    </td>
                `;
                // Show user details on username click
                tr.querySelector('.username-link').onclick = function() {
                    showUserDetail(user);
                };
                // Ban user (update DB in real app)
                tr.querySelector('.ban-btn').onclick = async function() {
                    // Ensure popup system is loaded
                    if (typeof tridexConfirm === 'undefined') {
                        if (!confirm(`Ban ${user.username}?`)) return;
                    } else {
                        const confirmed = await tridexConfirm(
                            `Are you sure you want to ban user "${user.username}"? This action will prevent them from accessing the website.`,
                            'Ban User Confirmation'
                        );
                        if (!confirmed) return;
                    }

                    try {
                        // Show loading indicator
                        showLoading();

                        // Call the server to ban the user
                        const response = await fetch(`https://tridex1.onrender.com/users/${user._id}/ban`, { method: 'PUT' });

                        // Log server response
                        console.log(`Server ban response for ${user.username}:`, response.status);

                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }

                        // Verify the ban was successful by checking with the server
                        const verifyResponse = await fetch(`https://tridex1.onrender.com/users/check-ban/${user.username}`);

                        if (!verifyResponse.ok) {
                            throw new Error(`Failed to verify ban status: ${verifyResponse.status}`);
                        }

                        const verifyData = await verifyResponse.json();
                        console.log(`Server verification of ban for ${user.username}:`, verifyData);

                        if (!verifyData.isBanned) {
                            throw new Error(`Server still reports ${user.username} as not banned after ban request`);
                        }

                        // Update the user object
                        user.banned = true;

                        // Also ban the user locally using our ban system
                        if (window.banSystem) {
                            // First, ensure the user is added to the banned list in localStorage
                            const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                            if (!bannedUsers.includes(user.username)) {
                                bannedUsers.push(user.username);
                                localStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                                sessionStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                            }

                            // Then call the ban function
                            const result = window.banSystem.banUser(user.username);
                            console.log(`User ${user.username} ban result: ${result ? 'success' : 'failed'}`);

                            // Update the debug output
                            const currentBannedUsers = window.banSystem.debugBanSystem();
                            document.getElementById('debug-output').textContent =
                                currentBannedUsers.length > 0 ?
                                `Banned users: ${currentBannedUsers.join(', ')}` :
                                'No banned users found';

                            // Broadcast the ban event to all tabs/windows
                            try {
                                if (typeof BroadcastChannel !== 'undefined') {
                                    const banChannel = new BroadcastChannel('tridex_ban_system');
                                    console.log(`Broadcasting ban event for ${user.username} from admin panel`);
                                    banChannel.postMessage({
                                        type: 'ban',
                                        username: user.username,
                                        timestamp: Date.now(),
                                        source: 'admin-panel'
                                    });
                                    // Close the channel after sending the message
                                    setTimeout(() => banChannel.close(), 1000);
                                }
                            } catch (error) {
                                console.error('Error broadcasting ban event:', error);
                            }
                        }

                        // Update the UI to show the user is now banned
                        const statusCell = tr.querySelector('td:nth-child(6)');
                        if (statusCell) {
                            statusCell.innerHTML = '<span style="color:red;">Banned</span>';
                        }

                        // Hide the ban button and show the unban button
                        tr.querySelector('.ban-btn').style.display = 'none';
                        tr.querySelector('.unban-btn').style.display = '';

                        // Refresh the user list to ensure all data is up to date
                        fetchUsers();

                        // Show success message
                        const successMessage = document.createElement('div');
                        successMessage.style.cssText = 'position:fixed; bottom:20px; right:20px; background:#dc3545; color:#fff; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                        successMessage.innerHTML = `
                            <strong>Success!</strong><br>
                            User ${user.username} has been banned.
                        `;
                        document.body.appendChild(successMessage);

                        // Remove the message after 3 seconds
                        setTimeout(() => {
                            successMessage.style.opacity = '0';
                            successMessage.style.transition = 'opacity 0.5s ease';
                            setTimeout(() => successMessage.remove(), 500);
                        }, 3000);

                    } catch (e) {
                        console.error('Failed to ban user on server:', e);

                        // Show error message
                        const errorMessage = document.createElement('div');
                        errorMessage.style.cssText = 'position:fixed; bottom:20px; right:20px; background:#dc3545; color:#fff; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                        errorMessage.innerHTML = `
                            <strong>Error!</strong><br>
                            Failed to ban user ${user.username}: ${e.message}
                        `;
                        document.body.appendChild(errorMessage);

                        // Remove the message after 5 seconds
                        setTimeout(() => {
                            errorMessage.style.opacity = '0';
                            errorMessage.style.transition = 'opacity 0.5s ease';
                            setTimeout(() => errorMessage.remove(), 500);
                        }, 5000);

                        // If server fails, still try to ban locally
                        if (window.banSystem) {
                            // First, ensure the user is added to the banned list in localStorage
                            const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                            if (!bannedUsers.includes(user.username)) {
                                bannedUsers.push(user.username);
                                localStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                                sessionStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                            }

                            // Then call the ban function
                            const result = window.banSystem.banUser(user.username);
                            console.log(`User ${user.username} local ban result: ${result ? 'success' : 'failed'}`);

                            // Update the debug output
                            const currentBannedUsers = window.banSystem.debugBanSystem();
                            document.getElementById('debug-output').textContent =
                                currentBannedUsers.length > 0 ?
                                `Banned users: ${currentBannedUsers.join(', ')}` :
                                'No banned users found';

                            // Update the UI to show the user is now banned
                            const statusCell = tr.querySelector('td:nth-child(6)');
                            if (statusCell) {
                                statusCell.innerHTML = '<span style="color:red;">Banned</span>';
                            }

                            // Hide the ban button and show the unban button
                            tr.querySelector('.ban-btn').style.display = 'none';
                            tr.querySelector('.unban-btn').style.display = '';

                            // Refresh the user list
                            fetchUsers();
                        } else {
                            alert('Failed to ban user.');
                        }
                    } finally {
                        // Hide loading indicator
                        hideLoading();
                    }
                };
                // Unban user (update DB in real app)
                tr.querySelector('.unban-btn').onclick = async function() {
                    // Ensure popup system is loaded
                    if (typeof tridexConfirm === 'undefined') {
                        if (!confirm(`Unban ${user.username}?`)) return;
                    } else {
                        const confirmed = await tridexConfirm(
                            `Are you sure you want to unban user "${user.username}"? This will restore their access to the website.`,
                            'Unban User Confirmation'
                        );
                        if (!confirmed) return;
                    }

                    try {
                        // Show loading indicator
                        showLoading();

                        // Call the server to unban the user
                        const response = await fetch(`https://tridex1.onrender.com/users/${user._id}/unban`, { method: 'PUT' });

                        // Log server response
                        console.log(`Server unban response for ${user.username}:`, response.status);

                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }

                        // Verify the unban was successful by checking with the server
                        const verifyResponse = await fetch(`https://tridex1.onrender.com/users/check-ban/${user.username}`);

                        if (!verifyResponse.ok) {
                            throw new Error(`Failed to verify unban status: ${verifyResponse.status}`);
                        }

                        const verifyData = await verifyResponse.json();
                        console.log(`Server verification of unban for ${user.username}:`, verifyData);

                        if (verifyData.isBanned) {
                            throw new Error(`Server still reports ${user.username} as banned after unban request`);
                        }

                        // Update the user object
                        user.banned = false;

                        // Also unban the user locally using our ban system
                        if (window.banSystem) {
                            // First, ensure the user is removed from the banned list in localStorage
                            const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                            const updatedList = bannedUsers.filter(u => u !== user.username);
                            localStorage.setItem('bannedUsers', JSON.stringify(updatedList));
                            sessionStorage.setItem('bannedUsers', JSON.stringify(updatedList));

                            // Clear all ban-related flags for this user
                            if (localStorage.getItem('bannedUsername') === user.username) {
                                localStorage.removeItem('bannedUsername');
                            }
                            if (localStorage.getItem('username') === user.username ||
                                localStorage.getItem('currentUser') === user.username) {
                                localStorage.removeItem('loginPageBanMessageShown');
                                sessionStorage.removeItem('userBanned');
                                sessionStorage.removeItem('showBanMessage');
                            }

                            // Then call the unban function
                            const result = window.banSystem.unbanUser(user.username);
                            console.log(`User ${user.username} unban result: ${result ? 'success' : 'failed'}`);

                            // Update the debug output
                            const currentBannedUsers = window.banSystem.debugBanSystem();
                            document.getElementById('debug-output').textContent =
                                currentBannedUsers.length > 0 ?
                                `Banned users: ${currentBannedUsers.join(', ')}` :
                                'No banned users found';

                            // Broadcast the unban event to all tabs/windows
                            try {
                                if (typeof BroadcastChannel !== 'undefined') {
                                    const banChannel = new BroadcastChannel('tridex_ban_system');
                                    console.log(`Broadcasting unban event for ${user.username} from admin panel`);
                                    banChannel.postMessage({
                                        type: 'unban',
                                        username: user.username,
                                        timestamp: Date.now(),
                                        source: 'admin-panel'
                                    });
                                    // Close the channel after sending the message
                                    setTimeout(() => banChannel.close(), 1000);
                                }
                            } catch (error) {
                                console.error('Error broadcasting unban event:', error);
                            }
                        }

                        // Update the UI to show the user is now unbanned
                        const statusCell = tr.querySelector('td:nth-child(6)');
                        if (statusCell) {
                            statusCell.innerHTML = 'Active';
                        }

                        // Show the ban button and hide the unban button
                        tr.querySelector('.ban-btn').style.display = '';
                        tr.querySelector('.unban-btn').style.display = 'none';

                        // Refresh the user list to ensure all data is up to date
                        fetchUsers();

                        // Show success message
                        const successMessage = document.createElement('div');
                        successMessage.style.cssText = 'position:fixed; bottom:20px; right:20px; background:#28a745; color:#fff; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                        successMessage.innerHTML = `
                            <strong>Success!</strong><br>
                            User ${user.username} has been unbanned.
                        `;
                        document.body.appendChild(successMessage);

                        // Remove the message after 3 seconds
                        setTimeout(() => {
                            successMessage.style.opacity = '0';
                            successMessage.style.transition = 'opacity 0.5s ease';
                            setTimeout(() => successMessage.remove(), 500);
                        }, 3000);

                    } catch (e) {
                        console.error('Failed to unban user on server:', e);

                        // Show error message
                        const errorMessage = document.createElement('div');
                        errorMessage.style.cssText = 'position:fixed; bottom:20px; right:20px; background:#dc3545; color:#fff; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                        errorMessage.innerHTML = `
                            <strong>Error!</strong><br>
                            Failed to unban user ${user.username}: ${e.message}
                        `;
                        document.body.appendChild(errorMessage);

                        // Remove the message after 5 seconds
                        setTimeout(() => {
                            errorMessage.style.opacity = '0';
                            errorMessage.style.transition = 'opacity 0.5s ease';
                            setTimeout(() => errorMessage.remove(), 500);
                        }, 5000);

                        // If server fails, still try to unban locally
                        if (window.banSystem) {
                            // First, ensure the user is removed from the banned list in localStorage
                            const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                            const updatedList = bannedUsers.filter(u => u !== user.username);
                            localStorage.setItem('bannedUsers', JSON.stringify(updatedList));
                            sessionStorage.setItem('bannedUsers', JSON.stringify(updatedList));

                            // Clear all ban-related flags for this user
                            if (localStorage.getItem('bannedUsername') === user.username) {
                                localStorage.removeItem('bannedUsername');
                            }
                            if (localStorage.getItem('username') === user.username ||
                                localStorage.getItem('currentUser') === user.username) {
                                localStorage.removeItem('loginPageBanMessageShown');
                                sessionStorage.removeItem('userBanned');
                                sessionStorage.removeItem('showBanMessage');
                            }

                            // Then call the unban function
                            const result = window.banSystem.unbanUser(user.username);
                            console.log(`User ${user.username} local unban result: ${result ? 'success' : 'failed'}`);

                            // Update the debug output
                            const currentBannedUsers = window.banSystem.debugBanSystem();
                            document.getElementById('debug-output').textContent =
                                currentBannedUsers.length > 0 ?
                                `Banned users: ${currentBannedUsers.join(', ')}` :
                                'No banned users found';

                            // Update the UI to show the user is now unbanned
                            const statusCell = tr.querySelector('td:nth-child(6)');
                            if (statusCell) {
                                statusCell.innerHTML = 'Active';
                            }

                            // Show the ban button and hide the unban button
                            tr.querySelector('.ban-btn').style.display = '';
                            tr.querySelector('.unban-btn').style.display = 'none';

                            // Refresh the user list
                            fetchUsers();
                        } else {
                            if (typeof tridexError !== 'undefined') {
                                await tridexError('Failed to unban user. Please try again.', 'Unban Failed');
                            } else {
                                alert('Failed to unban user.');
                            }
                        }
                    } finally {
                        // Hide loading indicator
                        hideLoading();
                    }
                };
                // Delete user (update DB in real app)
                tr.querySelector('.delete-btn').onclick = async function() {
                    // Ensure popup system is loaded
                    if (typeof tridexConfirm === 'undefined') {
                        if (!confirm(`Delete ${user.username}?`)) return;
                    } else {
                        const confirmed = await tridexConfirm(
                            `Are you sure you want to permanently delete user "${user.username}"? This action cannot be undone.`,
                            'Delete User Confirmation'
                        );
                        if (!confirmed) return;
                    }

                    try {
                        showLoading();
                        await fetch(`https://tridex1.onrender.com/users/${user._id}`, { method: 'DELETE' });

                        if (typeof tridexSuccess !== 'undefined') {
                            await tridexSuccess(`User "${user.username}" has been deleted successfully.`, 'User Deleted');
                        }
                        fetchUsers();
                    } catch (e) {
                        if (typeof tridexError !== 'undefined') {
                            await tridexError('Failed to delete user. Please try again.', 'Delete Failed');
                        } else {
                            alert('Failed to delete user. Please try again.');
                        }
                    } finally {
                        hideLoading();
                    }
                };
                // Verify user
                tr.querySelector('.verify-btn').onclick = async function() {
                    try {
                        showLoading();
                        await fetch(`https://tridex1.onrender.com/users/${user._id}/verify`, { method: 'PUT' });

                        // Create a verification announcement for the user
                        const verificationMessage = {
                            title: "Account Verified! ✓",
                            message: `Congratulations ${user.username}! Your account has been verified by an administrator. You now have a verified badge on your profile.`,
                            forUser: user.username
                        };

                        // Send the verification announcement
                        await fetch('https://tridex1.onrender.com/announcements', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(verificationMessage)
                        });

                        fetchUsers();
                    } catch (e) {
                        console.error('Failed to verify user:', e);
                        alert('Failed to verify user.');
                    } finally {
                        hideLoading();
                    }
                };

                // Unverify user
                tr.querySelector('.unverify-btn').onclick = async function() {
                    try {
                        showLoading();
                        await fetch(`https://tridex1.onrender.com/users/${user._id}/unverify`, { method: 'PUT' });
                        fetchUsers();
                    } catch (e) {
                        console.error('Failed to unverify user:', e);
                        alert('Failed to unverify user.');
                    } finally {
                        hideLoading();
                    }
                };
                tbody.appendChild(tr);
            });
        }

        function showUserDetail(user) {
            const modal = document.getElementById('user-detail-modal');
            const content = document.getElementById('user-detail-content');

            // Format dates
            const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            }) : 'Not available';

            const updatedDate = user.updatedAt ? new Date(user.updatedAt).toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            }) : 'Not available';

            // Determine user type and create appropriate display
            const isGoogleUser = user.isGoogleUser || false;
            const userTypeDisplay = isGoogleUser ?
                '<span style="color:#4285f4; font-weight:bold; background:#e8f0fe; padding:4px 8px; border-radius:12px;">📧 Google User</span>' :
                '<span style="color:#28a745; font-weight:bold; background:#e8f5e8; padding:4px 8px; border-radius:12px;">🔐 Regular User</span>';

            // Create comprehensive user details HTML
            let html = `
                <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                    <!-- User Type Badge -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        ${userTypeDisplay}
                    </div>

                    <!-- Profile Picture (for Google users) -->
                    ${user.profilePicture ? `
                        <div style="text-align: center; margin-bottom: 20px;">
                            <img src="${user.profilePicture}" alt="Profile Picture"
                                 style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #4285f4;">
                        </div>
                    ` : ''}

                    <!-- Basic Information -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px;">👤 Basic Information</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <p><strong>Username:</strong> <span style="text-transform: uppercase; color: #007bff; font-weight: bold;">${user.username || 'Not provided'}</span></p>
                            <p><strong>Full Name:</strong> ${user.name || '<span style="color: #999;">Not provided</span>'}</p>
                            <p><strong>Email:</strong> ${user.email || '<span style="color: #999;">Not provided</span>'}</p>
                            <p><strong>Phone:</strong> ${user.phone || '<span style="color: #999;">Not provided</span>'}</p>
                            <p><strong>Age:</strong> ${user.age || '<span style="color: #999;">Not provided</span>'}</p>
                            <p><strong>Gender:</strong> ${user.gender ? user.gender.charAt(0).toUpperCase() + user.gender.slice(1) : '<span style="color: #999;">Not provided</span>'}</p>
                        </div>
                    </div>

                    <!-- Account Status -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 5px;">🔒 Account Status</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <p><strong>Status:</strong> ${user.banned ? '<span style="color: red; font-weight: bold;">❌ Banned</span>' : '<span style="color: green; font-weight: bold;">✅ Active</span>'}</p>
                            <p><strong>Verified:</strong> ${user.verified ? '<span style="color: #1da1f2; font-weight: bold;">✓ Verified</span>' : '<span style="color: #999;">Not verified</span>'}</p>
                            <p><strong>Admin:</strong> ${user.isAdmin ? '<span style="color: #dc3545; font-weight: bold;">👑 Admin</span>' : '<span style="color: #999;">Regular User</span>'}</p>
                            <p><strong>Account Type:</strong> ${isGoogleUser ? '<span style="color: #4285f4;">Google OAuth</span>' : '<span style="color: #28a745;">Email/Password</span>'}</p>
                        </div>
                    </div>

                    <!-- Google-specific Information -->
                    ${isGoogleUser ? `
                        <div style="background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4285f4;">
                            <h4 style="margin-top: 0; color: #1a73e8; border-bottom: 2px solid #4285f4; padding-bottom: 5px;">📧 Google Account Details</h4>
                            <p><strong>Google ID:</strong> <code style="background: #f1f3f4; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">${user.googleId || 'Not available'}</code></p>
                            <p><strong>Profile Picture:</strong> ${user.profilePicture ? '<span style="color: #28a745;">✓ Available</span>' : '<span style="color: #999;">Not available</span>'}</p>
                            <p><strong>Email Verified:</strong> <span style="color: #28a745; font-weight: bold;">✓ Verified by Google</span></p>
                        </div>
                    ` : `
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #28a745;">
                            <h4 style="margin-top: 0; color: #155724; border-bottom: 2px solid #28a745; padding-bottom: 5px;">🔐 Regular Account Details</h4>
                            <p><strong>Password:</strong> <code style="background: #f1f3f4; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">${user.password ? '••••••••' : 'Not set'}</code></p>
                            <p><strong>Registration Method:</strong> Email & Password</p>
                        </div>
                    `}

                    <!-- Saved Addresses -->
                    ${user.addresses && user.addresses.length > 0 ? `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                            <h4 style="margin-top: 0; color: #856404; border-bottom: 2px solid #ffc107; padding-bottom: 5px;">📍 Saved Addresses (${user.addresses.length})</h4>
                            ${user.addresses.map((address, index) => `
                                <div style="background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #ffeaa7;">
                                    <strong>Address ${index + 1}:</strong><br>
                                    ${address.street || ''}<br>
                                    ${address.city || ''}, ${address.state || ''} ${address.zipCode || ''}<br>
                                    ${address.country || ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Account Timestamps -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #333; border-bottom: 2px solid #6c757d; padding-bottom: 5px;">📅 Account Timeline</h4>
                        <p><strong>Created:</strong> ${createdDate}</p>
                        <p><strong>Last Updated:</strong> ${updatedDate}</p>
                        <p><strong>User ID:</strong> <code style="background: #f1f3f4; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">${user._id || 'Not available'}</code></p>
                    </div>

                    <!-- Additional Technical Details -->
                    <details style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: bold; color: #495057;">🔧 Technical Details</summary>
                        <div style="margin-top: 10px; font-family: monospace; font-size: 0.9em; background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">
                            ${Object.entries(user).map(([key, value]) => {
                                if (['password', 'profilePicture', 'addresses'].includes(key)) return '';
                                return `<div><strong>${key}:</strong> ${typeof value === 'object' ? JSON.stringify(value) : value || 'null'}</div>`;
                            }).filter(item => item).join('')}
                        </div>
                    </details>
                </div>
            `;

            content.innerHTML = html;
            modal.style.display = 'flex';
        }

        document.getElementById('close-user-detail').onclick = function() {
            document.getElementById('user-detail-modal').style.display = 'none';
        };

        // --- Product Management (DB version) ---
        async function fetchProducts() {
            try {
                const res = await fetch('https://tridex1.onrender.com/products');
                products = await res.json();
                renderProducts();
            } catch (e) {
                products = [];
                renderProducts();
                alert('Failed to load products from database.');
            }
        }
        function renderProducts() {
            const tbody = document.querySelector('#product-list tbody');
            tbody.innerHTML = '';
            (products || []).forEach(product => {
                // Get category name if available
                let categoryName = 'Uncategorized';
                if (product.category) {
                    if (typeof product.category === 'object' && product.category.name) {
                        categoryName = product.category.name;
                    } else {
                        // Try to find category by ID
                        const category = categories.find(c => c._id === product.category);
                        if (category) {
                            categoryName = category.name;
                        }
                    }
                }

                // Check if product has AI summary
                const hasSummary = product.aiSummary ? true : false;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${product.image || ''}" alt="${product.name}" style="cursor:pointer;" class="product-img" data-id="${product._id}"></td>
                    <td>${product.name}</td>
                    <td>${product.desc}</td>
                    <td>₹${product.price}</td>
                    <td>${categoryName}</td>
                    <td>
                        ${hasSummary
                            ? '<span style="color:#28a745;"><i class="fas fa-check-circle"></i> Generated</span>'
                            : '<span style="color:#dc3545;"><i class="fas fa-times-circle"></i> Missing</span>'}
                    </td>
                    <td>
                        <button class="edit-btn" data-id="${product._id}">Edit</button>
                        <button class="delete-btn" data-id="${product._id}">Delete</button>
                    </td>
                `;
                tr.querySelector('.product-img').onclick = function() {
                    window.location.href = `product-details.html?id=${product._id}`;
                };
                tr.querySelector('.edit-btn').onclick = function() {
                    setProductForm(product);
                };
                tr.querySelector('.delete-btn').onclick = async function() {
                    if (confirm('Delete this product?')) {
                        try {
                            await fetch(`https://tridex1.onrender.com/products/${product._id}`, { method: 'DELETE' });
                            fetchProducts();
                        } catch (e) { alert('Failed to delete product.'); }
                    }
                };
                tbody.appendChild(tr);
            });
        }
        // Set form fields for editing, including image preview
        function setProductForm(product) {
            document.getElementById('product-id').value = product._id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-image').value = product.image;
            document.getElementById('product-desc').value = product.desc;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-save-btn').textContent = 'Update Product';
            document.getElementById('product-cancel-btn').style.display = '';
            document.getElementById('regenerate-summary-btn').style.display = '';
            if (product.image) {
                document.getElementById('product-image-preview').src = product.image;
                document.getElementById('product-image-preview').style.display = '';
            } else {
                document.getElementById('product-image-preview').style.display = 'none';
            }
            document.getElementById('product-image-file').value = '';

            // Set category if it exists
            if (product.category) {
                document.getElementById('product-category').value =
                    typeof product.category === 'object' ? product.category._id : product.category;
            } else {
                document.getElementById('product-category').value = '';
            }

            // Set media items if they exist
            if (mediaGallery) {
                if (product.media && product.media.length > 0) {
                    // Use the media array from the product
                    mediaGallery.setMediaItems(product.media);
                } else if (product.image) {
                    // Create a media item from the legacy image field
                    mediaGallery.setMediaItems([{
                        type: 'image',
                        url: product.image,
                        isPrimary: true,
                        order: 0,
                        altText: product.name || '',
                        caption: ''
                    }]);
                } else {
                    // No media
                    mediaGallery.setMediaItems([]);
                }
            }

            // Set the parent product ID for the color variant manager
            if (colorVariantManager) {
                colorVariantManager.setParentProductId(product._id);
            }
        }
        // Handle image file upload and processing
        const productImageFileInput = document.getElementById('product-image-file');
        if (productImageFileInput) {
            productImageFileInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                // Check file size (limit to 10MB for Cloudinary's free tier)
                if (file.size > 10 * 1024 * 1024) {
                    alert('Image size exceeds 10MB, which is Cloudinary\'s limit. Please choose a smaller image.');
                    this.value = ''; // Clear the file input
                    return;
                }

                // Show loading indicator
                showLoading();

                // Show upload status message
                const statusDiv = document.createElement('div');
                statusDiv.id = 'upload-status';
                statusDiv.style.cssText = 'margin-top:10px; font-size:0.9em; color:#007bff;';
                statusDiv.textContent = 'Uploading to Cloudinary... Please wait.';

                const previewContainer = document.getElementById('product-image-preview').parentNode;
                if (document.getElementById('upload-status')) {
                    document.getElementById('upload-status').remove();
                }
                previewContainer.appendChild(statusDiv);

                try {
                    // Upload the image to Cloudinary
                    const imageUrl = await uploadToCloudinary(file);

                    // Update status
                    if (document.getElementById('upload-status')) {
                        document.getElementById('upload-status').textContent = 'Upload complete!';
                        document.getElementById('upload-status').style.color = '#28a745';
                    }

                    // Set the image URL to the hidden input
                    document.getElementById('product-image').value = imageUrl;

                    // Show preview
                    document.getElementById('product-image-preview').src = imageUrl;
                    document.getElementById('product-image-preview').style.display = '';

                    // Check if it's a Cloudinary URL
                    if (imageUrl.includes('cloudinary.com')) {
                        console.log('Successfully uploaded to Cloudinary:', imageUrl);

                        // Add Cloudinary indicator next to preview
                        const cloudinaryIndicator = document.createElement('span');
                        cloudinaryIndicator.textContent = ' (Cloudinary)';
                        cloudinaryIndicator.style.fontSize = '0.9em';
                        cloudinaryIndicator.style.color = '#28a745'; // Green for Cloudinary
                        cloudinaryIndicator.style.fontWeight = 'bold';

                        const previewImg = document.getElementById('product-image-preview');
                        if (previewImg.nextSibling && previewImg.nextSibling.tagName === 'SPAN') {
                            previewImg.parentNode.removeChild(previewImg.nextSibling);
                        }
                        previewImg.parentNode.insertBefore(cloudinaryIndicator, previewImg.nextSibling);
                    } else {
                        // It's a base64 string (fallback)
                        console.log('Using base64 image (Cloudinary upload failed)');

                        // Add fallback indicator next to preview
                        const fallbackIndicator = document.createElement('span');
                        fallbackIndicator.textContent = ' (Local Storage)';
                        fallbackIndicator.style.fontSize = '0.9em';
                        fallbackIndicator.style.color = '#ffc107'; // Yellow for fallback
                        fallbackIndicator.style.fontWeight = 'bold';

                        const previewImg = document.getElementById('product-image-preview');
                        if (previewImg.nextSibling && previewImg.nextSibling.tagName === 'SPAN') {
                            previewImg.parentNode.removeChild(previewImg.nextSibling);
                        }
                        previewImg.parentNode.insertBefore(fallbackIndicator, previewImg.nextSibling);
                    }

                } catch (error) {
                    console.error('Image upload failed:', error);

                    // Update status
                    if (document.getElementById('upload-status')) {
                        document.getElementById('upload-status').textContent = 'Upload failed: ' + error.message;
                        document.getElementById('upload-status').style.color = '#dc3545';
                    }

                    alert('Failed to upload image. Please try again with a different image.');
                    this.value = ''; // Clear the file input
                } finally {
                    hideLoading();

                    // Remove status after 5 seconds
                    setTimeout(() => {
                        if (document.getElementById('upload-status')) {
                            document.getElementById('upload-status').remove();
                        }
                    }, 5000);
                }
            }
        });
        }

        // Function to upload image to Cloudinary using unsigned upload preset
        async function uploadToCloudinary(file, folderName = 'product_images') {
            try {
                // Log file details
                console.log('Uploading image to Cloudinary:', file.name, 'Size:', Math.round(file.size/1024) + 'KB');

                // Create a FormData object to send the file
                const formData = new FormData();
                formData.append('file', file);

                // Use the unsigned upload preset you created in Cloudinary dashboard
                formData.append('upload_preset', 'tridex_products'); // Exact match with the preset name in Cloudinary dashboard

                // Note: The upload preset name is case-sensitive
                // If 'tridex_products' doesn't work, try 'Tridex_products' or check the exact name in your Cloudinary dashboard

                // Use a specific folder to make it easier to find uploads (this is optional if you set folder in preset)
                formData.append('folder', folderName);

                // Add a unique public_id to avoid conflicts
                const uniqueId = 'product_' + Date.now();
                formData.append('public_id', uniqueId);

                // Show upload progress in console
                console.log('Starting Cloudinary upload...');

                // Create a status notification
                const statusNotification = document.createElement('div');
                statusNotification.id = 'upload-status-notification';
                statusNotification.style.cssText = 'position:fixed; bottom:20px; left:20px; background:#007bff; color:#fff; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                statusNotification.innerHTML = `
                    <strong>Uploading to Cloudinary...</strong><br>
                    Please wait while your image is being uploaded.
                `;
                document.body.appendChild(statusNotification);

                try {
                    // Upload to Cloudinary with longer timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                    // Get Cloudinary configuration from server environment
                    const cloudinaryConfig = await getCloudinaryConfig();

                    // Check if we have a valid cloud name
                    if (!cloudinaryConfig.cloudName || cloudinaryConfig.cloudName === 'your_cloud_name') {
                        console.error('Invalid Cloudinary cloud name');

                        // Remove the status notification
                        if (document.getElementById('upload-status-notification')) {
                            document.getElementById('upload-status-notification').remove();
                        }

                        // Fall back to base64
                        console.log('Falling back to base64 encoding due to invalid cloud name...');
                        return await fallbackToBase64(file);
                    }

                    // Add API key to the form data for authentication if available
                    if (cloudinaryConfig.apiKey && cloudinaryConfig.apiKey !== 'missing_api_key') {
                        formData.append('api_key', cloudinaryConfig.apiKey);
                        console.log('Using API key from server for authentication');
                    } else {
                        console.log('No API key available, attempting unsigned upload');

                        // Show a warning about missing API key
                        const warningDiv = document.createElement('div');
                        warningDiv.style.cssText = 'position:fixed; top:20px; left:20px; background:#fff3cd; color:#856404; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                        warningDiv.innerHTML = `
                            <h3 style="margin-top:0;">Cloudinary API Key Missing</h3>
                            <p>Attempting unsigned upload, but this may fail.</p>
                            <p>Check your server's .env file and make sure CLOUDINARY_API_KEY is set correctly.</p>
                            <button onclick="this.parentNode.remove()" style="padding:5px 10px; background:#856404; color:white; border:none; border-radius:3px; cursor:pointer;">Close</button>
                        `;
                        document.body.appendChild(warningDiv);

                        // Set a timeout to remove the warning after 10 seconds
                        setTimeout(() => {
                            if (document.body.contains(warningDiv)) {
                                document.body.removeChild(warningDiv);
                            }
                        }, 10000);
                    }

                    // Try to upload to Cloudinary
                    console.log(`Uploading to Cloudinary cloud: ${cloudinaryConfig.cloudName}`);
                    const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                        method: 'POST',
                        body: formData,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId); // Clear the timeout

                    // Remove the status notification
                    if (document.getElementById('upload-status-notification')) {
                        document.getElementById('upload-status-notification').remove();
                    }

                    // Check for errors
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Cloudinary error response:', errorText);

                        // Show error details
                        const errorDetails = document.createElement('div');
                        errorDetails.style.cssText = 'position:fixed; bottom:20px; right:20px; background:#f8d7da; color:#721c24; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                        errorDetails.innerHTML = `
                            <h3 style="margin-top:0;">Cloudinary Upload Failed</h3>
                            <p>Error: ${errorText}</p>
                            <p>Falling back to base64 encoding...</p>
                            <button onclick="this.parentNode.remove()" style="padding:5px 10px; background:#721c24; color:white; border:none; border-radius:3px; cursor:pointer;">Close</button>
                        `;
                        document.body.appendChild(errorDetails);

                        // Set a timeout to remove the error after 10 seconds
                        setTimeout(() => {
                            if (document.body.contains(errorDetails)) {
                                document.body.removeChild(errorDetails);
                            }
                        }, 10000);

                        // Fall back to base64 if Cloudinary upload fails
                        console.log('Falling back to base64 encoding...');
                        return await fallbackToBase64(file);
                    }

                    // Parse the response
                    const data = await response.json();
                    console.log('Cloudinary upload successful!', data);

                    // Log detailed information about the upload
                    console.log('Cloudinary upload details:');
                    console.log('- Public ID:', data.public_id);
                    console.log('- Format:', data.format);
                    console.log('- URL:', data.url);
                    console.log('- Secure URL:', data.secure_url);
                    console.log('- Original Filename:', data.original_filename);

                    // Create a success notification
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position:fixed; bottom:20px; left:20px; background:#28a745; color:#fff; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                    notification.innerHTML = `
                        <strong>Cloudinary Upload Success!</strong><br>
                        Image uploaded to Cloudinary.<br>
                        <small>Check the "product_images" folder in your Media Library</small>
                    `;
                    document.body.appendChild(notification);

                    // Remove notification after 5 seconds
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        notification.style.transition = 'opacity 0.5s ease';
                        setTimeout(() => notification.remove(), 500);
                    }, 5000);

                    // Return the secure URL of the uploaded image
                    return data.secure_url;
                } catch (fetchError) {
                    console.error('Error during Cloudinary upload:', fetchError);

                    // Remove the status notification
                    if (document.getElementById('upload-status-notification')) {
                        document.getElementById('upload-status-notification').remove();
                    }

                    // Fall back to base64 if Cloudinary upload fails
                    console.log('Falling back to base64 encoding...');
                    return await fallbackToBase64(file);
                }
            } catch (error) {
                console.error('Error in uploadToCloudinary:', error);

                // Fall back to base64 if anything fails
                return await fallbackToBase64(file);
            }
        }

        // Helper function for base64 fallback
        async function fallbackToBase64(file) {
            try {
                // First, let's optimize the image to reduce size
                let processedFile = file;

                // If the file is large, compress it
                if (file.size > 1024 * 1024) { // If larger than 1MB
                    try {
                        // Compress the image
                        processedFile = await compressImage(file, 1200, 0.9);
                        console.log('Image compressed to size:', Math.round(processedFile.size/1024) + 'KB');
                    } catch (compressionError) {
                        console.warn('Image compression failed, using original file:', compressionError);
                        processedFile = file;
                    }
                }

                // Convert to base64
                const base64String = await fileToBase64(processedFile);
                console.log('Image converted to base64, size:', Math.round(base64String.length/1024) + 'KB');

                // Create a notification about the fallback
                const notification = document.createElement('div');
                notification.style.cssText = 'position:fixed; bottom:20px; left:20px; background:#ffc107; color:#000; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                notification.innerHTML = `
                    <strong>Cloudinary Upload Failed</strong><br>
                    Falling back to base64 storage in database.<br>
                    <small>Check console for details.</small>
                `;
                document.body.appendChild(notification);

                // Remove notification after 5 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => notification.remove(), 500);
                }, 5000);

                return base64String;
            } catch (error) {
                console.error('Error in fallbackToBase64:', error);
                throw error;
            }
        }

        // Helper function to load an image and get its dimensions
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        resolve(img);
                    };
                    img.onerror = function(error) {
                        reject(error);
                    };
                };
                reader.onerror = function(error) {
                    reject(error);
                };
            });
        }

        // Helper function to compress and resize an image with better quality preservation
        function compressImage(file, maxDimension, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        // Calculate new dimensions while preserving aspect ratio
                        let width = img.width;
                        let height = img.height;

                        // Determine which dimension to constrain
                        if (width > height) {
                            // Landscape image
                            if (width > maxDimension) {
                                height = Math.round(height * maxDimension / width);
                                width = maxDimension;
                            }
                        } else {
                            // Portrait or square image
                            if (height > maxDimension) {
                                width = Math.round(width * maxDimension / height);
                                height = maxDimension;
                            }
                        }

                        console.log('Resizing to:', width + 'x' + height, 'with quality:', quality);

                        // Create canvas for resizing
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;

                        // Draw and compress image on canvas with better quality
                        const ctx = canvas.getContext('2d');
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to blob with compression
                        canvas.toBlob(function(blob) {
                            resolve(blob);
                        }, 'image/jpeg', quality); // Always use JPEG for better compression
                    };
                    img.onerror = function(error) {
                        reject(error);
                    };
                };
                reader.onerror = function(error) {
                    reject(error);
                };
            });
        }

        // Helper function to convert a file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Add/Edit Product (DB version)
        document.getElementById('product-form').onsubmit = async function(e) {
            e.preventDefault();

            // Show loading indicator
            showLoading();

            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value.trim();
            let image = document.getElementById('product-image').value.trim();
            const desc = document.getElementById('product-desc').value.trim();
            const price = document.getElementById('product-price').value.trim();

            // Validate inputs
            if (!name) {
                alert('Product name is required');
                hideLoading();
                return;
            }

            if (!price || isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                hideLoading();
                return;
            }

            // Log image information
            if (image) {
                if (image.includes('cloudinary.com')) {
                    console.log('Submitting product with Cloudinary URL:', image);
                } else {
                    // It's a base64 string
                    const sizeKB = Math.round(image.length/1024);
                    console.log('Submitting product with base64 image, size:', sizeKB + 'KB');
                }
            }

            try {
                // Prepare the product data
                const productData = { name, desc, price };

                // Only include image if it's not empty
                if (image) {
                    productData.image = image;
                }

                if (id) {
                    // Update
                    const response = await fetch(`https://tridex1.onrender.com/products/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });

                    if (!response.ok) {
                        if (response.status === 413) {
                            throw new Error('The image is too large for the server to process. Please use a smaller image.');
                        } else {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }
                    }

                    // Log the response for debugging
                    const responseData = await response.json();
                    console.log('Product update response:', responseData);

                    alert('Product updated successfully!');
                } else {
                    // Add
                    const response = await fetch('https://tridex1.onrender.com/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });

                    if (!response.ok) {
                        if (response.status === 413) {
                            throw new Error('The image is too large for the server to process. Please use a smaller image.');
                        } else {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }
                    }

                    // Log the response for debugging
                    const responseData = await response.json();
                    console.log('Product add response:', responseData);

                    alert('Product added successfully!');
                }

                // Reset form
                this.reset();
                document.getElementById('product-save-btn').textContent = 'Add Product';
                document.getElementById('product-cancel-btn').style.display = 'none';
                document.getElementById('product-image-preview').style.display = 'none';
                document.getElementById('product-image').value = '';

                // Refresh product list
                fetchProducts();
            } catch (e) {
                console.error('Product operation failed:', e);
                alert(`Failed to ${id ? 'update' : 'add'} product: ${e.message}`);
            } finally {
                hideLoading();
            }
        };
        // Cancel edit
        document.getElementById('product-cancel-btn').onclick = function() {
            document.getElementById('product-form').reset();
            document.getElementById('product-save-btn').textContent = 'Add Product';
            this.style.display = 'none';
            document.getElementById('regenerate-summary-btn').style.display = 'none';
            document.getElementById('product-image-preview').style.display = 'none';
            document.getElementById('product-image').value = '';

            // Reset media gallery
            if (mediaGallery) {
                mediaGallery.setMediaItems([]);
            }

            // Reset color variant manager
            if (colorVariantManager) {
                colorVariantManager.setParentProductId(null);
            }
        };

        // Regenerate AI summary for a single product
        document.getElementById('regenerate-summary-btn').onclick = async function() {
            const productId = document.getElementById('product-id').value;
            if (!productId) {
                alert('Please select a product first');
                return;
            }

            try {
                showLoading();
                const response = await fetch(`https://tridex1.onrender.com/products/${productId}/regenerate-summary`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                await tridexSuccess(`AI summary has been regenerated for "${data.product.name}".`, 'AI Summary Updated');

                // Refresh product list
                fetchProducts();
            } catch (error) {
                console.error('Error regenerating AI summary:', error);
                await tridexError(`Failed to regenerate AI summary: ${error.message}`, 'AI Summary Failed');
            } finally {
                hideLoading();
            }
        };

        // Regenerate AI summaries for all products
        document.getElementById('regenerate-all-summaries-btn').onclick = async function() {
            if (!confirm('This will regenerate AI summaries for all products. Continue?')) {
                return;
            }

            try {
                showLoading();
                document.getElementById('regenerate-status').textContent = 'Regenerating summaries...';

                const response = await fetch('https://tridex1.onrender.com/products/regenerate-all-summaries', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                document.getElementById('regenerate-status').textContent =
                    `${data.updatedProducts} of ${data.totalProducts} summaries regenerated successfully`;

                // Refresh product list
                fetchProducts();
            } catch (error) {
                console.error('Error regenerating all AI summaries:', error);
                document.getElementById('regenerate-status').textContent =
                    `Error: ${error.message}`;
            } finally {
                hideLoading();
            }
        };

        // --- Announcement Management (DB version) ---
        async function fetchAnnouncements() {
            try {
                const res = await fetch('https://tridex1.onrender.com/announcements');
                announcements = await res.json();
                renderAdminMessages();
            } catch (e) {
                announcements = [];
                renderAdminMessages();
                alert('Failed to load announcements from database.');
            }
        }
        document.getElementById('admin-mail-form').onsubmit = async function(e) {
            e.preventDefault();

            // Show loading indicator
            showLoading();

            const title = document.getElementById('mail-title').value.trim();
            const message = document.getElementById('mail-body').value.trim();

            // Validate inputs
            if (!title) {
                alert('Announcement title is required');
                hideLoading();
                return;
            }

            if (!message) {
                alert('Announcement message is required');
                hideLoading();
                return;
            }

            try {
                const response = await fetch('https://tridex1.onrender.com/announcements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, message })
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                await tridexSuccess('Announcement has been sent successfully to all users!', 'Announcement Sent');
                document.getElementById('admin-mail-modal').style.display = 'none';
                this.reset();
                fetchAnnouncements();
            } catch (e) {
                console.error('Failed to send announcement:', e);
                await tridexError(`Failed to send announcement: ${e.message}`, 'Send Failed');
            } finally {
                hideLoading();
            }
        };
        function renderAdminMessages() {
            const messagesDiv = document.getElementById('admin-mailbox-messages');
            if (!announcements || announcements.length === 0) {
                messagesDiv.innerHTML = '<p style="color:#888;">No messages.</p>';
            } else {
                messagesDiv.innerHTML = announcements.map((msg, idx) =>
                    `<div style="border-bottom:1px solid #eee; padding:8px 0;">
                        <strong>${msg.title || 'Announcement'}</strong>
                        <div style="font-size:0.97em; margin-top:4px;">${msg.message}</div>
                        <div style="font-size:0.85em; color:#888; margin-top:2px;">${new Date(msg.createdAt).toLocaleString() || ''}</div>
                        <button class="delete-msg-btn" data-id="${msg._id}" style="margin-top:6px; padding:4px 12px; background:#dc3545; color:#fff; border:none; border-radius:4px; font-size:0.95em; cursor:pointer;">Delete</button>
                    </div>`
                ).join('');
                // Add delete handlers
                messagesDiv.querySelectorAll('.delete-msg-btn').forEach(btn => {
                    btn.onclick = async function() {
                        const id = this.getAttribute('data-id');
                        const confirmed = await tridexConfirm(
                            'Are you sure you want to delete this announcement? This action cannot be undone.',
                            'Delete Announcement'
                        );
                        if (confirmed) {
                            // Show loading indicator
                            showLoading();

                            try {
                                const response = await fetch(`https://tridex1.onrender.com/announcements/${id}`, { method: 'DELETE' });

                                if (!response.ok) {
                                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                                }

                                await tridexSuccess('Announcement deleted successfully.', 'Deleted');
                                fetchAnnouncements();
                            } catch (e) {
                                console.error('Failed to delete announcement:', e);
                                await tridexError(`Failed to delete announcement: ${e.message}`, 'Delete Failed');
                            } finally {
                                hideLoading();
                            }
                        }
                    };
                });
            }
        }
        // Show mailbox modal and fetch announcements
        document.getElementById('show-mail-btn').onclick = function() {
            document.getElementById('admin-mail-modal').style.display = 'flex';
            fetchAnnouncements();
        };
        document.getElementById('close-admin-mail').onclick = function() {
            document.getElementById('admin-mail-modal').style.display = 'none';
        };

        // ========== CONTACT MESSAGES FUNCTIONALITY ==========

        let contactMessages = [];
        let contactPage = 1;
        let contactLimit = 20;
        let contactTotal = 0;
        let contactPages = 1;
        let contactStatus = '';
        let contactSearch = '';

        // Fetch contact messages from the server
        async function fetchContactMessages() {
            try {
                // Show loading indicator
                showLoading();

                // Build query parameters
                const params = new URLSearchParams();
                params.append('page', contactPage);
                params.append('limit', contactLimit);

                if (contactStatus) {
                    params.append('status', contactStatus);
                }

                if (contactSearch) {
                    params.append('search', contactSearch);
                }

                // Fetch contact messages
                const response = await fetch(`https://tridex1.onrender.com/contact/messages?${params.toString()}`);

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Update contact messages and pagination info
                contactMessages = data.messages;
                contactTotal = data.pagination.total;
                contactPages = data.pagination.pages;

                // Render contact messages
                renderContactMessages();

                // Update pagination info
                updateContactPagination();
            } catch (error) {
                console.error('Error fetching contact messages:', error);
                alert('Failed to load contact messages. Please try again later.');
            } finally {
                // Hide loading indicator
                hideLoading();
            }
        }

        // Render contact messages
        function renderContactMessages() {
            const tbody = document.querySelector('#contact-table tbody');
            tbody.innerHTML = '';

            if (contactMessages.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" style="text-align:center;">No contact messages found</td>';
                tbody.appendChild(tr);
                return;
            }

            contactMessages.forEach(message => {
                const tr = document.createElement('tr');

                // Format date
                const date = new Date(message.createdAt);
                const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

                // Determine status color
                let statusColor = '#777';
                if (message.status === 'New') {
                    statusColor = '#dc3545';
                } else if (message.status === 'In Progress') {
                    statusColor = '#007bff';
                } else if (message.status === 'Resolved') {
                    statusColor = '#28a745';
                }

                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${message.fullName}</td>
                    <td>${message.email}</td>
                    <td>${message.subject}</td>
                    <td><span style="color:${statusColor}; font-weight:bold;">${message.status}</span></td>
                    <td>
                        <button class="view-contact-btn" style="background:#007bff; color:white; border:none; border-radius:4px; padding:5px 14px; cursor:pointer; margin-right:6px;">View</button>
                        <select class="status-select" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
                            <option value="New" ${message.status === 'New' ? 'selected' : ''}>New</option>
                            <option value="In Progress" ${message.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Resolved" ${message.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                            <option value="Closed" ${message.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        </select>
                    </td>
                `;

                // Add event listener to view button
                tr.querySelector('.view-contact-btn').addEventListener('click', () => {
                    showContactDetail(message);
                });

                // Add event listener to status select
                tr.querySelector('.status-select').addEventListener('change', async (e) => {
                    const newStatus = e.target.value;

                    try {
                        // Show loading indicator
                        showLoading();

                        // Update status on server
                        const response = await fetch(`https://tridex1.onrender.com/contact/messages/${message._id}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: newStatus })
                        });

                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }

                        // Update status in UI
                        message.status = newStatus;

                        // Update status color
                        let statusColor = '#777';
                        if (newStatus === 'New') {
                            statusColor = '#dc3545';
                        } else if (newStatus === 'In Progress') {
                            statusColor = '#007bff';
                        } else if (newStatus === 'Resolved') {
                            statusColor = '#28a745';
                        }

                        tr.querySelector('td:nth-child(5) span').style.color = statusColor;
                        tr.querySelector('td:nth-child(5) span').textContent = newStatus;

                        // Show success message
                        alert(`Status updated to ${newStatus}`);
                    } catch (error) {
                        console.error('Error updating status:', error);
                        alert('Failed to update status. Please try again later.');

                        // Reset select to original value
                        e.target.value = message.status;
                    } finally {
                        // Hide loading indicator
                        hideLoading();
                    }
                });

                tbody.appendChild(tr);
            });
        }

        // Update contact pagination info
        function updateContactPagination() {
            const start = (contactPage - 1) * contactLimit + 1;
            const end = Math.min(contactPage * contactLimit, contactTotal);

            document.getElementById('contact-pagination-info').textContent = `Showing ${start}-${end} of ${contactTotal}`;

            // Enable/disable pagination buttons
            document.getElementById('contact-prev-page').disabled = contactPage === 1;
            document.getElementById('contact-next-page').disabled = contactPage === contactPages;

            // Update button styles
            document.getElementById('contact-prev-page').style.opacity = contactPage === 1 ? '0.5' : '1';
            document.getElementById('contact-next-page').style.opacity = contactPage === contactPages ? '0.5' : '1';
        }

        // Show contact message details
        function showContactDetail(message) {
            // Set contact ID for response form
            document.getElementById('contact-id').value = message._id;

            // Format date
            const date = new Date(message.createdAt);
            const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

            // Format updated date if available
            let updatedDate = '';
            if (message.updatedAt && message.updatedAt !== message.createdAt) {
                const updated = new Date(message.updatedAt);
                updatedDate = `<p><strong>Last Updated:</strong> ${updated.toLocaleDateString()} ${updated.toLocaleTimeString()}</p>`;
            }

            // Format admin response if available
            let adminResponse = '';
            if (message.adminResponse && message.adminResponse.text) {
                const responseDate = new Date(message.adminResponse.respondedAt);
                adminResponse = `
                    <div style="background:#f8f9fa; padding:15px; border-radius:5px; margin-top:20px; border-left:4px solid #28a745;">
                        <h4 style="margin-top:0;">Response from ${message.adminResponse.respondedBy}</h4>
                        <p>${message.adminResponse.text}</p>
                        <p style="color:#666; font-size:0.9em; margin-bottom:0;">
                            Sent on ${responseDate.toLocaleDateString()} ${responseDate.toLocaleTimeString()}
                        </p>
                    </div>
                `;
            }

            // Format attachment if available
            let attachment = '';
            if (message.attachment && message.attachment.filename) {
                attachment = `
                    <p><strong>Attachment:</strong> ${message.attachment.filename}</p>
                    <p><a href="#" onclick="downloadAttachment('${message._id}'); return false;" style="color:#007bff;">Download Attachment</a></p>
                `;
            }

            // Populate contact detail content
            document.getElementById('contact-detail-content').innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <p><strong>From:</strong> ${message.fullName} ${message.username ? `(${message.username})` : ''}</p>
                        <p><strong>Email:</strong> <a href="mailto:${message.email}" style="color:#007bff;">${message.email}</a></p>
                        ${message.phone ? `<p><strong>Phone:</strong> ${message.phone}</p>` : ''}
                        <p><strong>Subject:</strong> ${message.subject}</p>
                        <p><strong>Date:</strong> ${formattedDate}</p>
                        ${updatedDate}
                        <p><strong>Status:</strong> <span style="font-weight:bold;">${message.status}</span></p>
                    </div>
                    <div>
                        <select id="detail-status-select" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
                            <option value="New" ${message.status === 'New' ? 'selected' : ''}>New</option>
                            <option value="In Progress" ${message.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Resolved" ${message.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                            <option value="Closed" ${message.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        </select>
                        <button id="update-status-btn" style="padding:8px 15px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; margin-left:10px;">Update Status</button>
                    </div>
                </div>
                <hr>
                <h3>Message</h3>
                <div style="background:#f8f9fa; padding:15px; border-radius:5px; white-space:pre-wrap;">${message.message}</div>
                ${attachment}
                ${adminResponse}
            `;

            // Add event listener to update status button
            document.getElementById('update-status-btn').addEventListener('click', async () => {
                const newStatus = document.getElementById('detail-status-select').value;

                try {
                    // Show loading indicator
                    showLoading();

                    // Update status on server
                    const response = await fetch(`https://tridex1.onrender.com/contact/messages/${message._id}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }

                    // Update status in UI
                    message.status = newStatus;

                    // Show success message
                    alert(`Status updated to ${newStatus}`);

                    // Refresh contact messages
                    fetchContactMessages();
                } catch (error) {
                    console.error('Error updating status:', error);
                    alert('Failed to update status. Please try again later.');

                    // Reset select to original value
                    document.getElementById('detail-status-select').value = message.status;
                } finally {
                    // Hide loading indicator
                    hideLoading();
                }
            });

            // Show contact detail modal
            document.getElementById('contact-detail-modal').style.display = 'flex';
        }

        // Download attachment
        window.downloadAttachment = async function(messageId) {
            try {
                // Show loading indicator
                showLoading();

                // Fetch attachment from server
                const response = await fetch(`https://tridex1.onrender.com/contact/messages/${messageId}/attachment`);

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                // Get attachment data
                const blob = await response.blob();

                // Get filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'attachment';

                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }

                // Create download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();

                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (error) {
                console.error('Error downloading attachment:', error);
                alert('Failed to download attachment. Please try again later.');
            } finally {
                // Hide loading indicator
                hideLoading();
            }
        };

        // Handle contact response form submission
        document.getElementById('contact-response-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const contactId = document.getElementById('contact-id').value;
            const responseText = document.getElementById('contact-response').value.trim();

            if (!responseText) {
                alert('Please enter a response message');
                return;
            }

            try {
                // Show loading indicator
                showLoading();

                // Send response to server
                const response = await fetch(`https://tridex1.onrender.com/contact/messages/${contactId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: responseText,
                        respondedBy: localStorage.getItem('username') || 'Admin'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                // Show success message
                alert('Response sent successfully');

                // Close modal
                document.getElementById('contact-detail-modal').style.display = 'none';

                // Clear form
                document.getElementById('contact-response').value = '';

                // Refresh contact messages
                fetchContactMessages();
            } catch (error) {
                console.error('Error sending response:', error);
                alert('Failed to send response. Please try again later.');
            } finally {
                // Hide loading indicator
                hideLoading();
            }
        });

        // Close contact detail modal
        document.getElementById('close-contact-detail').addEventListener('click', function() {
            document.getElementById('contact-detail-modal').style.display = 'none';
        });

        // Handle contact search
        document.getElementById('contact-search-btn').addEventListener('click', function() {
            contactSearch = document.getElementById('contact-search').value.trim();
            contactPage = 1; // Reset to first page
            fetchContactMessages();
        });

        // Handle contact status filter
        document.getElementById('contact-status-filter').addEventListener('change', function() {
            contactStatus = this.value;
            contactPage = 1; // Reset to first page
            fetchContactMessages();
        });

        // Handle contact pagination
        document.getElementById('contact-prev-page').addEventListener('click', function() {
            if (contactPage > 1) {
                contactPage--;
                fetchContactMessages();
            }
        });

        document.getElementById('contact-next-page').addEventListener('click', function() {
            if (contactPage < contactPages) {
                contactPage++;
                fetchContactMessages();
            }
        });

        // Show contact section
        document.getElementById('show-contact-btn').addEventListener('click', function() {
            // Hide all sections
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('product-section').style.display = 'none';
            document.getElementById('category-section').style.display = 'none';
            document.getElementById('orders-section').style.display = 'none';
            document.getElementById('analytics-section').style.display = 'none';
            document.getElementById('contact-section').style.display = 'block';

            // Update active button
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // Fetch contact messages
            fetchContactMessages();
        });

        // --- Navigation between sections ---
        document.getElementById('show-users-btn').onclick = function() {
            document.getElementById('user-section').style.display = '';
            document.getElementById('product-section').style.display = 'none';
            document.getElementById('category-section').style.display = 'none';
            document.getElementById('orders-section').style.display = 'none';
            document.getElementById('analytics-section').style.display = 'none';
            document.getElementById('contact-section').style.display = 'none';
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
        };
        document.getElementById('show-products-btn').onclick = function() {
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('product-section').style.display = '';
            document.getElementById('category-section').style.display = 'none';
            document.getElementById('orders-section').style.display = 'none';
            document.getElementById('analytics-section').style.display = 'none';
            document.getElementById('contact-section').style.display = 'none';
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
        };
        document.getElementById('show-categories-btn').onclick = function() {
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('product-section').style.display = 'none';
            document.getElementById('category-section').style.display = '';
            document.getElementById('orders-section').style.display = 'none';
            document.getElementById('analytics-section').style.display = 'none';
            document.getElementById('contact-section').style.display = 'none';
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
        };

        // Reviews button - redirect to admin-reviews.html
        document.getElementById('show-reviews-btn').onclick = function() {
            window.location.href = 'admin-reviews.html';
        };

        // Coupons button - redirect to admin-coupons.html
        document.getElementById('show-coupons-btn').onclick = function() {
            window.location.href = 'admin-coupons.html';
        };

        // Flash Sales button - redirect to admin-flash-sales.html
        document.getElementById('show-flash-sales-btn').onclick = function() {
            window.location.href = 'admin-flash-sales.html';
        };

        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        window.addEventListener('load', function() {
            hideLoading();
        });
        window.addEventListener('beforeunload', function() {
            showLoading();
        });

        // Debug ban system button
        document.getElementById('debug-ban-system').addEventListener('click', function() {
            if (window.banSystem) {
                const bannedUsers = window.banSystem.debugBanSystem();
                document.getElementById('debug-output').textContent =
                    bannedUsers.length > 0 ?
                    `Banned users: ${bannedUsers.join(', ')}` :
                    'No banned users found';
            } else {
                document.getElementById('debug-output').textContent = 'Ban system not available';
            }
        });

        // Force check ban status button
        document.getElementById('force-check-ban-status').addEventListener('click', async function() {
            if (window.banSystem && typeof window.banSystem.forceCheckBanStatus === 'function') {
                document.getElementById('debug-output').textContent = 'Checking ban status for all users...';

                try {
                    // Get all users
                    const usernames = users.map(user => user.username);

                    // Check ban status for each user
                    for (const username of usernames) {
                        if (username) {
                            const isBanned = await window.banSystem.forceCheckBanStatus(username);
                            console.log(`Force checked ban status for ${username}: ${isBanned ? 'BANNED' : 'NOT BANNED'}`);
                        }
                    }

                    // Update the debug output
                    const bannedUsers = window.banSystem.getBannedUsers();
                    document.getElementById('debug-output').textContent =
                        bannedUsers.length > 0 ?
                        `Banned users: ${bannedUsers.join(', ')}` :
                        'No banned users found';

                    // Refresh the user list to update the UI
                    fetchUsers();
                } catch (error) {
                    console.error('Error force checking ban status:', error);
                    document.getElementById('debug-output').textContent = `Error: ${error.message}`;
                }
            } else {
                document.getElementById('debug-output').textContent = 'Ban system or forceCheckBanStatus not available';
            }
        });

        // Function to check Cloudinary connection and test upload preset
        async function checkCloudinaryConnection() {
            try {
                // Update status
                const statusSpan = document.getElementById('cloudinary-status');
                if (statusSpan) {
                    statusSpan.textContent = 'Testing Cloudinary connection...';
                    statusSpan.style.color = '#007bff';
                }

                // Create a small test image (1x1 pixel transparent PNG)
                const base64Image = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';

                // Convert base64 to blob
                const response = await fetch(base64Image);
                const blob = await response.blob();
                const file = new File([blob], 'cloudinary_test.png', { type: 'image/png' });

                // Create a FormData object to send the file
                const formData = new FormData();
                formData.append('file', file);

                // Try both uppercase and lowercase preset names
                // The preset name is case-sensitive and must match exactly what's in your Cloudinary dashboard
                const presetName = 'tridex_products'; // Try lowercase first
                formData.append('upload_preset', presetName);

                formData.append('folder', 'test_uploads');
                formData.append('public_id', 'connection_test_' + Date.now());

                console.log(`Testing Cloudinary connection with upload preset "${presetName}"...`);

                // Get Cloudinary configuration from server environment
                const cloudinaryConfig = await getCloudinaryConfig();

                // Check if we have a valid cloud name
                if (!cloudinaryConfig.cloudName || cloudinaryConfig.cloudName === 'your_cloud_name') {
                    throw new Error('Invalid Cloudinary cloud name. Please check your server configuration.');
                }

                // Add API key to the form data for authentication if available
                if (cloudinaryConfig.apiKey && cloudinaryConfig.apiKey !== 'missing_api_key') {
                    formData.append('api_key', cloudinaryConfig.apiKey);
                    console.log('Using API key from server for authentication');
                } else {
                    console.log('No API key available, attempting unsigned upload');

                    // Show a warning about missing API key
                    const warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'position:fixed; top:20px; left:20px; background:#fff3cd; color:#856404; padding:15px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:400px;';
                    warningDiv.innerHTML = `
                        <h3 style="margin-top:0;">Cloudinary API Key Missing</h3>
                        <p>Attempting unsigned upload, but this may fail.</p>
                        <p>Check your server's .env file and make sure CLOUDINARY_API_KEY is set correctly.</p>
                        <button onclick="this.parentNode.remove()" style="padding:5px 10px; background:#856404; color:white; border:none; border-radius:3px; cursor:pointer;">Close</button>
                    `;
                    document.body.appendChild(warningDiv);

                    // Set a timeout to remove the warning after 10 seconds
                    setTimeout(() => {
                        if (document.body.contains(warningDiv)) {
                            document.body.removeChild(warningDiv);
                        }
                    }, 10000);
                }

                // Try the upload
                console.log(`Uploading to Cloudinary cloud: ${cloudinaryConfig.cloudName}`);
                const uploadResponse = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });

                // Check if the upload was successful
                if (uploadResponse.ok) {
                    const uploadResult = await uploadResponse.json();
                    console.log('Cloudinary test upload successful!', uploadResult);

                    // Update status
                    if (statusSpan) {
                        statusSpan.textContent = 'Connected';
                        statusSpan.style.color = '#28a745';
                    }

                    // Show success message
                    const successReport = document.createElement('div');
                    successReport.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:600px;';
                    successReport.innerHTML = `
                        <h3 style="margin-top:0; color:#28a745;">✅ Cloudinary Connection Successful</h3>
                        <p>Successfully connected to Cloudinary and uploaded a test image.</p>
                        <p><strong>Cloud Name:</strong> ${cloudinaryConfig.cloudName}</p>
                        <p><strong>Upload Preset:</strong> ${presetName}</p>
                        <p><strong>API Key Available:</strong> ${cloudinaryConfig.apiKey ? 'Yes' : 'No'}</p>
                        <p><strong>Test Image URL:</strong> <a href="${uploadResult.secure_url}" target="_blank">${uploadResult.secure_url}</a></p>
                        <img src="${uploadResult.secure_url}" style="max-width:100px; margin:10px 0; border:1px solid #ddd;">
                        <p>Your Cloudinary configuration is working correctly.</p>
                        <button class="btn btn-primary" onclick="this.parentNode.remove()">Close</button>
                    `;
                    document.body.appendChild(successReport);

                    return true;
                } else {
                    const errorText = await uploadResponse.text();
                    console.error('Cloudinary test upload failed:', errorText);

                    // Try with uppercase preset name if lowercase failed
                    if (presetName === 'tridex_products') {
                        console.log('Trying with uppercase preset name "Tridex_products"...');

                        // Create a new FormData object
                        const formData2 = new FormData();
                        formData2.append('file', file);
                        formData2.append('upload_preset', 'Tridex_products');
                        formData2.append('folder', 'test_uploads');
                        formData2.append('public_id', 'connection_test_uppercase_' + Date.now());

                        // Add API key if available
                        if (cloudinaryConfig.apiKey && cloudinaryConfig.apiKey !== 'missing_api_key') {
                            formData2.append('api_key', cloudinaryConfig.apiKey);
                        }

                        try {
                            // Try the upload with uppercase preset
                            const uploadResponse2 = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                                method: 'POST',
                                body: formData2
                            });

                            if (uploadResponse2.ok) {
                                const uploadResult2 = await uploadResponse2.json();
                                console.log('Cloudinary test upload successful with uppercase preset!', uploadResult2);

                                // Update status
                                if (statusSpan) {
                                    statusSpan.textContent = 'Connected';
                                    statusSpan.style.color = '#28a745';
                                }

                                // Show success message
                                const successReport = document.createElement('div');
                                successReport.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:600px;';
                                successReport.innerHTML = `
                                    <h3 style="margin-top:0; color:#28a745;">✅ Cloudinary Connection Successful</h3>
                                    <p>Successfully connected to Cloudinary and uploaded a test image.</p>
                                    <p><strong>Cloud Name:</strong> ${cloudinaryConfig.cloudName}</p>
                                    <p><strong>Upload Preset:</strong> Tridex_products (uppercase worked)</p>
                                    <p><strong>API Key Available:</strong> ${cloudinaryConfig.apiKey ? 'Yes' : 'No'}</p>
                                    <p><strong>Test Image URL:</strong> <a href="${uploadResult2.secure_url}" target="_blank">${uploadResult2.secure_url}</a></p>
                                    <img src="${uploadResult2.secure_url}" style="max-width:100px; margin:10px 0; border:1px solid #ddd;">
                                    <p>Your Cloudinary configuration is working correctly, but you should update your code to use "Tridex_products" (uppercase T) as the preset name.</p>
                                    <button class="btn btn-primary" onclick="this.parentNode.remove()">Close</button>
                                `;
                                document.body.appendChild(successReport);

                                return true;
                            } else {
                                // Both lowercase and uppercase failed
                                const errorText2 = await uploadResponse2.text();
                                console.error('Cloudinary test upload failed with uppercase preset:', errorText2);

                                // Continue to show error message for both attempts
                                showErrorMessage(cloudinaryConfig, errorText, errorText2);
                                return false;
                            }
                        } catch (error2) {
                            console.error('Error testing Cloudinary connection with uppercase preset:', error2);
                            showErrorMessage(cloudinaryConfig, errorText, error2.message);
                            return false;
                        }
                    } else {
                        // Show error message for the first attempt
                        showErrorMessage(cloudinaryConfig, errorText);
                        return false;
                    }
                }
            } catch (error) {
                console.error('Error testing Cloudinary connection:', error);

                // Update status
                const statusSpan = document.getElementById('cloudinary-status');
                if (statusSpan) {
                    statusSpan.textContent = 'Connection error';
                    statusSpan.style.color = '#dc3545';
                }

                // Show error message
                const errorReport = document.createElement('div');
                errorReport.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:600px;';
                errorReport.innerHTML = `
                    <h3 style="margin-top:0; color:#dc3545;">❌ Cloudinary Connection Error</h3>
                    <p>An error occurred while testing the Cloudinary connection.</p>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Possible issues:</strong></p>
                    <ul>
                        <li>Server is not providing Cloudinary configuration</li>
                        <li>Network connectivity issues</li>
                        <li>Invalid Cloudinary credentials</li>
                    </ul>

                    <p>For now, the system will fall back to base64 storage until the connection issues are resolved.</p>

                    <button class="btn btn-primary" onclick="this.parentNode.remove()" style="padding:8px 16px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; margin-top:10px;">Close</button>
                `;
                document.body.appendChild(errorReport);

                return false;
            }
        }

        // Helper function to show error message for Cloudinary connection
        function showErrorMessage(cloudinaryConfig, errorText, errorText2 = null) {
            // Update status
            const statusSpan = document.getElementById('cloudinary-status');
            if (statusSpan) {
                statusSpan.textContent = 'Connection error';
                statusSpan.style.color = '#dc3545';
            }

            // Show error message
            const errorReport = document.createElement('div');
            errorReport.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; max-width:600px; overflow-y:auto; max-height:80vh;';

            let errorContent = `
                <h3 style="margin-top:0; color:#dc3545;">❌ Cloudinary Connection Failed</h3>
                <p>Failed to connect to Cloudinary or upload a test image.</p>
                <p><strong>Cloud Name:</strong> ${cloudinaryConfig.cloudName}</p>
                <p><strong>API Key Available:</strong> ${cloudinaryConfig.apiKey ? 'Yes' : 'No'}</p>
                <p><strong>Error with lowercase preset (tridex_products):</strong> ${errorText}</p>
            `;

            if (errorText2) {
                errorContent += `<p><strong>Error with uppercase preset (Tridex_products):</strong> ${errorText2}</p>`;
            }

            errorContent += `
                <p><strong>Possible issues:</strong></p>
                <ul>
                    <li>API key is missing or invalid in your .env file</li>
                    <li>Upload preset doesn't exist in your Cloudinary account</li>
                    <li>Upload preset is not set to "unsigned"</li>
                    <li>The preset name is case-sensitive and must match exactly</li>
                    <li>Network connectivity issues</li>
                </ul>

                <p><strong>How to fix:</strong></p>
                <ol>
                    <li>Check your server's .env file and make sure CLOUDINARY_API_KEY is set correctly</li>
                    <li>Go to your Cloudinary dashboard > Settings > Upload > Upload presets</li>
                    <li>Create a new preset named "tridex_products" (or check if it exists)</li>
                    <li>Make sure the preset is set to "unsigned"</li>
                    <li>Restart your server after making changes to the .env file</li>
                </ol>

                <p>For now, the system will fall back to base64 storage until the connection issues are resolved.</p>

                <button class="btn btn-primary" onclick="this.parentNode.remove()" style="padding:8px 16px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; margin-top:10px;">Close</button>
            `;

            errorReport.innerHTML = errorContent;
            document.body.appendChild(errorReport);
        }

        // Function to verify if product images are stored in Cloudinary
        async function verifyProductImages() {
            try {
                // Show loading indicator
                showLoading();

                // Fetch all products
                const response = await fetch('https://tridex1.onrender.com/products');
                if (!response.ok) {
                    throw new Error(`Failed to fetch products: ${response.status} ${response.statusText}`);
                }

                const products = await response.json();
                console.log(`Verifying ${products.length} products for Cloudinary images...`);

                // Count Cloudinary vs base64 images
                let cloudinaryCount = 0;
                let base64Count = 0;
                let noImageCount = 0;

                // Check each product
                products.forEach(product => {
                    if (!product.image) {
                        noImageCount++;
                    } else if (product.image.includes('cloudinary.com')) {
                        cloudinaryCount++;
                    } else if (product.image.startsWith('data:image')) {
                        base64Count++;
                    } else {
                        console.log('Unknown image format for product:', product.name);
                    }
                });

                // Create a report
                const report = document.createElement('div');
                report.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; color:#333; padding:20px; border-radius:5px; box-shadow:0 5px 15px rgba(0,0,0,0.3); z-index:1001; max-width:500px;';
                report.innerHTML = `
                    <h4>Product Image Report</h4>
                    <p>Total Products: ${products.length}</p>
                    <p style="color:#28a745;"><strong>Cloudinary Images:</strong> ${cloudinaryCount}</p>
                    <p style="color:#ffc107;"><strong>Base64 Images:</strong> ${base64Count}</p>
                    <p><strong>No Images:</strong> ${noImageCount}</p>
                    <p>To see Cloudinary images in your Media Library, make sure you're logged in to the correct account.</p>
                    <button class="btn btn-primary" onclick="this.parentNode.remove()">Close</button>
                `;
                document.body.appendChild(report);

                console.log('Image verification complete:');
                console.log('- Cloudinary images:', cloudinaryCount);
                console.log('- Base64 images:', base64Count);
                console.log('- No images:', noImageCount);

            } catch (error) {
                console.error('Error verifying product images:', error);
                alert('Failed to verify product images: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Add event listeners for Cloudinary verification buttons
        document.getElementById('verify-cloudinary-btn').addEventListener('click', function() {
            checkCloudinaryConnection();
        });

        document.getElementById('verify-product-images-btn').addEventListener('click', function() {
            verifyProductImages();
        });

        // --- Category Management ---
        let categories = [];

        async function fetchCategories() {
            try {
                const res = await fetch('https://tridex1.onrender.com/categories');
                categories = await res.json();
                renderCategories();
                populateCategoryDropdown();
            } catch (e) {
                console.error('Failed to load categories:', e);
                categories = [];
                renderCategories();
                alert('Failed to load categories from database.');
            }
        }

        function renderCategories() {
            const tbody = document.querySelector('#category-list tbody');
            tbody.innerHTML = '';

            if (!categories || categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#888;">No categories found. Add your first category above.</td></tr>';
                return;
            }

            categories.forEach(category => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <img src="${category.icon || 'https://via.placeholder.com/50?text=No+Icon'}"
                             alt="${category.name}"
                             style="width:50px; height:50px; object-fit:contain; border-radius:50%; background:#f9f9f9;">
                    </td>
                    <td>${category.name}</td>
                    <td>${category.description || ''}</td>
                    <td><span class="product-count" data-id="${category._id}">Loading...</span></td>
                    <td>
                        <button class="edit-btn" data-id="${category._id}">Edit</button>
                        <button class="delete-btn" data-id="${category._id}">Delete</button>
                        <button class="view-products-btn" data-id="${category._id}">View Products</button>
                    </td>
                `;

                // Get product count for this category
                getProductCountForCategory(category._id);

                // Add event handlers
                tr.querySelector('.edit-btn').onclick = function() {
                    setCategoryForm(category);
                };

                tr.querySelector('.delete-btn').onclick = async function() {
                    if (confirm('Delete this category? This will not delete the products in this category.')) {
                        try {
                            showLoading();
                            const response = await fetch(`https://tridex1.onrender.com/categories/${category._id}`, {
                                method: 'DELETE'
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Failed to delete category');
                            }

                            fetchCategories();
                        } catch (e) {
                            alert(e.message || 'Failed to delete category.');
                        } finally {
                            hideLoading();
                        }
                    }
                };

                tr.querySelector('.view-products-btn').onclick = function() {
                    window.open(`category.html?id=${category._id}`, '_blank');
                };

                tbody.appendChild(tr);
            });
        }

        async function getProductCountForCategory(categoryId) {
            try {
                const res = await fetch(`https://tridex1.onrender.com/categories/${categoryId}/products`);
                const products = await res.json();

                // Update the count in the table
                const countSpan = document.querySelector(`.product-count[data-id="${categoryId}"]`);
                if (countSpan) {
                    countSpan.textContent = products.length;
                }
            } catch (e) {
                console.error(`Failed to get product count for category ${categoryId}:`, e);
                const countSpan = document.querySelector(`.product-count[data-id="${categoryId}"]`);
                if (countSpan) {
                    countSpan.textContent = 'Error';
                }
            }
        }

        function setCategoryForm(category) {
            document.getElementById('category-id').value = category._id;
            document.getElementById('category-name').value = category.name;
            document.getElementById('category-icon').value = category.icon || '';
            document.getElementById('category-desc').value = category.description || '';
            document.getElementById('category-save-btn').textContent = 'Update Category';
            document.getElementById('category-cancel-btn').style.display = '';

            if (category.icon) {
                document.getElementById('category-icon-preview').src = category.icon;
                document.getElementById('category-icon-preview').style.display = '';
            } else {
                document.getElementById('category-icon-preview').style.display = 'none';
            }
        }

        // Handle category icon file upload
        document.getElementById('category-icon-file').onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                showLoading();

                // Upload to Cloudinary
                const iconUrl = await uploadToCloudinary(file, 'category_icons');

                // Set the icon URL in the hidden input
                document.getElementById('category-icon').value = iconUrl;

                // Show preview
                document.getElementById('category-icon-preview').src = iconUrl;
                document.getElementById('category-icon-preview').style.display = '';
            } catch (error) {
                console.error('Error uploading category icon:', error);
                alert('Failed to upload icon: ' + error.message);
            } finally {
                hideLoading();
            }
        };

        // Add/Edit Category
        document.getElementById('category-form').onsubmit = async function(e) {
            e.preventDefault();

            showLoading();

            const id = document.getElementById('category-id').value;
            const name = document.getElementById('category-name').value.trim();
            const icon = document.getElementById('category-icon').value.trim();
            const description = document.getElementById('category-desc').value.trim();

            // Validate inputs
            if (!name) {
                alert('Category name is required');
                hideLoading();
                return;
            }

            try {
                const categoryData = { name, description };

                // Only include icon if it's not empty
                if (icon) {
                    categoryData.icon = icon;
                }

                if (id) {
                    // Update
                    const response = await fetch(`https://tridex1.onrender.com/categories/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(categoryData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Server returned ${response.status}`);
                    }

                    alert('Category updated successfully!');
                } else {
                    // Add
                    const response = await fetch('https://tridex1.onrender.com/categories', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(categoryData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Server returned ${response.status}`);
                    }

                    alert('Category added successfully!');
                }

                // Reset form
                this.reset();
                document.getElementById('category-save-btn').textContent = 'Add Category';
                document.getElementById('category-cancel-btn').style.display = 'none';
                document.getElementById('category-icon-preview').style.display = 'none';
                document.getElementById('category-icon').value = '';

                // Refresh categories
                fetchCategories();
            } catch (e) {
                console.error('Category operation failed:', e);
                alert(`Failed to ${id ? 'update' : 'add'} category: ${e.message}`);
            } finally {
                hideLoading();
            }
        };

        // Cancel category edit
        document.getElementById('category-cancel-btn').onclick = function() {
            document.getElementById('category-form').reset();
            document.getElementById('category-save-btn').textContent = 'Add Category';
            this.style.display = 'none';
            document.getElementById('category-icon-preview').style.display = 'none';
            document.getElementById('category-icon').value = '';
        };

        // Populate category dropdown in product form
        function populateCategoryDropdown() {
            const select = document.getElementById('product-category');

            // Keep the first option (-- Select Category --)
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);

            // Add categories
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category._id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }

        // We already have a renderProducts function, so we don't need to override it

        // Initialize the media gallery
        function initMediaGallery(initialMedia = []) {
            // Get Cloudinary configuration
            getCloudinaryConfig().then(cloudinaryConfig => {
                // Initialize the media gallery
                mediaGallery = new ProductMediaGallery({
                    container: document.getElementById('media-gallery-container'),
                    mediaPreviewContainer: document.getElementById('media-preview-container'),
                    mediaInput: document.getElementById('media-file-input'),
                    videoUrlInput: document.getElementById('video-url-input'),
                    addVideoBtn: document.getElementById('add-video-btn'),
                    cloudName: cloudinaryConfig.cloudName,
                    apiKey: cloudinaryConfig.apiKey,
                    initialMedia: initialMedia,
                    onMediaChange: function(mediaItems) {
                        // Update the legacy image field for backward compatibility
                        const primaryImage = mediaItems.find(item => item.isPrimary && item.type === 'image');
                        if (primaryImage) {
                            document.getElementById('product-image').value = primaryImage.url;
                            document.getElementById('product-image-preview').src = primaryImage.url;
                            document.getElementById('product-image-preview').style.display = '';
                        } else {
                            document.getElementById('product-image').value = '';
                            document.getElementById('product-image-preview').style.display = 'none';
                        }
                    }
                });
            }).catch(error => {
                console.error('Error initializing media gallery:', error);
                alert('Failed to initialize media gallery. Images will be stored as base64.');
            });
        }

        // Initialize the color variant manager
        function initColorVariantManager() {
            // Initialize the color variant manager immediately without waiting for Cloudinary config
            colorVariantManager = new ColorVariantManager({
                container: document.getElementById('color-variant-container'),
                cloudName: 'dtzhskby3', // Use fallback values for now
                apiKey: 'fallback',
                onVariantsChange: function(variants) {
                    // Variants changed
                }
            });
        }

        // Initialize the media gallery and color variant manager when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the media gallery
            initMediaGallery();

            // Initialize the color variant manager
            initColorVariantManager();
        });

        // Update product form submission to include category and media gallery
        const originalProductFormSubmit = document.getElementById('product-form').onsubmit;
        document.getElementById('product-form').onsubmit = async function(e) {
            e.preventDefault();

            // Show loading indicator
            showLoading();

            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value.trim();
            let image = document.getElementById('product-image').value.trim();
            const desc = document.getElementById('product-desc').value.trim();
            const price = document.getElementById('product-price').value.trim();
            const category = document.getElementById('product-category').value;

            // Get media items from the gallery
            let media = [];
            if (mediaGallery) {
                media = mediaGallery.getMediaItems();
            }

            // Validate inputs
            if (!name) {
                alert('Product name is required');
                hideLoading();
                return;
            }

            if (!price || isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                hideLoading();
                return;
            }

            try {
                // Prepare the product data
                const productData = { name, desc, price };

                // Only include image if it's not empty (for backward compatibility)
                if (image) {
                    productData.image = image;
                }

                // Only include category if it's not empty
                if (category) {
                    productData.category = category;
                }

                // Include media items if available
                if (media && media.length > 0) {
                    productData.media = media;
                }

                if (id) {
                    // Update
                    const response = await fetch(`https://tridex1.onrender.com/products/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });

                    if (!response.ok) {
                        if (response.status === 413) {
                            throw new Error('The image is too large for the server to process. Please use a smaller image.');
                        } else {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }
                    }

                    alert('Product updated successfully!');
                } else {
                    // Add
                    const response = await fetch('https://tridex1.onrender.com/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });

                    if (!response.ok) {
                        if (response.status === 413) {
                            throw new Error('The image is too large for the server to process. Please use a smaller image.');
                        } else {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }
                    }

                    alert('Product added successfully!');
                }

                // Reset form
                this.reset();
                document.getElementById('product-save-btn').textContent = 'Add Product';
                document.getElementById('product-cancel-btn').style.display = 'none';
                document.getElementById('product-image-preview').style.display = 'none';
                document.getElementById('product-image').value = '';

                // Reset media gallery
                if (mediaGallery) {
                    mediaGallery.setMediaItems([]);
                }

                // Reset color variant manager
                if (colorVariantManager) {
                    colorVariantManager.setParentProductId(null);
                }

                // Refresh product list
                fetchProducts();
            } catch (e) {
                console.error('Product operation failed:', e);
                alert(`Failed to ${id ? 'update' : 'add'} product: ${e.message}`);
            } finally {
                hideLoading();
            }

            return false; // Prevent default form submission
        };

        // --- Order Management ---
        let orders = [];
        let currentOrdersPage = 1;
        let totalOrdersPages = 1;
        let ordersPerPage = 20;
        let orderSortField = 'createdAt';
        let orderSortDirection = 'desc';
        let orderFilters = {
            status: '',
            customer: '',
            startDate: '',
            endDate: ''
        };

        // Fetch orders from backend
        async function fetchOrders() {
            try {
                // Show loading indicator
                showLoading();

                // Build query parameters
                const queryParams = new URLSearchParams({
                    page: currentOrdersPage,
                    limit: ordersPerPage,
                    sort: orderSortField,
                    order: orderSortDirection
                });

                // Add filters if they exist
                if (orderFilters.status) {
                    queryParams.append('status', orderFilters.status);
                }

                if (orderFilters.customer) {
                    queryParams.append('customer', orderFilters.customer);
                }

                if (orderFilters.startDate) {
                    queryParams.append('startDate', orderFilters.startDate);
                }

                if (orderFilters.endDate) {
                    queryParams.append('endDate', orderFilters.endDate);
                }

                // Fetch orders from the server
                const response = await fetch(`https://tridex1.onrender.com/orders?${queryParams.toString()}`);

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Update orders and pagination
                orders = data.orders;
                totalOrdersPages = data.pagination.pages;

                // Render orders
                renderOrders();

                // Update pagination controls
                updateOrdersPagination();
            } catch (error) {
                console.error('Error fetching orders:', error);
                document.getElementById('orders-list').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align:center; padding:20px; color:#dc3545;">
                            <i class="fas fa-exclamation-circle"></i> Error loading orders: ${error.message}
                        </td>
                    </tr>
                `;
            } finally {
                // Hide loading indicator
                hideLoading();
            }
        }

        // Render orders
        function renderOrders() {
            const tbody = document.getElementById('orders-list');

            // Clear the table
            tbody.innerHTML = '';

            // Check if there are orders
            if (!orders || orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align:center; padding:20px;">
                            No orders found matching your criteria.
                        </td>
                    </tr>
                `;
                return;
            }

            // Render each order
            orders.forEach(order => {
                // Format date
                const orderDate = new Date(order.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Format customer info
                const customerInfo = order.user.username ?
                    `${order.user.username}<br><small>${order.user.email}</small>` :
                    `${order.user.email}`;

                // Format items summary
                const itemsSummary = order.items.length === 1 ?
                    `${order.items[0].name} × ${order.items[0].quantity}` :
                    `${order.items.length} items`;

                // Format payment info
                const paymentInfo = `
                    <div>${order.payment.method.toUpperCase()}</div>
                    <div class="payment-status payment-${order.payment.status}">${order.payment.status}</div>
                `;

                // Create status badge
                const statusBadge = `<span class="status-badge status-${order.status}">${order.status}</span>`;

                // Create table row
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${orderDate}</td>
                    <td>${order._id.substring(0, 8)}...</td>
                    <td>${customerInfo}</td>
                    <td>${itemsSummary}</td>
                    <td>₹${order.totalAmount}</td>
                    <td>${paymentInfo}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="view-order-btn" data-id="${order._id}">View</button>
                        <select class="update-status-select" data-id="${order._id}">
                            <option value="">Update Status</option>
                            <option value="pending" ${order.status === 'pending' ? 'disabled' : ''}>Pending</option>
                            <option value="processing" ${order.status === 'processing' ? 'disabled' : ''}>Processing</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'disabled' : ''}>Shipped</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'disabled' : ''}>Delivered</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'disabled' : ''}>Cancelled</option>
                        </select>
                    </td>
                `;

                // Add event listeners
                tr.querySelector('.view-order-btn').addEventListener('click', () => {
                    viewOrderDetails(order._id);
                });

                tr.querySelector('.update-status-select').addEventListener('change', (e) => {
                    const newStatus = e.target.value;
                    if (newStatus) {
                        updateOrderStatus(order._id, newStatus);
                    }
                });

                tbody.appendChild(tr);
            });

            // Add CSS for status badges
            addStatusStyles();
        }

        // Add CSS styles for status badges
        function addStatusStyles() {
            // Check if styles already exist
            if (document.getElementById('order-status-styles')) {
                return;
            }

            // Create style element
            const style = document.createElement('style');
            style.id = 'order-status-styles';
            style.textContent = `
                .status-badge {
                    display: inline-block;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 0.85em;
                    font-weight: 600;
                    text-transform: uppercase;
                }
                .status-pending {
                    background-color: #fff3cd;
                    color: #856404;
                }
                .status-processing {
                    background-color: #cce5ff;
                    color: #004085;
                }
                .status-shipped {
                    background-color: #d4edda;
                    color: #155724;
                }
                .status-delivered {
                    background-color: #d1e7dd;
                    color: #0f5132;
                }
                .status-cancelled {
                    background-color: #f8d7da;
                    color: #721c24;
                }
                .payment-pending {
                    color: #856404;
                }
                .payment-completed {
                    color: #155724;
                }
                .payment-failed {
                    color: #721c24;
                }
                .payment-refunded {
                    color: #0c5460;
                }
                .view-order-btn {
                    background: #007bff;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 4px 8px;
                    cursor: pointer;
                    margin-right: 5px;
                }
                .update-status-select {
                    padding: 4px;
                    border-radius: 4px;
                    border: 1px solid #ddd;
                }
            `;

            // Add to document
            document.head.appendChild(style);
        }

        // Update pagination controls
        function updateOrdersPagination() {
            const paginationContainer = document.getElementById('orders-pagination');

            // Clear container
            paginationContainer.innerHTML = '';

            // Create pagination info
            const startItem = (currentOrdersPage - 1) * ordersPerPage + 1;
            const endItem = Math.min(currentOrdersPage * ordersPerPage, orders.length);
            const totalItems = orders.length;

            const paginationInfo = document.createElement('div');
            paginationInfo.style.marginBottom = '10px';
            paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} orders`;

            // Create pagination buttons
            const buttonsContainer = document.createElement('div');

            // Previous button
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.style.cssText = 'padding:5px 10px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer; margin-right:5px;';
            prevButton.disabled = currentOrdersPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentOrdersPage > 1) {
                    currentOrdersPage--;
                    fetchOrders();
                }
            });

            // Next button
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.style.cssText = 'padding:5px 10px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;';
            nextButton.disabled = currentOrdersPage === totalOrdersPages;
            nextButton.addEventListener('click', () => {
                if (currentOrdersPage < totalOrdersPages) {
                    currentOrdersPage++;
                    fetchOrders();
                }
            });

            // Add buttons to container
            buttonsContainer.appendChild(prevButton);
            buttonsContainer.appendChild(nextButton);

            // Add to pagination container
            paginationContainer.appendChild(paginationInfo);
            paginationContainer.appendChild(buttonsContainer);
        }

        // View order details
        async function viewOrderDetails(orderId) {
            try {
                // Show loading indicator
                showLoading();

                // Fetch order details
                const response = await fetch(`https://tridex1.onrender.com/orders/${orderId}`);

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const order = await response.json();

                // Format date
                const orderDate = new Date(order.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Format payment date if exists
                let paymentDate = 'N/A';
                if (order.payment && order.payment.paymentDate) {
                    paymentDate = new Date(order.payment.paymentDate).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                // Calculate order totals
                const subtotal = order.totalAmount - order.shippingFee - order.tax;

                // Render order details
                const orderDetailsContent = document.getElementById('order-details-content');
                orderDetailsContent.innerHTML = `
                    <div style="margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <div>
                                <strong>Order ID:</strong> ${order._id}
                            </div>
                            <div>
                                <span class="status-badge status-${order.status}">${order.status}</span>
                            </div>
                        </div>
                        <div><strong>Date:</strong> ${orderDate}</div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <h3 style="border-bottom:1px solid #eee; padding-bottom:5px;">Customer Information</h3>
                        <div><strong>Name:</strong> ${order.shipping.name}</div>
                        <div><strong>Email:</strong> ${order.user.email}</div>
                        <div><strong>Phone:</strong> ${order.user.phone}</div>
                        <div><strong>Username:</strong> ${order.user.username || 'N/A'}</div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <h3 style="border-bottom:1px solid #eee; padding-bottom:5px;">Shipping Address</h3>
                        <div>${order.shipping.address}</div>
                        <div>${order.shipping.city}, ${order.shipping.state} ${order.shipping.postalCode}</div>
                        <div>${order.shipping.country}</div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <h3 style="border-bottom:1px solid #eee; padding-bottom:5px;">Payment Information</h3>
                        <div><strong>Method:</strong> ${order.payment.method.toUpperCase()}</div>
                        <div><strong>Status:</strong> <span class="payment-${order.payment.status}">${order.payment.status}</span></div>
                        <div><strong>Transaction ID:</strong> ${order.payment.transactionId || 'N/A'}</div>
                        <div><strong>Payment Date:</strong> ${paymentDate}</div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <h3 style="border-bottom:1px solid #eee; padding-bottom:5px;">Order Items</h3>
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Item</th>
                                    <th style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">Price</th>
                                    <th style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">Quantity</th>
                                    <th style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.items.map(item => `
                                    <tr>
                                        <td style="padding:8px; border-bottom:1px solid #ddd;">
                                            <div style="display:flex; align-items:center;">
                                                <img src="${item.image}" alt="${item.name}" style="width:40px; height:40px; object-fit:contain; margin-right:10px;" onerror="this.src='https://via.placeholder.com/40?text=No+Image'">
                                                <div>${item.name}</div>
                                            </div>
                                        </td>
                                        <td style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">₹${item.price}</td>
                                        <td style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">${item.quantity}</td>
                                        <td style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">₹${item.price * item.quantity}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="text-align:right; padding:8px;">Subtotal:</td>
                                    <td style="text-align:right; padding:8px;">₹${subtotal}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align:right; padding:8px;">Shipping:</td>
                                    <td style="text-align:right; padding:8px;">₹${order.shippingFee}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align:right; padding:8px;">Tax:</td>
                                    <td style="text-align:right; padding:8px;">₹${order.tax}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align:right; padding:8px; font-weight:bold;">Total:</td>
                                    <td style="text-align:right; padding:8px; font-weight:bold;">₹${order.totalAmount}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div style="margin-top:20px;">
                        <h3 style="border-bottom:1px solid #eee; padding-bottom:5px;">Update Order Status</h3>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <select id="order-status-update" style="padding:8px; border-radius:4px; border:1px solid #ddd; flex:1;">
                                <option value="">Select Status</option>
                                <option value="pending" ${order.status === 'pending' ? 'disabled' : ''}>Pending</option>
                                <option value="processing" ${order.status === 'processing' ? 'disabled' : ''}>Processing</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'disabled' : ''}>Shipped</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'disabled' : ''}>Delivered</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'disabled' : ''}>Cancelled</option>
                            </select>
                            <button id="update-order-status-btn" data-id="${order._id}" style="padding:8px 15px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">
                                Update Status
                            </button>
                        </div>
                    </div>
                `;

                // Add event listener for status update
                document.getElementById('update-order-status-btn').addEventListener('click', () => {
                    const newStatus = document.getElementById('order-status-update').value;
                    if (newStatus) {
                        updateOrderStatus(order._id, newStatus);
                    } else {
                        alert('Please select a status');
                    }
                });

                // Show modal
                document.getElementById('order-details-modal').style.display = 'block';
            } catch (error) {
                console.error('Error fetching order details:', error);
                alert(`Error fetching order details: ${error.message}`);
            } finally {
                // Hide loading indicator
                hideLoading();
            }
        }

        // Update order status
        async function updateOrderStatus(orderId, newStatus) {
            try {
                // Show loading indicator
                showLoading();

                // Update order status
                const response = await fetch(`https://tridex1.onrender.com/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                // Show success message
                alert(`Order status updated to ${newStatus}`);

                // Refresh orders
                fetchOrders();

                // Close modal if open
                if (document.getElementById('order-details-modal').style.display === 'block') {
                    document.getElementById('order-details-modal').style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                alert(`Error updating order status: ${error.message}`);
            } finally {
                // Hide loading indicator
                hideLoading();
            }
        }

        // Export orders to CSV
        function exportOrdersToCSV() {
            // Check if there are orders to export
            if (!orders || orders.length === 0) {
                alert('No orders to export');
                return;
            }

            // Create CSV header
            const csvHeader = [
                'Order ID',
                'Date',
                'Customer',
                'Email',
                'Items',
                'Total',
                'Payment Method',
                'Payment Status',
                'Order Status'
            ];

            // Create CSV rows
            const csvRows = orders.map(order => {
                const orderDate = new Date(order.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const itemsSummary = order.items.map(item => `${item.name} (${item.quantity})`).join(', ');

                return [
                    order._id,
                    orderDate,
                    order.shipping.name,
                    order.user.email,
                    itemsSummary,
                    order.totalAmount,
                    order.payment.method,
                    order.payment.status,
                    order.status
                ];
            });

            // Combine header and rows
            const csvContent = [
                csvHeader.join(','),
                ...csvRows.map(row => row.join(','))
            ].join('\n');

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `orders_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.display = 'none';

            // Add to document and click
            document.body.appendChild(link);
            link.click();

            // Clean up
            document.body.removeChild(link);
        }

        // Set up order management event listeners
        function setupOrderManagementListeners() {
            // Search button
            document.getElementById('order-search-btn').addEventListener('click', () => {
                orderFilters.status = document.getElementById('order-status-filter').value;
                orderFilters.customer = document.getElementById('order-customer-search').value;
                orderFilters.startDate = document.getElementById('order-date-from').value;
                orderFilters.endDate = document.getElementById('order-date-to').value;

                // Reset to first page
                currentOrdersPage = 1;

                // Fetch orders with new filters
                fetchOrders();
            });

            // Reset button
            document.getElementById('order-reset-btn').addEventListener('click', () => {
                // Clear filters
                document.getElementById('order-status-filter').value = '';
                document.getElementById('order-customer-search').value = '';
                document.getElementById('order-date-from').value = '';
                document.getElementById('order-date-to').value = '';

                // Reset filter values
                orderFilters.status = '';
                orderFilters.customer = '';
                orderFilters.startDate = '';
                orderFilters.endDate = '';

                // Reset to first page
                currentOrdersPage = 1;

                // Fetch orders without filters
                fetchOrders();
            });

            // Orders per page
            document.getElementById('orders-per-page').addEventListener('change', (e) => {
                ordersPerPage = parseInt(e.target.value);

                // Reset to first page
                currentOrdersPage = 1;

                // Fetch orders with new limit
                fetchOrders();
            });

            // Sort headers
            document.querySelectorAll('#orders-table th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const sortField = th.getAttribute('data-sort');

                    // Toggle sort direction if clicking the same field
                    if (sortField === orderSortField) {
                        orderSortDirection = orderSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        orderSortField = sortField;
                        orderSortDirection = 'desc'; // Default to descending for new sort field
                    }

                    // Update sort icons
                    document.querySelectorAll('#orders-table th[data-sort] i').forEach(icon => {
                        icon.className = 'fas fa-sort';
                    });

                    th.querySelector('i').className = `fas fa-sort-${orderSortDirection === 'asc' ? 'up' : 'down'}`;

                    // Fetch orders with new sort
                    fetchOrders();
                });
            });

            // Export to CSV
            document.getElementById('export-orders-csv').addEventListener('click', exportOrdersToCSV);

            // Close order details modal
            document.getElementById('close-order-details').addEventListener('click', () => {
                document.getElementById('order-details-modal').style.display = 'none';
            });

            // Close modal when clicking outside
            document.getElementById('order-details-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('order-details-modal')) {
                    document.getElementById('order-details-modal').style.display = 'none';
                }
            });
        }

        // Show/hide sections based on navigation
        document.getElementById('show-orders-btn').addEventListener('click', function() {
            // Hide all sections
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('product-section').style.display = 'none';
            document.getElementById('category-section').style.display = 'none';
            document.getElementById('orders-section').style.display = 'block';
            document.getElementById('analytics-section').style.display = 'none';
            document.getElementById('contact-section').style.display = 'none';
            document.getElementById('admin-mail-modal').style.display = 'none';

            // Update active button
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // Fetch orders if not already loaded
            if (!orders || orders.length === 0) {
                fetchOrders();
            }

            // Set up event listeners
            setupOrderManagementListeners();
        });

        // Analytics section navigation
        document.getElementById('show-analytics-btn').addEventListener('click', function() {
            // Hide all sections
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('product-section').style.display = 'none';
            document.getElementById('category-section').style.display = 'none';
            document.getElementById('orders-section').style.display = 'none';
            document.getElementById('analytics-section').style.display = 'block';
            document.getElementById('contact-section').style.display = 'none';
            document.getElementById('admin-mail-modal').style.display = 'none';

            // Update active button
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // Initialize analytics
            initializeAnalytics();
        });

        // ========== ANALYTICS FUNCTIONS ==========

        let analyticsCharts = {};
        let analyticsData = {};

        // Initialize analytics section
        async function initializeAnalytics() {
            try {
                // Populate year dropdown
                populateYearDropdown();

                // Set up event listeners
                setupAnalyticsListeners();

                // Load initial data
                await loadAnalyticsData();

                // Render charts
                renderAnalyticsCharts();

            } catch (error) {
                console.error('Error initializing analytics:', error);
                alert('Failed to load analytics data');
            }
        }

        // Populate year dropdown
        function populateYearDropdown() {
            const yearSelect = document.getElementById('analytics-year');
            const currentYear = new Date().getFullYear();

            // Clear existing options
            yearSelect.innerHTML = '';

            // Add years from current year back to 2020
            for (let year = currentYear; year >= 2020; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Set up analytics event listeners
        function setupAnalyticsListeners() {
            // Year change
            document.getElementById('analytics-year').addEventListener('change', async () => {
                await loadAnalyticsData();
                renderAnalyticsCharts();
            });

            // Refresh button
            document.getElementById('refresh-analytics-btn').addEventListener('click', async () => {
                await loadAnalyticsData();
                renderAnalyticsCharts();
            });

            // Download chart button
            document.getElementById('download-chart-btn').addEventListener('click', downloadChart);
        }

        // Load analytics data from server
        async function loadAnalyticsData() {
            try {
                showLoading();

                const selectedYear = document.getElementById('analytics-year').value;

                // Fetch analytics data
                const response = await fetch(`https://tridex1.onrender.com/analytics/sales?year=${selectedYear}`);

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                analyticsData = await response.json();

                // Update stats cards
                updateStatsCards();

            } catch (error) {
                console.error('Error loading analytics data:', error);
                alert('Failed to load analytics data: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Update stats cards
        function updateStatsCards() {
            const data = analyticsData;

            document.getElementById('total-orders-stat').textContent = data.totalOrders || 0;
            document.getElementById('total-revenue-stat').textContent = `₹${(data.totalRevenue || 0).toLocaleString()}`;
            document.getElementById('avg-order-stat').textContent = `₹${(data.averageOrderValue || 0).toLocaleString()}`;
            document.getElementById('growth-rate-stat').textContent = `${(data.growthRate || 0).toFixed(1)}%`;
        }

        // Render all analytics charts
        function renderAnalyticsCharts() {
            renderMonthlySalesChart();
            renderOrderStatusChart();
            renderTopProductsChart();
        }

        // Render monthly sales chart
        function renderMonthlySalesChart() {
            const ctx = document.getElementById('monthly-sales-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (analyticsCharts.monthlySales) {
                analyticsCharts.monthlySales.destroy();
            }

            const monthlyData = analyticsData.monthlyData || [];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Prepare data arrays
            const orderCounts = new Array(12).fill(0);
            const revenues = new Array(12).fill(0);

            monthlyData.forEach(item => {
                const monthIndex = item._id.month - 1;
                orderCounts[monthIndex] = item.orderCount;
                revenues[monthIndex] = item.revenue;
            });

            analyticsCharts.monthlySales = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Orders',
                        data: orderCounts,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        yAxisID: 'y'
                    }, {
                        label: 'Revenue (₹)',
                        data: revenues,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Number of Orders'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Revenue (₹)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Monthly Sales Overview - ${document.getElementById('analytics-year').value}`
                        }
                    }
                }
            });
        }

        // Render order status distribution chart
        function renderOrderStatusChart() {
            const ctx = document.getElementById('order-status-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (analyticsCharts.orderStatus) {
                analyticsCharts.orderStatus.destroy();
            }

            const statusData = analyticsData.statusDistribution || [];
            const labels = statusData.map(item => item._id);
            const data = statusData.map(item => item.count);
            const colors = ['#ffc107', '#007bff', '#17a2b8', '#28a745', '#dc3545'];

            analyticsCharts.orderStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Order Status Distribution'
                        }
                    }
                }
            });
        }

        // Render top products chart
        function renderTopProductsChart() {
            const ctx = document.getElementById('top-products-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (analyticsCharts.topProducts) {
                analyticsCharts.topProducts.destroy();
            }

            const topProducts = analyticsData.topProducts || [];
            const labels = topProducts.map(item => item.name.length > 20 ? item.name.substring(0, 20) + '...' : item.name);
            const data = topProducts.map(item => item.totalSold);

            analyticsCharts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Units Sold',
                        data: data,
                        backgroundColor: '#007bff',
                        borderColor: '#0056b3',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Units Sold'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Products'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top Selling Products'
                        }
                    }
                }
            });
        }

        // Download chart as image
        function downloadChart() {
            const canvas = document.getElementById('monthly-sales-chart');
            const url = canvas.toDataURL('image/png');

            const link = document.createElement('a');
            link.download = `monthly-sales-${document.getElementById('analytics-year').value}.png`;
            link.href = url;
            link.click();
        }

        // On load
        fetchUsers();
        fetchProducts();
        fetchCategories();
    </script>

    <!-- Wishlist Scripts -->
    <script src="js/wishlist.js"></script>
</body>
</html>
