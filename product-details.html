<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Product Details</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/product-media-gallery.css">
    <link rel="stylesheet" href="css/color-variant-selector.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Include responsive behavior script -->
    <script src="js/responsive.js" defer></script>
    <!-- Include navigation state management script -->
    <script src="js/navigation-state.js" defer></script>
    <style>
        /* Main container styles */
        body {
            background-color: #f1f3f6;
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #212121;
            padding-top: 60px; /* Account for fixed header */
        }

        /* Header styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            z-index: 1000;
            height: 60px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .logo a {
            color: white;
            text-decoration: none;
        }

        /* Hamburger menu */
        .hamburger-menu {
            display: none;
            flex-direction: column;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            gap: 3px;
        }

        .hamburger-menu span {
            width: 25px;
            height: 3px;
            background: white;
            transition: all 0.3s ease;
        }

        .hamburger-menu.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger-menu.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Navigation */
        .nav {
            display: flex;
        }

        .main-nav {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
            position: relative;
        }

        .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Product details layout */
        .product-details-wrapper {
            display: flex;
            flex-wrap: wrap;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            padding: 20px;
        }

        /* Product image section */
        .product-image-section {
            flex: 0 0 40%;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        /* Legacy image style (for backward compatibility) */
        .product-image-section img.legacy-image {
            width: 100%;
            height: 400px;
            object-fit: contain;
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .wishlist-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .wishlist-icon:hover {
            transform: scale(1.1);
        }

        .wishlist-icon i {
            color: #c2c2c2;
            font-size: 18px;
        }

        .wishlist-icon.active i {
            color: #ff6161;
        }

        /* Product info section */
        .product-info-section {
            flex: 0 0 60%;
            padding: 20px;
        }

        .product-title {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .product-rating {
            display: inline-block;
            background: #388e3c;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 14px;
            margin-right: 10px;
        }

        .product-rating i {
            font-size: 12px;
            margin-left: 4px;
        }

        .product-reviews {
            color: #878787;
            font-size: 14px;
            cursor: pointer;
        }

        .product-price {
            margin: 20px 0;
            font-size: 28px;
            font-weight: 500;
        }

        .original-price {
            text-decoration: line-through;
            color: #878787;
            font-size: 16px;
            margin-left: 10px;
        }

        .discount {
            color: #388e3c;
            font-size: 16px;
            margin-left: 10px;
        }

        .product-description {
            margin: 20px 0;
            line-height: 1.5;
        }

        /* AI Summary Styles */
        .product-summary {
            margin: 20px 0;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #2874f0;
        }

        .product-summary h3 {
            margin-top: 0;
            color: #2874f0;
            font-size: 18px;
            display: flex;
            align-items: center;
        }

        .ai-summary {
            position: relative;
            padding-left: 10px;
        }

        .ai-badge {
            display: inline-block;
            background-color: #2874f0;
            color: white;
            font-size: 12px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 12px;
            margin-right: 10px;
            position: absolute;
            top: 0;
            right: 0;
        }

        .ai-summary p {
            margin: 10px 0 0;
            line-height: 1.6;
            color: #333;
            font-style: italic;
        }

        /* Action buttons */
        .product-actions {
            display: flex;
            margin: 30px 0 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 16px 30px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            margin-right: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .action-btn i {
            margin-right: 8px;
        }

        .add-to-cart-btn {
            background-color: #ff9f00;
            color: white;
        }

        .add-to-cart-btn:hover {
            background-color: #f39000;
        }

        .buy-now-btn {
            background-color: #fb641b;
            color: white;
        }

        .buy-now-btn:hover {
            background-color: #ea5c19;
        }

        /* Product highlights */
        .product-highlights {
            margin: 20px 0;
        }

        .product-highlights h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .product-highlights ul {
            padding-left: 20px;
        }

        .product-highlights li {
            margin-bottom: 8px;
        }

        /* Similar products section */
        .similar-products-section {
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 20px;
        }

        .similar-products-section h2 {
            font-size: 22px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #212121;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .similar-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .similar-product-card {
            background: white;
            border-radius: 4px;
            padding: 15px;
            transition: box-shadow 0.3s;
            cursor: pointer;
            text-align: center;
        }

        .similar-product-card:hover {
            box-shadow: 0 3px 16px rgba(0,0,0,0.1);
        }

        .similar-product-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            padding: 8px;
            transition: transform 0.2s ease;
        }

        .similar-product-card:hover img {
            transform: scale(1.05);
        }

        .similar-product-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #212121;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 40px;
        }

        .similar-product-price {
            font-size: 16px;
            font-weight: 500;
            color: #212121;
        }

        /* Reviews section */
        .reviews-section {
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 20px;
        }

        .reviews-section h2 {
            font-size: 22px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #212121;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .review-form {
            margin-bottom: 30px;
        }

        .review-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 15px;
        }

        .rating-select {
            margin-bottom: 15px;
        }

        .rating-select span {
            margin-right: 10px;
        }

        .star-rating {
            display: inline-block;
            font-size: 24px;
            cursor: pointer;
        }

        .star-rating i {
            color: #c2c2c2;
            margin-right: 5px;
        }

        .star-rating i.active {
            color: #ffc107;
        }

        .submit-review-btn {
            background-color: #2874f0;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 16px;
        }

        .submit-review-btn:hover {
            background-color: #2264d1;
        }

        .reviews-list {
            margin-top: 30px;
        }

        .review-item {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .reviewer-name {
            font-weight: 500;
        }

        .review-date {
            color: #878787;
            font-size: 14px;
        }

        .review-rating {
            color: #ffc107;
            margin-bottom: 10px;
        }

        .review-content {
            line-height: 1.5;
        }

        .review-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .review-actions button {
            background: none;
            border: none;
            color: #2874f0;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .review-actions button i {
            margin-right: 5px;
        }

        .reply-form {
            display: none;
            margin-top: 10px;
        }

        .reply-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            resize: none;
            margin-bottom: 10px;
        }

        .submit-reply-btn {
            background-color: #2874f0;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
        }

        .submit-reply-btn:hover {
            background-color: #2264d1;
        }

        .cancel-reply-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 14px;
        }

        .cancel-reply-btn:hover {
            text-decoration: underline;
        }

        .replies-list {
            margin-left: 30px;
            margin-top: 10px;
        }

        .reply-item {
            margin-bottom: 10px;
        }

        .reply-user {
            font-weight: 500;
            margin-right: 5px;
        }

        /* Animation for loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive styles */
        @media (max-width: 992px) {
            .hamburger-menu {
                display: flex;
            }

            .nav {
                display: none;
                position: absolute;
                top: 60px;
                left: 0;
                width: 100%;
                background: #333;
                flex-direction: column;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }

            .nav.show {
                display: flex;
            }

            .main-nav {
                flex-direction: column;
                gap: 0;
            }

            .nav-link {
                padding: 15px 20px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }

            .nav-link:last-child {
                border-bottom: none;
            }
        }

        @media (max-width: 768px) {
            .product-details-wrapper {
                flex-direction: column;
            }

            .product-image-section, .product-info-section {
                flex: 0 0 100%;
            }

            .product-actions {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                margin-right: 0;
            }

            .similar-products-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .header-container {
                padding: 0 15px;
            }

            .logo h1 {
                font-size: 20px;
            }
        }

        /* Action message */
        #product-action-msg {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <button id="hamburger-menu" class="hamburger-menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="logo">
                    <a href="index.html">
                        <h1>TRIDEX</h1>
                    </a>
                </div>
            </div>

            <nav id="nav" class="nav">
                <div id="main-nav" class="main-nav">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="profile.html" class="nav-link" id="profile-link">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                    <a href="mailbox.html" class="nav-link" id="mailbox-link">
                        <i class="fas fa-envelope"></i>
                        <span>Messages</span>
                        <span id="mail-count" class="notification-badge" style="display: none;"></span>
                    </a>
                    <a href="cart.html" class="nav-link" id="cart-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Cart</span>
                        <span id="cart-count" class="notification-badge" style="display: none;"></span>
                    </a>
                </div>
            </nav>
        </div>
    </header>

    <div class="container">
        <div id="product-details-container">
            <!-- Product details will be rendered here -->
        </div>

        <div id="similar-products-container">
            <!-- Similar products will be rendered here -->
        </div>

        <div id="reviews-container">
            <!-- Reviews will be rendered here -->
        </div>
    </div>

    <div id="product-action-msg"></div>
    <script>
        // Global variables
        let currentProduct = null;
        let allProducts = [];
        let reviews = [];
        let currentRating = 0;
        let colorVariants = [];
        let selectedVariant = null;

        // Get product id from URL
        function getProductId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Main function to initialize the page
        async function initProductPage() {
            try {
                // Show loading state
                document.getElementById('product-details-container').innerHTML = `
                    <div style="text-align:center; padding:50px;">
                        <div style="display:inline-block; border:4px solid #f3f3f3; border-top:4px solid #2874f0; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;"></div>
                        <p style="margin-top:20px; color:#666;">Loading product details...</p>
                    </div>
                `;

                // Fetch products
                const res = await fetch('https://tridex1.onrender.com/products');
                allProducts = await res.json();

                // Find current product
                const id = getProductId();
                currentProduct = allProducts.find(p => p._id === id);

                if (!currentProduct) {
                    document.getElementById('product-details-container').innerHTML = `
                        <div style="text-align:center; padding:50px;">
                            <div style="font-size:60px; color:#dc3545; margin-bottom:20px;">😕</div>
                            <h2 style="color:#dc3545; margin-bottom:20px;">Product Not Found</h2>
                            <p style="margin-bottom:30px;">The product you're looking for doesn't exist or has been removed.</p>
                            <button onclick="window.location.href='index.html'" style="padding:10px 20px; background:#2874f0; color:white; border:none; border-radius:4px; cursor:pointer;">
                                Back to Home
                            </button>
                        </div>
                    `;
                    return;
                }

                // Fetch or initialize reviews
                await loadReviews();

                // Load color variants if this is a parent product or a variant
                await loadColorVariants();

                // Render all sections
                renderProductDetails();
                renderSimilarProducts();
                renderReviews();

                // Initialize event listeners
                initEventListeners();
                initReviewActionListeners();

            // Initialize color variant event listeners if variants are loaded
            if (colorVariants.length > 0) {
                initColorVariantListeners();
            }
            } catch (error) {
                console.error('Error initializing product page:', error);
                document.getElementById('product-details-container').innerHTML = `
                    <div style="text-align:center; padding:50px;">
                        <div style="font-size:60px; color:#dc3545; margin-bottom:20px;">😞</div>
                        <h2 style="color:#dc3545; margin-bottom:20px;">Something Went Wrong</h2>
                        <p style="margin-bottom:30px;">We couldn't load the product details. Please try again later.</p>
                        <button onclick="window.location.reload()" style="padding:10px 20px; background:#2874f0; color:white; border:none; border-radius:4px; cursor:pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Render product details section
        function renderProductDetails() {
            // Use selectedVariant if set, else currentProduct
            const product = selectedVariant || currentProduct;
            // Calculate average rating
            const avgRating = calculateAverageRating();
            const ratingDisplay = avgRating > 0
                ? `<div class="product-rating">${avgRating.toFixed(1)} <i class="fas fa-star"></i></div>
                   <span class="product-reviews">${reviews.length} Reviews</span>`
                : '<span class="product-reviews">No reviews yet</span>';

            // Calculate discount (mock data for demonstration)
            const originalPrice = Math.round(product.price * 1.2); // 20% higher for demo
            const discountPercent = Math.round((originalPrice - product.price) / originalPrice * 100);

            // Check if product is in wishlist
            const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
            const isInWishlist = wishlist.some(p => p._id === product._id);

            // Generate highlights from description (for demo)
            const highlights = generateHighlights(product.desc);

            document.getElementById('product-details-container').innerHTML = `
                <div class="product-details-wrapper">
                    <div class="product-image-section">
                        ${product.media && product.media.length > 0 ? `
                        <!-- Product Gallery -->
                        <div class="product-gallery">
                            <div class="gallery-main-image" id="gallery-main-container">
                                <!-- Main image or video will be displayed here -->
                            </div>

                            <div class="gallery-thumbnails" id="gallery-thumbnails">
                                <!-- Thumbnails will be displayed here -->
                            </div>

                            ${product.media.length > 1 ? `
                            <div class="gallery-nav prev" id="gallery-prev">
                                <i class="fas fa-chevron-left"></i>
                            </div>
                            <div class="gallery-nav next" id="gallery-next">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            ` : ''}

                            <div class="swipe-indicator">
                                <i class="fas fa-hand-point-up"></i> Swipe to view more
                            </div>
                        </div>
                        ` : `
                        <!-- Legacy Image (for backward compatibility) -->
                        <img class="legacy-image" src="${product.image}" alt="${product.name}">
                        `}

                        <div class="wishlist-icon ${isInWishlist ? 'active' : ''}" id="wishlist-toggle">
                            <i class="fas fa-heart"></i>
                        </div>
                    </div>

                    <div class="product-info-section">
                        <h1 class="product-title">${product.name}</h1>
                        <div>
                            ${ratingDisplay}
                        </div>

                        <div class="product-price">
                            ₹${product.price}
                            <span class="original-price">₹${originalPrice}</span>
                            <span class="discount">${discountPercent}% off</span>
                        </div>

                        <!-- Color Variants Section -->
                        <div class="color-variants-container" id="color-variants-container">
                            <!-- Color variants will be loaded dynamically if available -->
                        </div>

                        ${product.aiSummary ? `
                        <div class="product-summary">
                            <h3>Product Summary</h3>
                            <div class="ai-summary">
                                <div class="ai-badge">AI</div>
                                <p>${product.aiSummary}</p>
                            </div>
                        </div>
                        ` : ''}

                        <div class="product-description">
                            ${product.desc}
                        </div>

                        <div class="product-highlights">
                            <h3>Highlights</h3>
                            <ul>
                                ${highlights.map(h => `<li>${h}</li>`).join('')}
                            </ul>
                        </div>

                        <div class="product-actions">
                            <button class="action-btn add-to-cart-btn" id="add-to-cart-btn">
                                <i class="fas fa-shopping-cart"></i> ADD TO CART
                            </button>
                            <button class="action-btn buy-now-btn" id="buy-now-btn">
                                <i class="fas fa-bolt"></i> BUY NOW
                            </button>
                        </div>

                        <div style="margin-top:20px;">
                            <button id="back-button" style="background:none; border:none; color:#2874f0; cursor:pointer; font-size:14px;">
                                <i class="fas fa-arrow-left"></i> Back to Products
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render similar products section
        function renderSimilarProducts() {
            // Find similar products based on name or description
            const filter = currentProduct.name.toLowerCase().split(' ')[0]; // Use first word for better matches
            const similar = allProducts.filter(p =>
                p._id !== currentProduct._id &&
                (p.name.toLowerCase().includes(filter) ||
                (p.desc && p.desc.toLowerCase().includes(filter)))
            ).slice(0, 6); // Show up to 6 similar products

            if (similar.length === 0) {
                document.getElementById('similar-products-container').innerHTML = '';
                return;
            }

            document.getElementById('similar-products-container').innerHTML = `
                <div class="similar-products-section">
                    <h2>Similar Products</h2>
                    <div class="similar-products-grid">
                        ${similar.map(product => `
                            <div class="similar-product-card" onclick="navigateToProduct('${product._id}')">
                                <img src="${product.image}" alt="${product.name}">
                                <div class="similar-product-title">${product.name}</div>
                                <div class="similar-product-price">₹${product.price}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Render reviews section
        function renderReviews() {
            document.getElementById('reviews-container').innerHTML = `
                <div class="reviews-section">
                    <h2>Ratings & Reviews</h2>

                    <div class="review-form">
                        <h3>Write a Review</h3>
                        <div class="rating-select">
                            <span>Your Rating:</span>
                            <div class="star-rating" id="star-rating">
                                <i class="far fa-star" data-rating="1"></i>
                                <i class="far fa-star" data-rating="2"></i>
                                <i class="far fa-star" data-rating="3"></i>
                                <i class="far fa-star" data-rating="4"></i>
                                <i class="far fa-star" data-rating="5"></i>
                            </div>
                        </div>
                        <textarea id="review-text" placeholder="Write your review here..."></textarea>
                        <button class="submit-review-btn" id="submit-review-btn">Submit Review</button>
                    </div>

                    <div class="reviews-list" id="reviews-list">
                        ${reviews.length > 0 ? reviews.map(review => `
                            <div class="review-item" data-review-id="${review._id}">
                                <div class="review-header">
                                    <span class="reviewer-name">${review.username || review.user?.username || 'User'}</span>
                                    <span class="review-date">${formatDate(review.date || review.createdAt)}</span>
                                </div>
                                <div class="review-rating">
                                    ${generateStarRating(review.rating)}
                                </div>
                                <div class="review-content">
                                    ${review.text}
                                </div>
                                <div class="review-actions" style="display: flex; gap: 10px; align-items: center;">
                                    <button class="like-review-btn" data-review-id="${review._id}" style="display: flex; align-items: center;">
                                        <i class="fas fa-thumbs-up"></i> <span class="like-count">${review.likes?.length || 0}</span>
                                    </button>
                                    <button class="dislike-review-btn" data-review-id="${review._id}" style="display: flex; align-items: center;">
                                        <i class="fas fa-thumbs-down"></i> <span class="dislike-count">${review.dislikes?.length || 0}</span>
                                    </button>
                                    <button class="reply-review-btn" data-review-id="${review._id}" style="display: flex; align-items: center;">
                                        <i class="fas fa-reply"></i> Reply
                                    </button>
                                </div>
                                <div class="reply-form" id="reply-form-${review._id}" style="display:none; margin-top:10px;">
                                    <textarea class="reply-text" placeholder="Write a reply..."></textarea>
                                    <button class="submit-reply-btn" data-review-id="${review._id}">Submit</button>
                                    <button class="cancel-reply-btn" data-review-id="${review._id}">Cancel</button>
                                </div>
                                <div class="replies-list" style="margin-left:30px; margin-top:10px;">
                                    ${review.replies && review.replies.length > 0 ? review.replies.map(reply => `
                                        <div class="reply-item" data-reply-id="${reply._id}">
                                            <span class="reply-user">${reply.username || reply.user?.username || 'User'}</span>:
                                            <span class="reply-text">${reply.text}</span>
                                            <span class="reply-date">${formatDate(reply.createdAt)}</span>
                                            <button class="like-reply-btn" data-review-id="${review._id}" data-reply-id="${reply._id}"><i class="fas fa-thumbs-up"></i> <span class="like-count">${reply.likes?.length || 0}</span></button>
                                            <button class="dislike-reply-btn" data-review-id="${review._id}" data-reply-id="${reply._id}"><i class="fas fa-thumbs-down"></i> <span class="dislike-count">${reply.dislikes?.length || 0}</span></button>
                                        </div>
                                    `).join('') : ''}
                                </div>
                            </div>
                        `).join('') : '<p>No reviews yet. Be the first to review this product!</p>'}
                    </div>
                </div>
            `;
        }

        // Cart count update function
        function updateCartCount() {
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
                let cart = [];
                try {
                    cart = JSON.parse(localStorage.getItem('cart')) || [];
                } catch (e) {
                    cart = [];
                }
                cartCountElement.textContent = cart.length || '';
                cartCountElement.style.display = cart.length ? 'inline-flex' : 'none';
            }
        }

        // Initialize all event listeners
        function initEventListeners() {
            // Wishlist toggle
            document.getElementById('wishlist-toggle').addEventListener('click', toggleWishlist);

            // Add to cart button
            document.getElementById('add-to-cart-btn').addEventListener('click', addToCart);

            // Buy now button
            document.getElementById('buy-now-btn').addEventListener('click', buyNow);

            // Update cart count on page load
            updateCartCount();

            // Star rating selection
            const stars = document.querySelectorAll('#star-rating i');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    setRating(rating);
                });

                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    highlightStars(rating);
                });

                star.addEventListener('mouseout', function() {
                    highlightStars(currentRating);
                });
            });

            // Submit review button
            document.getElementById('submit-review-btn').addEventListener('click', submitReview);

            // Initialize product gallery if it exists
            if (currentProduct.media && currentProduct.media.length > 0) {
                initProductGallery();
            }

            // Back button click handler
            document.getElementById('back-button').addEventListener('click', function() {
                // Check if we have a history state to go back to
                if (history.state && history.state.page === 'index') {
                    // Go back to the previous page
                    history.back();
                } else {
                    // If no history state, redirect to index.html
                    window.location.href = 'index.html';
                }
            });
        }

        // Initialize review action listeners
        function initReviewActionListeners() {
            // Like/dislike review
            document.querySelectorAll('.like-review-btn').forEach(btn => {
                btn.onclick = async function() {
                    const reviewId = this.getAttribute('data-review-id');
                    await likeOrDislikeReview(reviewId, 'like');
                };
            });
            document.querySelectorAll('.dislike-review-btn').forEach(btn => {
                btn.onclick = async function() {
                    const reviewId = this.getAttribute('data-review-id');
                    await likeOrDislikeReview(reviewId, 'dislike');
                };
            });
            // Reply button
            document.querySelectorAll('.reply-review-btn').forEach(btn => {
                btn.onclick = function() {
                    const reviewId = this.getAttribute('data-review-id');
                    const form = document.getElementById('reply-form-' + reviewId);
                    if (form) form.style.display = 'block';
                };
            });
            // Cancel reply
            document.querySelectorAll('.cancel-reply-btn').forEach(btn => {
                btn.onclick = function() {
                    const reviewId = this.getAttribute('data-review-id');
                    const form = document.getElementById('reply-form-' + reviewId);
                    if (form) form.style.display = 'none';
                };
            });
            // Submit reply
            document.querySelectorAll('.submit-reply-btn').forEach(btn => {
                btn.onclick = async function() {
                    const reviewId = this.getAttribute('data-review-id');
                    const form = document.getElementById('reply-form-' + reviewId);
                    const textarea = form.querySelector('.reply-text');
                    const text = textarea.value.trim();
                    if (!text) return showActionMessage('Reply cannot be empty', 'error');
                    await submitReply(reviewId, text);
                    textarea.value = '';
                    form.style.display = 'none';
                };
            });
            // Like/dislike reply
            document.querySelectorAll('.like-reply-btn').forEach(btn => {
                btn.onclick = async function() {
                    const reviewId = this.getAttribute('data-review-id');
                    const replyId = this.getAttribute('data-reply-id');
                    await likeOrDislikeReply(reviewId, replyId, 'like');
                };
            });
            document.querySelectorAll('.dislike-reply-btn').forEach(btn => {
                btn.onclick = async function() {
                    const reviewId = this.getAttribute('data-review-id');
                    const replyId = this.getAttribute('data-reply-id');
                    await likeOrDislikeReply(reviewId, replyId, 'dislike');
                };
            });
        }

        // Call this after rendering reviews
        function refreshReviewsUI() {
            renderReviews();
            initReviewActionListeners();
        }

        // Like/dislike review
        async function likeOrDislikeReview(reviewId, action) {
            try {
                const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
                if (!username) return showActionMessage('Please log in to like/dislike', 'error');
                const res = await fetch(`https://tridex1.onrender.com/reviews/${reviewId}/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, username })
                });
                if (!res.ok) throw new Error('Failed to update like/dislike');
                // Update the count in the DOM immediately
                const reviewElem = document.querySelector(`.review-item[data-review-id="${reviewId}"]`);
                if (reviewElem) {
                    const data = await res.json();
                    reviewElem.querySelector('.like-count').textContent = data.likes?.length || 0;
                    reviewElem.querySelector('.dislike-count').textContent = data.dislikes?.length || 0;
                }
                await loadReviews();
                refreshReviewsUI();
            } catch (e) { showActionMessage('Error updating like/dislike', 'error'); }
        }
        // Like/dislike reply
        async function likeOrDislikeReply(reviewId, replyId, action) {
            try {
                const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
                if (!username) return showActionMessage('Please log in to like/dislike', 'error');
                await fetch(`https://tridex1.onrender.com/reviews/${reviewId}/replies/${replyId}/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, username })
                });
                await loadReviews();
                refreshReviewsUI();
            } catch (e) { showActionMessage('Error updating like/dislike', 'error'); }
        }
        // Submit reply
        async function submitReply(reviewId, text) {
            try {
                const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
                if (!username) return showActionMessage('Please log in to reply', 'error');
                await fetch(`https://tridex1.onrender.com/reviews/${reviewId}/replies`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, username })
                });
                await loadReviews();
                refreshReviewsUI();
            } catch (e) { showActionMessage('Error submitting reply', 'error'); }
        }

        // Initialize product gallery
        function initProductGallery() {
            // Sort media items by order and ensure primary item is first
            const mediaItems = [...currentProduct.media].sort((a, b) => {
                // Primary item always comes first
                if (a.isPrimary && !b.isPrimary) return -1;
                if (!a.isPrimary && b.isPrimary) return 1;
                // Then sort by order
                return a.order - b.order;
            });

            // If no media items, return
            if (mediaItems.length === 0) return;

            // Get gallery elements
            const mainContainer = document.getElementById('gallery-main-container');
            const thumbnailsContainer = document.getElementById('gallery-thumbnails');

            // Clear containers
            mainContainer.innerHTML = '';
            thumbnailsContainer.innerHTML = '';

            // Current media index
            let currentIndex = 0;

            // Function to display media item
            function displayMediaItem(index) {
                // Update current index
                currentIndex = index;

                // Get media item
                const item = mediaItems[index];

                // Update main container
                if (item.type === 'image') {
                    mainContainer.innerHTML = `<img src="${item.url}" alt="${item.altText || currentProduct.name}">`;
                } else if (item.type === 'video') {
                    mainContainer.innerHTML = `
                        <div class="gallery-main-video">
                            <video controls>
                                <source src="${item.url}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `;
                }

                // Update active thumbnail
                const thumbnails = thumbnailsContainer.querySelectorAll('.gallery-thumbnail');
                thumbnails.forEach((thumb, i) => {
                    if (i === index) {
                        thumb.classList.add('active');
                    } else {
                        thumb.classList.remove('active');
                    }
                });
            }

            // Create thumbnails
            mediaItems.forEach((item, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = `gallery-thumbnail ${index === 0 ? 'active' : ''}`;

                if (item.type === 'image') {
                    thumbnail.innerHTML = `<img src="${item.url}" alt="${item.altText || currentProduct.name}">`;
                } else if (item.type === 'video') {
                    thumbnail.className += ' gallery-thumbnail-video';
                    thumbnail.innerHTML = `<img src="${item.thumbnail || 'https://via.placeholder.com/80?text=Video'}" alt="Video">`;
                }

                // Add click event
                thumbnail.addEventListener('click', () => {
                    displayMediaItem(index);
                });

                thumbnailsContainer.appendChild(thumbnail);
            });

            // Display first media item
            displayMediaItem(0);

            // Add navigation events if there are multiple media items
            if (mediaItems.length > 1) {
                // Previous button
                const prevBtn = document.getElementById('gallery-prev');
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        const newIndex = (currentIndex - 1 + mediaItems.length) % mediaItems.length;
                        displayMediaItem(newIndex);
                    });
                }

                // Next button
                const nextBtn = document.getElementById('gallery-next');
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        const newIndex = (currentIndex + 1) % mediaItems.length;
                        displayMediaItem(newIndex);
                    });
                }

                // Add swipe support for mobile
                let touchStartX = 0;
                let touchEndX = 0;

                mainContainer.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                });

                mainContainer.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                });

                function handleSwipe() {
                    const swipeThreshold = 50;
                    if (touchEndX < touchStartX - swipeThreshold) {
                        // Swipe left (next)
                        const newIndex = (currentIndex + 1) % mediaItems.length;
                        displayMediaItem(newIndex);
                    } else if (touchEndX > touchStartX + swipeThreshold) {
                        // Swipe right (previous)
                        const newIndex = (currentIndex - 1 + mediaItems.length) % mediaItems.length;
                        displayMediaItem(newIndex);
                    }
                }

                // Add keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft') {
                        const newIndex = (currentIndex - 1 + mediaItems.length) % mediaItems.length;
                        displayMediaItem(newIndex);
                    } else if (e.key === 'ArrowRight') {
                        const newIndex = (currentIndex + 1) % mediaItems.length;
                        displayMediaItem(newIndex);
                    }
                });
            }
        }

        // Toggle wishlist status
        function toggleWishlist() {
            let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
            const isInWishlist = wishlist.some(p => p._id === currentProduct._id);

            if (isInWishlist) {
                // Remove from wishlist
                wishlist = wishlist.filter(p => p._id !== currentProduct._id);
                localStorage.setItem('wishlist', JSON.stringify(wishlist));
                document.getElementById('wishlist-toggle').classList.remove('active');
                showActionMessage('Removed from wishlist');
            } else {
                // Add to wishlist
                wishlist.push(currentProduct);
                localStorage.setItem('wishlist', JSON.stringify(wishlist));
                document.getElementById('wishlist-toggle').classList.add('active');
                showActionMessage('Added to wishlist');
            }
        }

        // Add product to cart
        function addToCart() {
            // Get the current username
            const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

            // Check if user is logged in
            if (!username) {
                showActionMessage('Please log in to add items to cart', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return;
            }

            // Use selectedVariant if available, otherwise use currentProduct
            const productToAdd = selectedVariant || currentProduct;

            // Get the cart
            let cart = [];
            try {
                cart = JSON.parse(localStorage.getItem('cart')) || [];
            } catch (e) {
                cart = [];
            }

            // Check if product is already in cart (check by ID)
            const isInCart = cart.some(p => p._id === productToAdd._id);

            if (isInCart) {
                showActionMessage('Already in cart');
            } else {
                // Create cart item with variant information
                const cartItem = {
                    ...productToAdd,
                    // Add variant-specific information for display
                    variantInfo: selectedVariant ? {
                        color: selectedVariant.color,
                        isVariant: true,
                        parentProductId: selectedVariant.parentProduct
                    } : null
                };

                // Add product to cart
                cart.push(cartItem);
                localStorage.setItem('cart', JSON.stringify(cart));

                // Also save to user-specific cart
                localStorage.setItem('cart_' + username, JSON.stringify(cart));
                localStorage.setItem('cartUser', username);

                // Show success message with variant info
                const variantText = selectedVariant ? ` (${selectedVariant.color.name})` : '';
                showActionMessage(`Added to cart${variantText}`);

                // Update cart count if updateCartCount function exists
                if (window.updateCartCount) {
                    window.updateCartCount();
                }
            }
        }

        // Buy now functionality
        function buyNow() {
            // Get the current username
            const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

            // Check if user is logged in
            if (!username) {
                showActionMessage('Please log in to purchase items', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return;
            }

            // Use selectedVariant if available, otherwise use currentProduct
            const productToAdd = selectedVariant || currentProduct;

            // Get the cart
            let cart = [];
            try {
                cart = JSON.parse(localStorage.getItem('cart')) || [];
            } catch (e) {
                cart = [];
            }

            // Add to cart first if not already there
            if (!cart.some(p => p._id === productToAdd._id)) {
                // Create cart item with variant information
                const cartItem = {
                    ...productToAdd,
                    // Add variant-specific information for display
                    variantInfo: selectedVariant ? {
                        color: selectedVariant.color,
                        isVariant: true,
                        parentProductId: selectedVariant.parentProduct
                    } : null
                };

                cart.push(cartItem);
                localStorage.setItem('cart', JSON.stringify(cart));

                // Also save to user-specific cart
                localStorage.setItem('cart_' + username, JSON.stringify(cart));
                localStorage.setItem('cartUser', username);
            }

            // Redirect to checkout page (you would create this page)
            const variantText = selectedVariant ? ` (${selectedVariant.color.name})` : '';
            showActionMessage(`Proceeding to checkout${variantText}...`);
            setTimeout(() => {
                // Redirect to cart page for now (you can change this to checkout page when created)
                window.location.href = 'cart.html';
            }, 1000);
        }

        // Set rating in the review form
        function setRating(rating) {
            currentRating = rating;
            highlightStars(rating);
        }

        // Highlight stars up to the selected rating
        function highlightStars(rating) {
            const stars = document.querySelectorAll('#star-rating i');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.className = 'fas fa-star active';
                } else {
                    star.className = 'far fa-star';
                }
            });
        }

        // Submit a new review
        function submitReview() {
            const reviewText = document.getElementById('review-text').value.trim();

            if (currentRating === 0) {
                showActionMessage('Please select a rating', 'error');
                return;
            }

            if (reviewText === '') {
                showActionMessage('Please write a review', 'error');
                return;
            }

            // Get current user (or use 'Anonymous' if not logged in)
            const username = localStorage.getItem('username') || localStorage.getItem('currentUser') || 'Anonymous';

            // Create new review
            const newReview = {
                productId: currentProduct._id,
                username: username,
                rating: currentRating,
                text: reviewText,
                date: new Date().toISOString()
            };

            // Add to reviews array
            reviews.unshift(newReview);

            // Save to localStorage
            saveReviews();

            // Reset form
            document.getElementById('review-text').value = '';
            setRating(0);

            // Re-render reviews
            renderReviews();
            renderProductDetails(); // Update average rating

            // Show success message
            showActionMessage('Review submitted successfully');
        }

        // Load reviews from backend API
        async function loadReviews() {
            try {
                // Try to load from API first
                const response = await fetch(`https://tridex1.onrender.com/products/${currentProduct._id}/reviews`);
                if (response.ok) {
                    reviews = await response.json();
                } else {
                    console.warn('Reviews API returned:', response.status);
                    // Fallback to localStorage
                    loadReviewsFromLocalStorage();
                }
            } catch (error) {
                console.error('Error loading reviews from API:', error);
                // Fallback to localStorage if API fails
                loadReviewsFromLocalStorage();
            }
        }

        // Load reviews from localStorage as fallback
        function loadReviewsFromLocalStorage() {
            const savedReviews = localStorage.getItem('reviews_' + currentProduct._id);
            if (savedReviews) {
                try {
                    reviews = JSON.parse(savedReviews);
                } catch (e) {
                    console.error('Error parsing saved reviews:', e);
                    reviews = [];
                }
            } else {
                reviews = [];
            }
        }

        // Load color variants for the current product
        async function loadColorVariants() {
            try {
                let parentId = null;

                // Determine the parent product ID
                if (currentProduct.isParentProduct) {
                    parentId = currentProduct._id;
                } else if (currentProduct.parentProduct) {
                    parentId = typeof currentProduct.parentProduct === 'object'
                        ? currentProduct.parentProduct._id
                        : currentProduct.parentProduct;
                }

                // If we have a parent ID, load variants
                if (parentId) {
                    const response = await fetch(`https://tridex1.onrender.com/products/${parentId}/variants`);
                    if (response.ok) {
                        const data = await response.json();
                        colorVariants = data.variants || [];

                        // Set selectedVariant based on URL id
                        const urlId = getProductId();

                        if (currentProduct.isParentProduct) {
                            // For parent products, select variant if URL matches one
                            selectedVariant = colorVariants.find(v => v._id === urlId) || null;
                        } else {
                            // For variants, set the current product as selected
                            selectedVariant = colorVariants.find(v => v._id === urlId) || currentProduct;
                        }

                        // Render color variants if available
                        if (colorVariants.length > 0) {
                            renderColorVariants();
                        }
                    } else {
                        console.warn('Failed to load variants:', response.status);
                        colorVariants = [];
                    }
                } else {
                    // No variants available
                    colorVariants = [];
                }
            } catch (error) {
                console.error('Error loading color variants:', error);
                colorVariants = [];
            }
        }

        // Render color variants
        function renderColorVariants() {
            const container = document.getElementById('color-variants-container');
            if (!container) return;

            // Only show if we have variants
            if (colorVariants.length === 0) {
                container.style.display = 'none';
                return;
            }

            // Show the container
            container.style.display = 'block';

            // Sort variants by color name
            const sortedVariants = [...colorVariants].sort((a, b) =>
                a.color.name.localeCompare(b.color.name));

            // Determine which variant is currently selected
            const currentVariantId = selectedVariant ? selectedVariant._id : currentProduct._id;

            // Generate HTML
            container.innerHTML = `
                <h3>Available Colors</h3>
                <div class="color-variants-list">
                    ${sortedVariants.map(variant => {
                        const isSelected = currentVariantId === variant._id;
                        const isOutOfStock = variant.inventory && !variant.inventory.inStock;

                        return `
                            <div class="color-variant-option ${isSelected ? 'selected' : ''} ${isOutOfStock ? 'out-of-stock' : ''}"
                                 data-id="${variant._id}"
                                 data-color="${variant.color.name}"
                                 ${isOutOfStock ? 'title="Out of stock"' : 'title="' + variant.color.name + '"'}>
                                <div class="color-swatch" style="background-color: ${variant.color.hexCode}"></div>
                                <div class="color-tooltip">${variant.color.name}${isOutOfStock ? ' (Out of Stock)' : ''}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            // Initialize event listeners for the newly rendered variants
            initColorVariantListeners();
        }

        // Select a color variant
        function selectColorVariant(variantId) {
            // Find the variant
            const variant = colorVariants.find(v => v._id === variantId);
            if (!variant) {
                console.error('Variant not found:', variantId);
                return;
            }

            // Prevent selecting out-of-stock variants
            if (variant.inventory && !variant.inventory.inStock) {
                showActionMessage('This color variant is out of stock', 'error');
                return;
            }

            // Update selected variant
            selectedVariant = variant;

            // Update URL without reloading the page
            const url = new URL(window.location.href);
            url.searchParams.set('id', variantId);
            window.history.pushState({}, '', url);

            // Update current product to the selected variant
            currentProduct = variant;

            // Re-render the product details with new variant data
            renderProductDetails();

            // Re-render color variants to update selection
            renderColorVariants();

            // Re-initialize product gallery if the variant has different media
            if (variant.media && variant.media.length > 0) {
                initProductGallery();
            }

            // Show feedback to user
            showActionMessage(`Switched to ${variant.color.name}`);
        }

        // Initialize color variant event listeners
        function initColorVariantListeners() {
            const container = document.getElementById('color-variants-container');
            if (!container) return;

            // Add event listeners to all color variant options
            container.querySelectorAll('.color-variant-option:not(.out-of-stock)').forEach(option => {
                option.addEventListener('click', function() {
                    const variantId = this.getAttribute('data-id');
                    selectColorVariant(variantId);
                });
            });
        }

        // Save reviews to localStorage
        function saveReviews() {
            // Get all reviews
            const allReviews = JSON.parse(localStorage.getItem('productReviews')) || [];

            // Remove current product reviews
            const otherReviews = allReviews.filter(review => review.productId !== currentProduct._id);

            // Add updated reviews
            const updatedReviews = [...reviews, ...otherReviews];

            // Save back to localStorage
            localStorage.setItem('productReviews', JSON.stringify(updatedReviews));
        }

        // Calculate average rating
        function calculateAverageRating() {
            if (reviews.length === 0) return 0;

            const sum = reviews.reduce((total, review) => total + review.rating, 0);
            return sum / reviews.length;
        }

        // Generate star rating HTML
        function generateStarRating(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i - 0.5 <= rating) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            return stars;
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Function to navigate to another product
        function navigateToProduct(productId) {
            // Save current page state before navigating
            history.pushState({ page: 'product-details', id: getProductId() }, '', window.location.href);

            // Navigate to the new product
            window.location.href = `product-details.html?id=${productId}`;
        }

        // Generate product highlights from description
        function generateHighlights(description) {
            // In a real app, highlights would be a separate field
            // For demo, we'll extract sentences from the description
            if (!description) return ['No highlights available'];

            const sentences = description.split(/[.!?]+/).filter(s => s.trim().length > 0);

            if (sentences.length <= 1) {
                // If description is too short, create generic highlights
                return [
                    'High quality product',
                    'Durable and long-lasting',
                    'Value for money'
                ];
            }

            // Return up to 4 sentences as highlights
            return sentences.slice(0, 4).map(s => s.trim());
        }

        // Show action message
        function showActionMessage(message, type = 'success') {
            const msgElement = document.getElementById('product-action-msg');
            msgElement.textContent = message;
            msgElement.style.display = 'block';

            if (type === 'error') {
                msgElement.style.backgroundColor = 'rgba(220, 53, 69, 0.9)';
            } else {
                msgElement.style.backgroundColor = 'rgba(40, 167, 69, 0.9)';
            }

            setTimeout(() => {
                msgElement.style.opacity = '0';
                setTimeout(() => {
                    msgElement.style.display = 'none';
                    msgElement.style.opacity = '1';
                }, 500);
            }, 2000);
        }

        // Handle browser back button
        window.addEventListener('popstate', function(event) {
            // If we're navigating back from this page, redirect to the previous page
            if (event.state === null) {
                window.location.href = document.referrer || 'index.html';
            }
        });

        // Initialize the page
        initProductPage();

        // Add the current page to browser history with state
        if (history.state === null) {
            history.replaceState({ page: 'product-details', id: getProductId() }, '', window.location.href);
        }
    </script>
</body>
</html>
