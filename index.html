<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Tridex</title>
   <link rel="stylesheet" href="style.css">
   <link rel="stylesheet" href="chatbot.css">
   <!-- Include the ban system script -->
   <script src="ban-system.js"></script>
   <!-- Include enhanced chatbot scripts -->
   <script src="chatbot.js" defer></script>
   <script src="chatbot-ai.js" defer></script>
   <style>
       /* Responsive Navbar */
       @media (max-width: 900px) {
           header > div {
               flex-direction: column;
               align-items: flex-start !important;
           }
           nav ul {
               gap: 10px !important;
           }
           .search-bar {
               max-width: 98vw !important;
           }
       }
       @media (max-width: 600px) {
           header > div {
               flex-direction: column;
               align-items: flex-start !important;
               padding: 0 8px;
           }
           h1 {
               font-size: 1.5rem !important;
               margin-bottom: 8px !important;
           }
           nav ul {
               flex-wrap: wrap;
               gap: 6px !important;
               font-size: 0.98em;
           }
           .search-bar {
               flex-direction: column !important;
               max-width: 100vw !important;
               margin: 10px 0 0 0 !important;
               position: relative !important;
           }
           .search-bar input {
               border-radius: 5px !important;
               margin-bottom: 0;
               padding-right: 38px !important;
           }
           .search-bar button {
               border-radius: 5px !important;
               width: auto;
               position: absolute !important;
               right: 8px;
               top: 50%;
               transform: translateY(-50%);
               padding: 0 !important;
               background: none !important;
               box-shadow: none !important;
               height: 32px;
               min-width: 32px;
               display: flex;
               align-items: center;
               justify-content: center;
           }
           .search-bar .search-icon {
               font-size: 1.2em;
               color: #007bff;
           }
           #username-display {
               font-size: 0.98em !important;
           }
       }
       @media (max-width: 420px) {
           h1 {
               font-size: 1.1rem !important;
           }
           nav ul {
               font-size: 0.9em;
           }
           .product-card h3, .product-card p {
               font-size: 0.95em;
           }
       }
       /* Responsive Product Grid */
       .product-grid {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
           gap: 18px;
           padding: 24px 12px;
           max-width: 1200px;
           margin: 0 auto;
       }
       .product-card {
           background: #fff;
           border-radius: 8px;
           box-shadow: 0 2px 8px rgba(0,0,0,0.08);
           padding: 18px 12px;
           text-align: center;
           transition: box-shadow 0.2s;
       }
       .product-card img {
           width: 100%;
           height: 180px;
           object-fit: contain;
           margin-bottom: 10px;
           border-radius: 6px;
           background-color: #f9f9f9;
           padding: 8px;
       }
       .product-card:hover {
           box-shadow: 0 4px 16px rgba(0,0,0,0.13);
       }
       .product-image-container {
           height: 180px;
           display: flex;
           align-items: center;
           justify-content: center;
           margin-bottom: 10px;
       }
       /* Responsive logout button */
       @media (max-width: 600px) {
           #logout-btn {
               top: 8px !important;
               right: 8px !important;
               font-size: 0.95rem !important;
               padding: 6px 12px !important;
           }
       }
       #nav {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 18px;
    list-style: none;
    margin: 0;
    padding: 0;
    background: none;
    position: static;
    width: auto;
}
.hamburger {
    display: none;
    flex-direction: column;
    justify-content: center;
    width: 36px;
    height: 36px;
    cursor: pointer;
    margin-left: 8px;
    z-index: 1001;
}
.hamburger span {
    height: 4px;
    width: 100%;
    background: #fff;
    margin: 4px 0;
    border-radius: 2px;
    transition: 0.3s;
    display: block;
}
@media (max-width: 900px) {
    .hamburger { display: flex; }
    #nav {
        display: none;
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0 !important;
        background: #222;
        position: absolute;
        top: 60px;
        left: 0;
        width: 100vw;
        padding: 0;
        z-index: 1000;
        box-shadow: 0 4px 16px rgba(0,0,0,0.13);
    }
    #nav.show {
        display: flex !important;
    }
    #nav li {
        width: 100%;
        border-bottom: 1px solid #333;
        padding: 12px 18px;
        text-align: left;
        position: relative; /* Ensure proper positioning for notification badges */
    }
    #nav li:last-child {
        border-bottom: none;
    }
    nav ul li a {
        width: 100%;
        display: block;
        color: #fff !important;
        text-decoration: none;
        text-align: left;
        font-size: 1em !important; /* Make nav text and icons smaller */
        padding: 8px 0;
    }
    .nav-icon {
        font-size: 1.1em !important; /* Make nav icons smaller in hamburger */
    }
    /* Ensure notification badges are visible in mobile menu */
    #mail-count, #cart-count {
        position: absolute !important;
        top: 12px !important;
        right: 18px !important;
        z-index: 1001 !important;
    }
    /* Ensure dropdown menus appear properly in mobile view */
    .dropdown-menu {
        position: fixed !important;
        top: 120px !important;
        right: 20px !important;
        z-index: 1002 !important;
    }
}
@media (max-width: 600px) {
    /* ...existing code... */
    .hamburger { margin-bottom: 8px; }
}
   </style>
</head>
<body>
    <!-- Loading animation overlay -->
    <div id="loading-overlay" style="display:flex; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:99999; align-items:center; justify-content:center;">
        <div style="border:6px solid #f3f3f3; border-top:6px solid #007bff; border-radius:50%; width:48px; height:48px; animation:spin 1s linear infinite;"></div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
   <header style="background-color: #333; color: white; padding: 15px 0; position:relative;">
       <div style="display:flex; align-items:center; justify-content:space-between; padding:0 15px;">
           <div style="display:flex; align-items:center;">
               <h1>Tridex</h1>
               <span id="username-display"></span>
           </div>

           <!-- Hamburger icon for mobile -->
           <button id="hamburger-menu" style="background:none; border:none; cursor:pointer; display:none; padding:10px; z-index:1000;">
               <div style="width:30px; height:3px; background-color:white; margin:6px 0; transition:0.4s;"></div>
               <div style="width:30px; height:3px; background-color:white; margin:6px 0; transition:0.4s;"></div>
               <div style="width:30px; height:3px; background-color:white; margin:6px 0; transition:0.4s;"></div>
           </button>

           <nav id="main-nav" style="display:flex;">
               <ul id="nav" style="display:flex; list-style:none; margin:0; padding:0; align-items:center;">
                   <li class="nav"><a href="index.html">Home</a></li>
                   <li class="nav"><a href="about.html">About</a></li>
                   <li class="nav"><a href="more.html">More</a></li>
                   <li class="nav"><a href="contact.html">Contact Us</a></li>
                   <li>
                       <a href="#" class="nav-icon" id="userIcon" style="position: relative;">
                           <img id="nav-profile-picture" src="" alt="Profile" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover; display: none; border: 2px solid #fff;">
                           <span id="nav-profile-placeholder" style="font-size: 1.3em;">üë§</span>
                       </a>
                   </li>
                   <li>
                       <a href="#" class="nav-icon" id="mailIcon" title="Mailbox">
                           &#9993;
                           <span id="mail-count">0</span>
                       </a>
                   </li>
                   <li>
                       <a href="cart.html" class="nav-icon" id="cartIcon" title="Cart">
                           üõí<span id="cart-count">0</span>
                       </a>
                   </li>
               </ul>
           </nav>
       </div>
       <form class="search-bar" id="search-form">
           <input type="text" id="search-input" placeholder="Search...">
           <button type="submit">
               <span class="search-icon">üîç</span>
           </button>
       </form>
       <div class="dropdown-menu" id="userDropdown" style="display:none;">
           <a href="login.html" class="dropdown-btn">Login</a>
           <a href="signup.html" class="dropdown-btn">Sign Up</a>
       </div>
   </header>

   <!-- Category Navigation -->
   <div class="category-nav" style="padding:20px 0; background:#f4f4f9; text-align:center; overflow-x:auto; white-space:nowrap; scrollbar-width:none; -ms-overflow-style:none;">
       <div style="max-width:1200px; margin:0 auto; padding:0 15px;">
           <h2 style="margin-bottom:15px; color:#333; font-size:1.5rem; text-align:center;">Shop by Category</h2>
           <div id="category-icons" style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap;">
               <!-- Category icons will be rendered here by JS -->
               <div class="category-loading" style="text-align:center; padding:20px;">
                   <div style="display:inline-block; border:3px solid #f3f3f3; border-top:3px solid #007bff; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite;"></div>
                   <p style="margin-top:10px; color:#666;">Loading categories...</p>
               </div>
           </div>
       </div>
   </div>

   <section class="product-grid" id="product-grid">
       <!-- Product cards will be rendered here by JS -->
   </section>

   <style>
       /* Category Navigation Styles */
       .category-item {
           display: flex;
           flex-direction: column;
           align-items: center;
           cursor: pointer;
           transition: transform 0.3s ease;
           padding: 10px;
           min-width: 100px;
       }

       .category-item:hover {
           transform: translateY(-5px);
       }

       .category-icon {
           width: 80px;
           height: 80px;
           border-radius: 50%;
           background: #fff;
           display: flex;
           align-items: center;
           justify-content: center;
           margin-bottom: 8px;
           box-shadow: 0 4px 10px rgba(0,0,0,0.1);
           overflow: hidden;
           transition: all 0.3s ease;
           border: 2px solid #e0e0e0;
       }

       .category-icon img {
           width: 100%;
           height: 100%;
           object-fit: cover;
           border-radius: 50%;
       }

       .category-item:hover .category-icon {
           box-shadow: 0 6px 15px rgba(0,123,255,0.3);
           border-color: #007bff;
       }

       .category-name {
           font-size: 0.9rem;
           color: #333;
           margin-top: 5px;
           text-align: center;
           font-weight: 500;
       }

       /* Hide scrollbar but keep functionality */
       .category-nav::-webkit-scrollbar {
           display: none;
       }

       @media (max-width: 768px) {
           .category-icon {
               width: 70px;
               height: 70px;
           }

           .category-name {
               font-size: 0.8rem;
           }
       }

       @media (max-width: 480px) {
           .category-icon {
               width: 60px;
               height: 60px;
           }

           .category-name {
               font-size: 0.75rem;
           }

           .category-nav {
               padding: 15px 0;
           }
       }
   </style>

    <!-- Ban popup for banned users -->
    <div id="ban-message" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999999; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:280px; max-width:90%; text-align:center;">
            <div style="margin-bottom:10px; font-size:3em; color:#d32f2f;">‚ö†Ô∏è</div>
            <h2 style="margin-bottom:10px; color:#d32f2f; font-size:1.5em;">Account Banned</h2>
            <p style="margin-bottom:24px; font-size:1.1em; color:#555; line-height:1.5;">Your account has been banned by the administrator. You no longer have access to this site.</p>
            <p style="margin-bottom:24px; font-size:0.9em; color:#777;">For more information, please contact support.</p>
            <button id="ban-ok-btn" style="padding:10px 24px; background:#dc3545; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer; font-weight:bold; transition:all 0.2s ease;">OK</button>
        </div>
    </div>

    <script>
        // Add click handler for the ban message OK button
        document.addEventListener('DOMContentLoaded', function() {
            const banOkBtn = document.getElementById('ban-ok-btn');
            if (banOkBtn) {
                banOkBtn.addEventListener('click', function() {
                    // Clear all login data
                    localStorage.removeItem('token');
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('username');
                    localStorage.removeItem('currentUser');

                    // Allow scrolling again
                    document.body.style.overflow = '';

                    // Redirect to login page with banned parameter
                    window.location.href = 'login.html?banned=true';
                });
            }
        });
    </script>
    <!-- Mailbox Modal -->
    <div id="mailbox-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:320px; max-width:90vw;">
            <h2 style="margin-top:0;">Mailbox</h2>
            <div id="mailbox-messages" style="max-height:300px; overflow-y:auto; margin-bottom:18px;"></div>
            <button id="close-mailbox" style="padding:8px 18px; background:#007bff; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer;">Close</button>
        </div>
    </div>
    <!-- Enhanced Chatbot Widget with Responsive Design -->
    <div id="chatbot-widget" style="position:fixed; bottom:80px; right:24px; z-index:5000;">
        <button id="chatbot-toggle" style="background:#007bff; color:#fff; border:none; border-radius:50%; width:56px; height:56px; font-size:2em; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.2); transition:all 0.3s ease;">üí¨</button>
        <div id="chatbot-box" style="display:none; width:350px; max-width:calc(100vw - 48px); background:#fff; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.2); padding:0 0 12px 0; transition:all 0.3s ease; max-height:80vh;">
            <div style="background:#007bff; color:#fff; border-radius:12px 12px 0 0; padding:14px 18px; font-size:1.2em; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <span style="font-weight:600;">AI Chatbot</span>
                    <span id="chatbot-status" style="font-size:0.8em; margin-left:8px; opacity:0.8;">Online</span>
                </div>
                <button id="chatbot-close" style="background:none; border:none; color:white; font-size:1.2em; cursor:pointer; padding:0; line-height:1;">√ó</button>
            </div>
            <div id="chatbot-messages" style="height:320px; max-height:50vh; overflow-y:auto; padding:16px; scroll-behavior:smooth;"></div>
            <div id="chatbot-typing" style="display:none; padding:0 16px 8px; font-size:0.9em; color:#666;">
                <div style="display:flex; align-items:center;">
                    <div style="width:8px; height:8px; background:#007bff; border-radius:50%; margin-right:4px; animation:typing-dot 1s infinite;"></div>
                    <div style="width:8px; height:8px; background:#007bff; border-radius:50%; margin-right:4px; animation:typing-dot 1s infinite 0.2s;"></div>
                    <div style="width:8px; height:8px; background:#007bff; border-radius:50%; animation:typing-dot 1s infinite 0.4s;"></div>
                </div>
            </div>
            <form id="chatbot-form" style="display:flex; flex-wrap:wrap; border-top:1px solid #eee; padding:12px;">
                <input id="chatbot-input" type="text" placeholder="Ask me anything..." style="flex:1; min-width:150px; border:1px solid #ccc; border-radius:20px; padding:10px 16px; font-size:1em; outline:none; transition:border 0.3s ease; margin-bottom:8px;" required>
                <button type="submit" style="margin-left:8px; background:#007bff; color:#fff; border:none; border-radius:20px; padding:10px 16px; font-size:1em; cursor:pointer; transition:background 0.3s ease;">Send</button>
            </form>
            <div style="text-align:center; font-size:0.8em; color:#888; padding:0 16px;">
                <p style="margin:4px 0;">Type 'help' to see available commands</p>
            </div>
        </div>
    </div>

    <!-- Chatbot styles moved to chatbot.css -->
    </style>
    <!-- Footer (fixed at bottom) -->
    <footer style="position:fixed; left:0; bottom:0; width:100vw; background:#222; color:#fff; text-align:center; padding:12px 0; font-size:1rem; z-index:9999;">
        &copy; 2025 Tridex. All rights reserved. Made with <span style="color:#e25555;">&#10084;&#65039;</span> by Tridex.
    </footer>
    <script>
        // --- Loading overlay helper functions ---
function showLoading() {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) loadingOverlay.style.display = 'flex';
}

function hideLoading() {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) loadingOverlay.style.display = 'none';
}

// --- withLoading helper for loading overlay ---
function withLoading(action) {
    return async function(...args) {
        showLoading();
        try {
            await action(...args);
        } catch (error) {
            console.error('Error during action:', error);
        } finally {
            hideLoading();
        }
    };
}

// Add event listeners for page load/unload
window.addEventListener('load', function() {
    hideLoading();
});
window.addEventListener('beforeunload', function() {
    showLoading();
});
// --- Always hide loading overlay on any page show (including bfcache/back-forward navigation) ---
    window.addEventListener('pageshow', function() {
        hideLoading();
    });
    // As a safety net, hide loading overlay immediately in case of script errors or early navigation
    hideLoading();

// Cart count update function
function updateCartCount() {
    const cartCountElement = document.getElementById('cart-count');
    if (cartCountElement) {
        const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
        let cart = [];
        try {
            cart = JSON.parse(localStorage.getItem('cart')) || [];
        } catch (e) {
            cart = [];
        }
        cartCountElement.textContent = cart.length || '';
        cartCountElement.style.display = cart.length ? 'inline-block' : 'none';
    }
}

// --- Hamburger menu functionality ---
document.addEventListener('DOMContentLoaded', function() {
    const hamburger = document.getElementById('hamburger-menu');
    const nav = document.getElementById('nav');

    // Toggle navigation when hamburger is clicked
    hamburger.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent event from bubbling up
        nav.classList.toggle('show');

        // Animate hamburger icon to X when menu is open
        const divs = hamburger.querySelectorAll('div');
        if (nav.classList.contains('show')) {
            // X shape when menu is open
            divs[0].style.transform = 'rotate(-45deg) translate(-5px, 6px)';
            divs[1].style.opacity = '0';
            divs[2].style.transform = 'rotate(45deg) translate(-5px, -6px)';
        } else {
            // Reset to hamburger shape
            divs[0].style.transform = 'none';
            divs[1].style.opacity = '1';
            divs[2].style.transform = 'none';
        }
    });

    // Close navigation when clicking outside
    document.addEventListener('click', function(event) {
        if (!hamburger.contains(event.target) && !nav.contains(event.target) && nav.classList.contains('show')) {
            nav.classList.remove('show');

            // Reset hamburger icon
            const divs = hamburger.querySelectorAll('div');
            divs[0].style.transform = 'none';
            divs[1].style.opacity = '1';
            divs[2].style.transform = 'none';
        }
    });

    // Close navigation when window is resized
    window.addEventListener('resize', function() {
        if (window.innerWidth > 992 && nav.classList.contains('show')) {
            nav.classList.remove('show');

            // Reset hamburger icon
            const divs = hamburger.querySelectorAll('div');
            if (divs.length > 0) {
                divs[0].style.transform = 'none';
                divs[1].style.opacity = '1';
                divs[2].style.transform = 'none';
            }
        }
    });
});

// Ban check logic (must be first in script)
(function() {
    // Get the current username
    const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

    console.log('Index page loaded, checking ban status for user:', username);

    // Function to check if the user is banned
    function checkUserBan() {
        try {
            // Check if the ban system is available
            if (window.banSystem) {
                // Check if the user is banned or if there's a ban flag in sessionStorage
                if (window.banSystem.isUserBanned(username) || sessionStorage.getItem('userBanned') === 'true') {
                    console.log('User is banned or ban flag found, showing ban message');

                    // Use the ban system to handle the ban
                    window.banSystem.checkCurrentUserBan();

                    // Stop further script execution
                    throw new Error('User is banned');
                }
            } else if (sessionStorage.getItem('userBanned') === 'true') {
                // If the ban system isn't loaded yet but we have a ban flag, show a basic ban message
                console.log('Ban flag found in sessionStorage but ban system not loaded');

                // Clear all login data
                localStorage.removeItem('token');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                localStorage.removeItem('currentUser');

                // Redirect to login page with banned parameter
                window.location.href = 'login.html?banned=true';

                // Stop further script execution
                throw new Error('User is banned (from sessionStorage)');
            }
        } catch (error) {
            if (error.message.includes('User is banned')) {
                throw error; // Re-throw ban-related errors
            }
            console.error('Error checking ban status:', error);
        }
    }

    // Function to wait for the ban system to load
    function waitForBanSystem() {
        // Check if the ban system is already loaded
        if (window.banSystem) {
            checkUserBan();
            return;
        }

        console.log('Ban system not loaded yet, waiting...');

        // Set up a polling mechanism to check for the ban system
        let attempts = 0;
        const maxAttempts = 50; // 5 seconds at 100ms intervals

        const checkInterval = setInterval(function() {
            attempts++;

            if (window.banSystem) {
                console.log('Ban system loaded after', attempts, 'attempts');
                clearInterval(checkInterval);
                checkUserBan();
            } else if (attempts >= maxAttempts) {
                console.log('Ban system failed to load after', maxAttempts, 'attempts');
                clearInterval(checkInterval);

                // Check if we have a ban flag in sessionStorage even though the ban system failed to load
                if (sessionStorage.getItem('userBanned') === 'true') {
                    console.log('Ban flag found in sessionStorage but ban system failed to load');

                    // Clear all login data
                    localStorage.removeItem('token');
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('username');
                    localStorage.removeItem('currentUser');

                    // Redirect to login page with banned parameter
                    window.location.href = 'login.html?banned=true';
                }
            }
        }, 100);
    }

    // Check ban status immediately
    waitForBanSystem();

    // Also check after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking ban status again');
        checkUserBan();
    });

    // Check again after a short delay to catch any race conditions
    setTimeout(checkUserBan, 1000);

    // Check again after the page is fully loaded
    window.addEventListener('load', function() {
        console.log('Window loaded, checking ban status again');
        checkUserBan();
    });
})();

// Fix: define verifiedUsers as an empty array to prevent JS errors
const verifiedUsers = [];

// Show/hide buttons based on login status
const isLoggedIn = localStorage.getItem('isLoggedIn');
// Get username from localStorage
const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

// Display name if available (for personalization), fallback to username
if (isLoggedIn && username) {
    // Load user data to get full name and profile picture
    loadUserDataForNavigation();
}

// Function to load user data for navigation display
async function loadUserDataForNavigation() {
    try {
        const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
        const token = localStorage.getItem('token');

        if (!username || !token) return;

        // Fetch user data from server to get full name and profile picture
        const response = await fetch(`https://tridex1.onrender.com/users/profile?username=${encodeURIComponent(username)}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'X-Username': username
            }
        });

        if (response.ok) {
            const userData = await response.json();

            // Display full name in welcome message (Google users show their real name)
            const displayName = userData.name || username;
            const verifiedUsers = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');

            document.getElementById('username-display').innerHTML =
                `Welcome, <span style="text-transform:uppercase; letter-spacing:0.5px; font-weight:500;">${displayName}</span> ${verifiedUsers.includes(username) ? '<span title="Verified" style="color:#1da1f2; font-size:1.1em;">‚úì</span>' : ''}`;

            // Display profile picture in navigation
            displayNavProfilePicture(userData.profilePicture);
        } else {
            // Fallback to localStorage data
            const userName = localStorage.getItem('name') || username;
            const verifiedUsers = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');

            document.getElementById('username-display').innerHTML =
                `Welcome, <span style="text-transform:uppercase; letter-spacing:0.5px; font-weight:500;">${userName}</span> ${verifiedUsers.includes(username) ? '<span title="Verified" style="color:#1da1f2; font-size:1.1em;">‚úì</span>' : ''}`;
        }
    } catch (error) {
        console.log('Could not load user data:', error);
        // Fallback to localStorage data
        const userName = localStorage.getItem('name') || username;
        const verifiedUsers = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');

        document.getElementById('username-display').innerHTML =
            `Welcome, <span style="text-transform:uppercase; letter-spacing:0.5px; font-weight:500;">${userName}</span> ${verifiedUsers.includes(username) ? '<span title="Verified" style="color:#1da1f2; font-size:1.1em;">‚úì</span>' : ''}`;
    }
}

// Function to display profile picture in navigation
function displayNavProfilePicture(profilePictureUrl) {
    const navProfilePicture = document.getElementById('nav-profile-picture');
    const navProfilePlaceholder = document.getElementById('nav-profile-placeholder');

    if (profilePictureUrl && navProfilePicture && navProfilePlaceholder) {
        navProfilePicture.src = profilePictureUrl;
        navProfilePicture.style.display = 'inline-block';
        navProfilePlaceholder.style.display = 'none';
    } else if (navProfilePicture && navProfilePlaceholder) {
        navProfilePicture.style.display = 'none';
        navProfilePlaceholder.style.display = 'inline';
    }
}
// Hide or show login/signup in dropdown and handle profile icon click
document.addEventListener('DOMContentLoaded', function() {
    const userIcon = document.getElementById('userIcon');
    const dropdown = document.getElementById('userDropdown');
    if (isLoggedIn) {
        // Remove login and signup links if logged in
        dropdown.innerHTML = '';
        // Redirect to profile page on profile icon click
        userIcon.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'profile.html';
        });
    } else {
        userIcon.addEventListener('click', function(e) {
            e.preventDefault();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
    }
    document.addEventListener('click', function(e) {
        if (!userIcon.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
});

// Redirect to login if not logged in
if (!isLoggedIn) {
    // User is not logged in
}

// --- AI-style Product Recommendations ---
function getUserProductStats() {
    // Track product views, searches, and likes in localStorage
    let stats = JSON.parse(localStorage.getItem('userProductStats') || '{}');
    return stats;
}
function saveUserProductStats(stats) {
    localStorage.setItem('userProductStats', JSON.stringify(stats));
}
function recordProductView(productId) {
    const stats = getUserProductStats();
    stats.views = stats.views || {};
    stats.views[productId] = (stats.views[productId] || 0) + 1;
    saveUserProductStats(stats);
}
function recordProductLike(productId) {
    const stats = getUserProductStats();
    stats.likes = stats.likes || {};
    stats.likes[productId] = (stats.likes[productId] || 0) + 1;
    saveUserProductStats(stats);
}
function recordProductSearch(term) {
    const stats = getUserProductStats();
    stats.searches = stats.searches || {};
    stats.searches[term] = (stats.searches[term] || 0) + 1;
    saveUserProductStats(stats);
}
function getRecommendedProducts(allProducts) {
    const stats = getUserProductStats();
    // Score products by views, likes, and search matches
    const scores = {};
    allProducts.forEach(p => {
        let score = 0;
        if (stats.views && stats.views[p._id]) score += stats.views[p._id] * 2;
        if (stats.likes && stats.likes[p._id]) score += stats.likes[p._id] * 3;
        // Search term match bonus
        if (stats.searches) {
            for (const term in stats.searches) {
                if (p.name && p.name.toLowerCase().includes(term)) score += stats.searches[term];
                if (p.desc && p.desc.toLowerCase().includes(term)) score += stats.searches[term];
            }
        }
        scores[p._id] = score;
    });
    // Sort by score, descending
    return allProducts
        .map(p => ({ ...p, _score: scores[p._id] || 0 }))
        .sort((a, b) => b._score - a._score)
        .filter(p => p._score > 0)
        .slice(0, 6); // Top 6 recommendations
}
// --- Render recommendations section ---
function renderRecommendations(allProducts) {
    const recommended = getRecommendedProducts(allProducts);
    const container = document.getElementById('recommendations-section');
    if (!container) return;
    if (!recommended.length) {
        container.innerHTML = '';
        return;
    }
    container.innerHTML = '<h2 style="margin:24px 0 12px 0; color:#007bff;">Recommended for you</h2>';
    const grid = document.createElement('div');
    grid.className = 'product-grid';
    recommended.forEach(product => {
        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `
            <div class="product-image-container">
                <img src="${product.image || ''}" alt="${product.name}" style="cursor:pointer;" data-id="${product._id}">
            </div>
            <h3>${product.name}</h3>
            <p>‚Çπ${product.price}</p>
        `;
        div.querySelector('img').onclick = function(e) {
            recordProductView(product._id);
            history.pushState({ page: 'index', scrollPos: window.scrollY }, '', window.location.href);
            window.location.href = `product-details.html?id=${product._id}`;
        };
        grid.appendChild(div);
    });
    container.appendChild(grid);
}
// --- Patch product rendering to record views/likes/searches ---
function renderProducts(products) {
    try {
        const grid = document.getElementById('product-grid');
        grid.innerHTML = '';
        if (!products || products.length === 0) {
            grid.innerHTML = '<div style="text-align:center; color:#888; font-size:1.2em; padding:32px 0;">No results found.</div>';
            return;
        }
        products.forEach(product => {
            try {
                const div = document.createElement('div');
                div.className = 'product-card';
                div.innerHTML = `
                    <div class="product-image-container">
                        <img src="${product.image || ''}" alt="${product.name}" style="cursor:pointer;" data-id="${product._id}">
                    </div>
                    <h3>${product.name}</h3>
                    <p>‚Çπ${product.price}</p>
                `;
                div.querySelector('img').onclick = function(e) {
                    recordProductView(product._id);
                    history.pushState({ page: 'index', scrollPos: window.scrollY }, '', window.location.href);
                    window.location.href = `product-details.html?id=${product._id}`;
                };
                grid.appendChild(div);
            } catch (err) {
                console.error('Error rendering product:', product, err);
            }
        });
    } catch (err) {
        console.error('Error in renderProducts:', err);
        document.getElementById('product-grid').innerHTML = '<div style="text-align:center; color:#888; font-size:1.2em; padding:32px 0;">Failed to render products.<br>' + err + '</div>';
    }
}
// Patch search form to record searches
const searchForm = document.getElementById('search-form');
if (searchForm) {
    searchForm.onsubmit = function(e) {
        e.preventDefault();
        const filter = document.getElementById('search-input').value.trim().toLowerCase();
        if (filter) recordProductSearch(filter);
        fetchAndRenderProducts(filter);
    };
}
// --- Render recommendations on page load ---
let allProductsCache = [];
async function fetchAndRenderProducts(filter = "") {
    try {
        const res = await fetch('https://tridex1.onrender.com/products');
        let products = await res.json();
        allProductsCache = products;
        const filtered = products.filter(product =>
            !filter ||
            product.name.toLowerCase().includes(filter.toLowerCase()) ||
            (product.desc && product.desc.toLowerCase().includes(filter.toLowerCase()))
        );
        renderProducts(filtered);
        renderRecommendations(products);
    } catch (e) {
        document.getElementById('product-grid').innerHTML = `<div style="text-align:center; color:#888; font-size:1.2em; padding:32px 0;">Unable to load products at this time.</div>`;
    } finally {
        hideLoading();
    }
}

    // Add a recommendations section above the product grid
    const recommendationsSection = document.createElement('section');
    recommendationsSection.id = 'recommendations-section';
    const productGrid = document.getElementById('product-grid');
    productGrid.parentNode.insertBefore(recommendationsSection, productGrid);

    // Initial render
    fetchAndRenderProducts();

    // Handle browser back button navigation
    window.addEventListener('popstate', function(event) {
        if (event.state && event.state.page === 'index') {
            // Restore scroll position if available
            if (event.state.scrollPos) {
                setTimeout(() => {
                    window.scrollTo(0, event.state.scrollPos);
                }, 100);
            }
        }
    });

    // Cart icon click
    document.getElementById('cartIcon').onclick = withLoading(function(e) {
        e.preventDefault();
        window.location.href = 'cart.html';
    });

    // Mailbox open
    document.getElementById('mailIcon').onclick = withLoading(async function(e) {
        e.preventDefault();

        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const hasToken = localStorage.getItem('token');
        const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

        // If we have a token but no isLoggedIn flag, set it
        if (hasToken && !isLoggedIn) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // Check login status after potential update
        const isActuallyLoggedIn = localStorage.getItem('isLoggedIn') || hasToken;

        if (!isActuallyLoggedIn) {
            alert('You must login to view your mailbox.');
            window.location.href = 'login.html';
            return;
        }

        // Fetch announcements from server including user-specific ones
        let messages = [];
        try {
            const response = await fetch(`https://tridex1.onrender.com/announcements?username=${encodeURIComponent(username)}`);
            if (response.ok) {
                messages = await response.json();
            } else {
                console.error('Failed to fetch announcements:', response.status);
                // Fallback to local storage if server fetch fails
                messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
            }
        } catch (e) {
            console.error('Error fetching announcements:', e);
            // Fallback to local storage
            messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
        }

        const lastSeenKey = username ? `mailLastSeen_${username}` : 'mailLastSeen_guest';
        localStorage.setItem(lastSeenKey, messages.length);
        updateMailCount();

        const mailbox = document.getElementById('mailbox-modal');
        const messagesDiv = document.getElementById('mailbox-messages');

        if (messages.length === 0) {
            messagesDiv.innerHTML = '<p style="color:#888;">No messages.</p>';
        } else {
            messagesDiv.innerHTML = messages.map(msg => {
                // Check if it's a welcome message
                const isWelcomeMessage = msg.isWelcomeMessage;
                // Only show the special styling and "Mark as Read" button if it hasn't been read
                const isUnreadWelcome = isWelcomeMessage && !msg.isRead;
                const welcomeClass = isUnreadWelcome ? 'welcome-message' : '';
                const welcomeStyle = isUnreadWelcome ? 'background-color:#f8f9fa; border-left:4px solid #28a745; padding-left:12px;' : '';

                return `
                    <div class="message-item ${welcomeClass}" data-id="${msg._id}" style="border-bottom:1px solid #eee; padding:12px 0; ${welcomeStyle}">
                        <strong>${msg.title || 'Announcement'}</strong>
                        <div style="font-size:0.97em; margin-top:4px;">${msg.message || msg.body}</div>
                        <div style="font-size:0.85em; color:#888; margin-top:2px; display:flex; justify-content:space-between;">
                            <span>${new Date(msg.createdAt).toLocaleString() || msg.date || ''}</span>
                            ${isUnreadWelcome ?
                                `<button class="mark-read-btn" data-id="${msg._id}" style="background:#28a745; color:white; border:none; border-radius:4px; padding:2px 8px; cursor:pointer; font-size:0.9em;">Mark as Read</button>`
                                : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners to "Mark as Read" buttons
            const markReadButtons = document.querySelectorAll('.mark-read-btn');
            markReadButtons.forEach(button => {
                button.addEventListener('click', async function(e) {
                    e.stopPropagation(); // Prevent event bubbling

                    const messageId = this.getAttribute('data-id');
                    try {
                        const response = await fetch(`https://tridex1.onrender.com/announcements/${messageId}/read`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            // Remove the welcome message styling
                            const messageItem = this.closest('.message-item');
                            messageItem.classList.remove('welcome-message');
                            messageItem.style.backgroundColor = '';
                            messageItem.style.borderLeft = '';
                            messageItem.style.paddingLeft = '';

                            // Remove the button
                            this.remove();

                            // Update the count
                            updateMailCount();
                        } else {
                            console.error('Failed to mark message as read:', response.status);
                        }
                    } catch (error) {
                        console.error('Error marking message as read:', error);
                    }
                });
            });
        }

        mailbox.style.display = 'flex';
    });

    // Close mailbox
    document.getElementById('close-mailbox').onclick = withLoading(function() {
        document.getElementById('mailbox-modal').style.display = 'none';
    });



    // Mail notification count logic
    async function updateMailCount() {
        // Check login status with both methods
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const hasToken = localStorage.getItem('token');
        const isActuallyLoggedIn = isLoggedIn || hasToken;

        // Use username from either source
        const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

        // If we have a token but no isLoggedIn flag, set it
        if (hasToken && !isLoggedIn) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // If not logged in, hide the mail count
        const mailCount = document.getElementById('mail-count');
        if (!isActuallyLoggedIn || !username) {
            mailCount.style.display = 'none';
            return;
        }

        // Try to fetch from server first
        let messages = [];
        let unreadCount = 0;

        try {
            const response = await fetch(`https://tridex1.onrender.com/announcements?username=${encodeURIComponent(username)}`);
            if (response.ok) {
                messages = await response.json();

                // Count unread welcome messages that are specifically for this user
                unreadCount = messages.filter(msg =>
                    msg.isWelcomeMessage &&
                    !msg.isRead &&
                    msg.forUser === username
                ).length;

                // Store the messages in localStorage for offline access
                localStorage.setItem('adminMessages', JSON.stringify(messages));
            } else {
                console.error('Failed to fetch announcements for count:', response.status);
                // Fallback to local storage
                messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
            }
        } catch (e) {
            console.error('Error fetching announcements for count:', e);
            // Fallback to local storage
            try {
                messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
            } catch (e) {
                messages = [];
            }
        }

        // If we didn't get unread count from server, calculate from local storage
        if (unreadCount === 0) {
            const lastSeenKey = username ? `mailLastSeen_${username}` : 'mailLastSeen_guest';
            const lastSeen = Number(localStorage.getItem(lastSeenKey) || 0);
            unreadCount = Math.max(messages.length - lastSeen, 0);
        }

        // Update the badge
        if (unreadCount > 0) {
            mailCount.textContent = unreadCount;
            mailCount.style.display = '';
        } else {
            mailCount.style.display = 'none';
        }
    }
    updateMailCount();

    // This mailbox click handler is now handled above with the enhanced implementation

    // Fix: Ensure close button works even if DOMContentLoaded is not fired yet
    document.getElementById('close-mailbox').onclick = function() {
        document.getElementById('mailbox-modal').style.display = 'none';
    };

    // Update mail count when messages change (from other tabs)
    window.addEventListener('storage', function(e) {
        if (e.key === 'adminMessages') updateMailCount();
    });

        // Chatbot logic moved to chatbot.js and chatbot-ai.js
        // The chatbot will be initialized when the DOM is fully loaded

        // Cart icon logic
    function updateCartCount() {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        // Check for token as well (for backward compatibility)
        const hasToken = localStorage.getItem('token');
        // Use username from either source
        const username = localStorage.getItem('currentUser') || localStorage.getItem('username');

        // If we have a token but no isLoggedIn flag, set it
        if (hasToken && !isLoggedIn) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // If we have a username but no currentUser, set it
        if (localStorage.getItem('username') && !localStorage.getItem('currentUser')) {
            localStorage.setItem('currentUser', localStorage.getItem('username'));
        }

        // Recheck login status after potential updates
        const isActuallyLoggedIn = localStorage.getItem('isLoggedIn') || hasToken;

        if (!isActuallyLoggedIn || !username) {
            document.getElementById('cart-count').style.display = 'none';
            return;
        }
        // Ensure cart is isolated per user
        const cartUser = localStorage.getItem('cartUser');
        if (cartUser !== username) {
            const userCart = localStorage.getItem('cart_' + username);
            if (userCart) {
                localStorage.setItem('cart', userCart);
            } else {
                localStorage.removeItem('cart');
            }
            localStorage.setItem('cartUser', username);
        }
        let cart = [];
        try { cart = JSON.parse(localStorage.getItem('cart')) || []; } catch (e) { cart = []; }
        const count = cart.length;
        const cartCount = document.getElementById('cart-count');
        if (count > 0) {
            cartCount.textContent = count;
            cartCount.style.display = '';
        } else {
            cartCount.style.display = 'none';
        }
    }
    updateCartCount();

    // Listen for cart changes from other tabs/windows
    window.addEventListener('storage', function(e) {
        if (e.key === 'cart') updateCartCount();
    });

    // Cart icon click: show cart page or popup (redirect to cart.html)
    document.getElementById('cartIcon').onclick = function(e) {
        e.preventDefault();
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const hasToken = localStorage.getItem('token');

        // If we have a token but no isLoggedIn flag, set it
        if (hasToken && !isLoggedIn) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // Check login status after potential update
        const isActuallyLoggedIn = localStorage.getItem('isLoggedIn') || hasToken;

        if (!isActuallyLoggedIn) {
            alert('You must login to view your cart.');
            window.location.href = 'login.html';
            return;
        }

        window.location.href = 'cart.html';
    };

    // Simple hamburger menu implementation
    document.addEventListener('DOMContentLoaded', function() {
        const hamburger = document.getElementById('hamburger-menu');
        const nav = document.getElementById('main-nav');

        // Function to check window size and adjust menu visibility
        function checkWindowSize() {
            if (window.innerWidth <= 768) {
                // Mobile view
                hamburger.style.display = 'block';
                nav.style.display = 'none';
            } else {
                // Desktop view
                hamburger.style.display = 'none';
                nav.style.display = 'flex';
            }
        }

        // Initial check
        checkWindowSize();

        // Check on window resize
        window.addEventListener('resize', checkWindowSize);

        // Toggle menu when hamburger is clicked
        hamburger.addEventListener('click', function() {
            if (nav.style.display === 'none' || nav.style.display === '') {
                nav.style.display = 'flex';
                nav.style.position = 'absolute';
                nav.style.top = '60px';
                nav.style.left = '0';
                nav.style.width = '100%';
                nav.style.backgroundColor = '#333';
                nav.style.flexDirection = 'column';
                nav.style.zIndex = '1000';

                // Make the nav items stack vertically
                document.getElementById('nav').style.flexDirection = 'column';
                document.getElementById('nav').style.width = '100%';

                // Add some styling to nav items
                const navItems = document.querySelectorAll('#nav li');
                navItems.forEach(item => {
                    item.style.width = '100%';
                    item.style.textAlign = 'left';
                    item.style.padding = '10px 0';
                    item.style.borderBottom = '1px solid #444';
                    item.style.position = 'relative'; // Ensure proper positioning for notification badges
                });

                // Ensure notification badges are visible
                const mailCount = document.getElementById('mail-count');
                const cartCount = document.getElementById('cart-count');

                if (mailCount) {
                    mailCount.style.position = 'absolute';
                    mailCount.style.right = '18px';
                    mailCount.style.top = '12px';
                    mailCount.style.zIndex = '1001';
                }

                if (cartCount) {
                    cartCount.style.position = 'absolute';
                    cartCount.style.right = '18px';
                    cartCount.style.top = '12px';
                    cartCount.style.zIndex = '1001';
                }
            } else {
                nav.style.display = 'none';
            }
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768 &&
                nav.style.display === 'flex' &&
                !nav.contains(event.target) &&
                event.target !== hamburger &&
                !hamburger.contains(event.target)) {
                nav.style.display = 'none';
            }
        });
    });

    // --- Category Navigation: Fetch and Render Categories ---
document.addEventListener('DOMContentLoaded', function() {
    const categoryIcons = document.getElementById('category-icons');
    if (!categoryIcons) return;
    // Show loading spinner
    categoryIcons.innerHTML = `<div class="category-loading" style="text-align:center; padding:20px;">
        <div style="display:inline-block; border:3px solid #f3f3f3; border-top:3px solid #007bff; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:10px; color:#666;">Loading categories...</p>
    </div>`;
    fetch('https://tridex1.onrender.com/categories')
        .then(res => res.json())
        .then(categories => {
            if (!Array.isArray(categories) || categories.length === 0) {
                categoryIcons.innerHTML = '<p style="color:#888;">No categories found.</p>';
                return;
            }
            categoryIcons.innerHTML = '';
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'category-item';
                div.title = cat.name;
                div.innerHTML = `
                    <div class="category-icon">
                        <img src="${cat.icon || 'https://img.icons8.com/ios-filled/50/000000/category.png'}" alt="${cat.name}">
                    </div>
                    <span class="category-name">${cat.name}</span>
                `;
                div.onclick = function() {
                    // Filter products by category
                    fetchAndRenderProductsByCategory(cat.name);
                };
                categoryIcons.appendChild(div);
            });
        })
        .catch(err => {
            categoryIcons.innerHTML = '<p style="color:#d32f2f;">Failed to load categories.</p>';
            console.error('Error loading categories:', err);
        });
});

// Helper: fetch and render products by category
function fetchAndRenderProductsByCategory(categoryName) {
    showLoading();
    fetch('https://tridex1.onrender.com/products?category=' + encodeURIComponent(categoryName))
        .then(res => res.json())
        .then(products => {
            renderProducts(products);
            renderRecommendations(products);
        })
        .catch(e => {
            document.getElementById('product-grid').innerHTML = `<div style="text-align:center; color:#888; font-size:1.2em; padding:32px 0;">Unable to load products for this category.</div>`;
        })
        .finally(() => hideLoading());
}
    </script>
</body>
</html>