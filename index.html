<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Tridex</title>
   <link rel="stylesheet" href="style.css">
   <!-- Include the ban system script -->
   <script src="ban-system.js"></script>
   <style>
       /* Responsive Navbar */
       @media (max-width: 900px) {
           header > div {
               flex-direction: column;
               align-items: flex-start !important;
           }
           nav ul {
               gap: 10px !important;
           }
           .search-bar {
               max-width: 98vw !important;
           }
       }
       @media (max-width: 600px) {
           header > div {
               flex-direction: column;
               align-items: flex-start !important;
               padding: 0 8px;
           }
           h1 {
               font-size: 1.5rem !important;
               margin-bottom: 8px !important;
           }
           nav ul {
               flex-wrap: wrap;
               gap: 6px !important;
               font-size: 0.98em;
           }
           .search-bar {
               flex-direction: column !important;
               max-width: 100vw !important;
               margin: 10px 0 0 0 !important;
               position: relative !important;
           }
           .search-bar input {
               border-radius: 5px !important;
               margin-bottom: 0;
               padding-right: 38px !important;
           }
           .search-bar button {
               border-radius: 5px !important;
               width: auto;
               position: absolute !important;
               right: 8px;
               top: 50%;
               transform: translateY(-50%);
               padding: 0 !important;
               background: none !important;
               box-shadow: none !important;
               height: 32px;
               min-width: 32px;
               display: flex;
               align-items: center;
               justify-content: center;
           }
           .search-bar .search-icon {
               font-size: 1.2em;
               color: #007bff;
           }
           #username-display {
               font-size: 0.98em !important;
           }
       }
       @media (max-width: 420px) {
           h1 {
               font-size: 1.1rem !important;
           }
           nav ul {
               font-size: 0.9em;
           }
           .product-card h3, .product-card p {
               font-size: 0.95em;
           }
       }
       /* Responsive Product Grid */
       .product-grid {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
           gap: 18px;
           padding: 24px 12px;
           max-width: 1200px;
           margin: 0 auto;
       }
       .product-card {
           background: #fff;
           border-radius: 8px;
           box-shadow: 0 2px 8px rgba(0,0,0,0.08);
           padding: 18px 12px;
           text-align: center;
           transition: box-shadow 0.2s;
       }
       .product-card img {
           width: 100%;
           height: 180px;
           object-fit: contain;
           margin-bottom: 10px;
           border-radius: 6px;
           background-color: #f9f9f9;
           padding: 8px;
       }
       .product-card:hover {
           box-shadow: 0 4px 16px rgba(0,0,0,0.13);
       }
       .product-image-container {
           height: 180px;
           display: flex;
           align-items: center;
           justify-content: center;
           margin-bottom: 10px;
       }
       /* Responsive logout button */
       @media (max-width: 600px) {
           #logout-btn {
               top: 8px !important;
               right: 8px !important;
               font-size: 0.95rem !important;
               padding: 6px 12px !important;
           }
       }
       #nav {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 18px;
    list-style: none;
    margin: 0;
    padding: 0;
    background: none;
    position: static;
    width: auto;
}
.hamburger {
    display: none;
    flex-direction: column;
    justify-content: center;
    width: 36px;
    height: 36px;
    cursor: pointer;
    margin-left: 8px;
    z-index: 1001;
}
.hamburger span {
    height: 4px;
    width: 100%;
    background: #fff;
    margin: 4px 0;
    border-radius: 2px;
    transition: 0.3s;
    display: block;
}
@media (max-width: 900px) {
    .hamburger { display: flex; }
    #nav {
        display: none;
        flex-direction: column !important;
        align-items: center !important;
        gap: 0 !important;
        background: #222;
        position: absolute;
        top: 60px;
        left: 0;
        width: 100vw;
        padding: 0;
        z-index: 1000;
        box-shadow: 0 4px 16px rgba(0,0,0,0.13);
    }
    #nav.show {
        display: flex !important;
    }
    #nav li {
        width: 100%;
        border-bottom: 1px solid #333;
        padding: 12px 18px;
        text-align: center;
    }
    #nav li:last-child {
        border-bottom: none;
    }
    nav ul li a {
        width: 100%;
        display: block;
        color: #fff !important;
        text-decoration: none;
        text-align: center;
        font-size: 1em !important; /* Make nav text and icons smaller */
    }
    .nav-icon {
        font-size: 1.1em !important; /* Make nav icons smaller in hamburger */
    }
}
@media (max-width: 600px) {
    /* ...existing code... */
    .hamburger { margin-bottom: 8px; }
}
   </style>
</head>
<body>
    <!-- Loading animation overlay -->
    <div id="loading-overlay" style="display:flex; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:99999; align-items:center; justify-content:center;">
        <div style="border:6px solid #f3f3f3; border-top:6px solid #007bff; border-radius:50%; width:48px; height:48px; animation:spin 1s linear infinite;"></div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
   <header style="background-color: #333; color: white; padding: 15px 0; position:relative;">
       <div style="display:flex; align-items:center; justify-content:space-between; padding:0 15px;">
           <div style="display:flex; align-items:center;">
               <h1>Tridex</h1>
               <span id="username-display"></span>
           </div>

           <!-- Hamburger icon for mobile -->
           <button id="hamburger-menu" style="background:none; border:none; cursor:pointer; display:none; padding:10px; z-index:1000;">
               <div style="width:30px; height:3px; background-color:white; margin:6px 0; transition:0.4s;"></div>
               <div style="width:30px; height:3px; background-color:white; margin:6px 0; transition:0.4s;"></div>
               <div style="width:30px; height:3px; background-color:white; margin:6px 0; transition:0.4s;"></div>
           </button>

           <nav id="main-nav" style="display:flex;">
               <ul id="nav" style="display:flex; list-style:none; margin:0; padding:0; align-items:center;">
                   <li class="nav"><a href="#">Home</a></li>
                   <li class="nav"><a href="about.html">About</a></li>
                   <li class="nav"><a href="#">More</a></li>
                   <li><a href="#" class="nav-icon" id="userIcon">üë§</a></li>
                   <li>
                       <a href="#" class="nav-icon" id="mailIcon" title="Mailbox">
                           &#9993;
                           <span id="mail-count">0</span>
                       </a>
                   </li>
                   <li>
                       <a href="cart.html" class="nav-icon" id="cartIcon" title="Cart">
                           üõí<span id="cart-count">0</span>
                       </a>
                   </li>
               </ul>
           </nav>
       </div>
       <form class="search-bar" id="search-form">
           <input type="text" id="search-input" placeholder="Search...">
           <button type="submit">
               <span class="search-icon">üîç</span>
           </button>
       </form>
       <div class="dropdown-menu" id="userDropdown" style="display:none;">
           <a href="login.html" class="dropdown-btn">Login</a>
           <a href="signup.html" class="dropdown-btn">Sign Up</a>
       </div>
   </header>
   <section class="product-grid" id="product-grid">
       <!-- Product cards will be rendered here by JS -->
   </section>
   <button id="logout-btn" style="position:fixed; top:16px; right:16px; padding:8px 18px; background:#007bff; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer; display:none;">
        Logout
    </button>
    <div id="logout-popup" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:260px; text-align:center;">
            <p style="margin-bottom:24px; font-size:1.1em;">Are you sure you want to logout?</p>
            <button id="popup-logout-yes" style="margin-right:16px; padding:8px 18px; background:#007bff; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer;">Yes</button>
            <button id="popup-logout-no" style="padding:8px 18px; background:#eee; color:#333; border:none; border-radius:5px; font-size:1rem; cursor:pointer;">No</button>
        </div>
    </div>
    <!-- Ban popup for banned users -->
    <div id="ban-message" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); z-index:999999; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:320px; max-width:90%; text-align:center;">
            <div style="margin-bottom:10px; font-size:3em; color:#d32f2f;">‚ö†Ô∏è</div>
            <h2 style="margin-bottom:10px; color:#d32f2f; font-size:1.5em;">Account Banned</h2>
            <p style="margin-bottom:24px; font-size:1.1em; color:#555; line-height:1.5;">Your account has been banned by the administrator. You no longer have access to this site.</p>
            <p style="margin-bottom:24px; font-size:0.9em; color:#777;">For more information, please contact support.</p>
            <button id="ban-ok-btn" style="padding:10px 24px; background:#dc3545; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer; font-weight:bold; transition:all 0.2s ease;">OK</button>
        </div>
    </div>

    <script>
        // Add click handler for the ban message OK button
        document.getElementById('ban-ok-btn').addEventListener('click', function() {
            // Clear all login data
            localStorage.removeItem('token');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            localStorage.removeItem('currentUser');

            // Redirect to login page with banned parameter
            window.location.href = 'login.html?banned=true';
        });
    </script>
    <!-- Mailbox Modal -->
    <div id="mailbox-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:320px; max-width:90vw;">
            <h2 style="margin-top:0;">Mailbox</h2>
            <div id="mailbox-messages" style="max-height:300px; overflow-y:auto; margin-bottom:18px;"></div>
            <button id="close-mailbox" style="padding:8px 18px; background:#007bff; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer;">Close</button>
        </div>
    </div>
    <!-- Enhanced Chatbot Widget -->
    <div id="chatbot-widget" style="position:fixed; bottom:80px; right:24px; z-index:5000;">
        <button id="chatbot-toggle" style="background:#007bff; color:#fff; border:none; border-radius:50%; width:56px; height:56px; font-size:2em; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.2); transition:all 0.3s ease;">üí¨</button>
        <div id="chatbot-box" style="display:none; width:350px; background:#fff; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.2); padding:0 0 12px 0; transition:all 0.3s ease; max-height:80vh;">
            <div style="background:#007bff; color:#fff; border-radius:12px 12px 0 0; padding:14px 18px; font-size:1.2em; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <span style="font-weight:600;">AI Chatbot</span>
                    <span id="chatbot-status" style="font-size:0.8em; margin-left:8px; opacity:0.8;">Online</span>
                </div>
                <button id="chatbot-close" style="background:none; border:none; color:white; font-size:1.2em; cursor:pointer; padding:0; line-height:1;">√ó</button>
            </div>
            <div id="chatbot-messages" style="height:320px; overflow-y:auto; padding:16px; scroll-behavior:smooth;"></div>
            <div id="chatbot-typing" style="display:none; padding:0 16px 8px; font-size:0.9em; color:#666;">
                <div style="display:flex; align-items:center;">
                    <div style="width:8px; height:8px; background:#007bff; border-radius:50%; margin-right:4px; animation:typing-dot 1s infinite;"></div>
                    <div style="width:8px; height:8px; background:#007bff; border-radius:50%; margin-right:4px; animation:typing-dot 1s infinite 0.2s;"></div>
                    <div style="width:8px; height:8px; background:#007bff; border-radius:50%; animation:typing-dot 1s infinite 0.4s;"></div>
                </div>
            </div>
            <form id="chatbot-form" style="display:flex; border-top:1px solid #eee; padding:12px;">
                <input id="chatbot-input" type="text" placeholder="Ask me anything..." style="flex:1; border:1px solid #ccc; border-radius:20px; padding:10px 16px; font-size:1em; outline:none; transition:border 0.3s ease;" required>
                <button type="submit" style="margin-left:8px; background:#007bff; color:#fff; border:none; border-radius:20px; padding:10px 16px; font-size:1em; cursor:pointer; transition:background 0.3s ease;">Send</button>
            </form>
            <div style="text-align:center; font-size:0.8em; color:#888; padding:0 16px;">
                <p style="margin:4px 0;">Type 'help' to see available commands</p>
            </div>
        </div>
    </div>

    <style>
        @keyframes typing-dot {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Chatbot message styles */
        .user-message {
            background: #f1f8ff;
            border-radius: 18px 18px 0 18px;
            padding: 10px 14px;
            margin: 8px 0;
            max-width: 80%;
            align-self: flex-end;
            margin-left: auto;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .bot-message {
            background: #f0f0f0;
            border-radius: 18px 18px 18px 0;
            padding: 10px 14px;
            margin: 8px 0;
            max-width: 80%;
            align-self: flex-start;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .suggestion-chip {
            background: #e3f2fd;
            color: #007bff;
            border: 1px solid #b3e0ff;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-chip:hover {
            background: #b3e0ff;
        }

        /* Improve scrollbar for chatbot messages */
        #chatbot-messages::-webkit-scrollbar {
            width: 6px;
        }

        #chatbot-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #chatbot-messages::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        #chatbot-messages::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
    <!-- Footer (fixed at bottom) -->
    <footer style="position:fixed; left:0; bottom:0; width:100vw; background:#222; color:#fff; text-align:center; padding:12px 0; font-size:1rem; z-index:9999;">
        &copy; 2025 Tridex. All rights reserved. Made with <span style="color:#e25555;">&#10084;&#65039;</span> by Tridex.
    </footer>
    <script>
        // --- withLoading helper for loading overlay ---
function withLoading(action) {
    return async function(...args) {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) loadingOverlay.style.display = 'flex';
        try {
            await action(...args);
        } catch (error) {
            console.error('Error during action:', error);
        } finally {
            if (loadingOverlay) loadingOverlay.style.display = 'none';
        }
    };
}

// --- Loading overlay helpers ---
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// --- Hamburger menu functionality ---
document.addEventListener('DOMContentLoaded', function() {
    const hamburger = document.getElementById('hamburger-menu');
    const nav = document.getElementById('nav');

    // Toggle navigation when hamburger is clicked
    hamburger.addEventListener('click', function() {
        nav.classList.toggle('show');

        // Animate hamburger icon
        const spans = hamburger.querySelectorAll('span');
        spans.forEach(span => span.classList.toggle('active'));
    });

    // Close navigation when clicking outside
    document.addEventListener('click', function(event) {
        if (!hamburger.contains(event.target) && !nav.contains(event.target) && nav.classList.contains('show')) {
            nav.classList.remove('show');

            // Reset hamburger icon
            const spans = hamburger.querySelectorAll('span');
            spans.forEach(span => span.classList.remove('active'));
        }
    });

    // Close navigation when window is resized
    window.addEventListener('resize', function() {
        if (window.innerWidth > 992 && nav.classList.contains('show')) {
            nav.classList.remove('show');

            // Reset hamburger icon
            const spans = hamburger.querySelectorAll('span');
            spans.forEach(span => span.classList.remove('active'));
        }
    });
});

// Ban check logic (must be first in script)
const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

// Check if the user is banned using our ban system
if (window.banSystem && window.banSystem.checkCurrentUserBan()) {
    // Stop further script execution - the ban system will handle everything
    throw new Error('User is banned');
}

// Fix: define verifiedUsers as an empty array to prevent JS errors
const verifiedUsers = [];

// Show/hide buttons based on login status
const isLoggedIn = localStorage.getItem('isLoggedIn');
// Display username if available
if (isLoggedIn && username) {
    document.getElementById('username-display').innerHTML =
        `Welcome, <span style="text-transform:uppercase; letter-spacing:0.5px; font-weight:500;">${username}</span> ${verifiedUsers.includes(username) ? '<span title="Verified" style="color:#1da1f2; font-size:1.1em;">&#10004;&#65039;</span>' : ''}`;
}
// Hide or show logout button
document.getElementById('logout-btn').style.display = isLoggedIn ? 'block' : 'none';
// Hide or show login/signup in dropdown and handle profile icon click
document.addEventListener('DOMContentLoaded', function() {
    const userIcon = document.getElementById('userIcon');
    const dropdown = document.getElementById('userDropdown');
    if (isLoggedIn) {
        // Remove login and signup links if logged in
        dropdown.innerHTML = '';
        // Redirect to profile page on profile icon click
        userIcon.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'profile.html';
        });
    } else {
        userIcon.addEventListener('click', function(e) {
            e.preventDefault();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
    }
    document.addEventListener('click', function(e) {
        if (!userIcon.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
});

// Redirect to login if not logged in
if (!isLoggedIn) {
    document.getElementById('logout-btn').style.display = 'none';
}
// Logout button with popup confirmation
document.getElementById('logout-btn').onclick = function() {
    document.getElementById('logout-popup').style.display = 'flex';
};
document.getElementById('popup-logout-no').onclick = function() {
    document.getElementById('logout-popup').style.display = 'none';
};
document.getElementById('popup-logout-yes').onclick = function() {
    localStorage.removeItem('isLoggedIn');
    window.location.href = 'login.html';
};

// Render products function with detailed error logging
        function renderProducts(products) {
            try {
                const grid = document.getElementById('product-grid');
                grid.innerHTML = '';
                if (!products || products.length === 0) {
                    grid.innerHTML = '<div style="text-align:center; color:#888; font-size:1.2em; padding:32px 0;">No results found.</div>';
                    return;
                }
                products.forEach(product => {
                    try {
                        const div = document.createElement('div');
                        div.className = 'product-card';
                        div.innerHTML = `
                            <div class="product-image-container">
                                <img src="${product.image || ''}" alt="${product.name}" style="cursor:pointer;" data-id="${product._id}">
                            </div>
                            <h3>${product.name}</h3>
                            <p>‚Çπ${product.price}</p>
                        `;
                        div.querySelector('img').onclick = function() {
                            window.location.href = `product-details.html?id=${product._id}`;
                        };
                        grid.appendChild(div);
                    } catch (err) {
                        console.error('Error rendering product:', product, err);
                    }
                });
            } catch (err) {
                console.error('Error in renderProducts:', err);
                document.getElementById('product-grid').innerHTML = '<div style="text-align:center; color:#888; font-size:1.2em; padding:32px 0;">Failed to render products.<br>' + err + '</div>';
            }
        }
        async function fetchAndRenderProducts(filter = "") {
            try {
                // Use the production server URL instead of localhost
                const res = await fetch('https://tridex1.onrender.com/products');

                // Log the response for debugging
                console.log('Product fetch response status:', res.status);

                let products = await res.json();
                console.log('Products loaded:', products.length);

                const filtered = products.filter(product =>
                    !filter ||
                    product.name.toLowerCase().includes(filter.toLowerCase()) ||
                    (product.desc && product.desc.toLowerCase().includes(filter.toLowerCase()))
                );

                console.log('Filtered products:', filtered.length);
                renderProducts(filtered);
            } catch (e) {
                console.error('Product fetch error:', e);

                // Show a more user-friendly error message
                document.getElementById('product-grid').innerHTML = `
                    <div style="text-align:center; color:#888; font-size:1.2em; padding:32px 0;">
                        <p>Unable to load products at this time.</p>
                        <p style="font-size:0.9em; margin-top:10px;">Please try again later or contact support.</p>
                        <button onclick="fetchAndRenderProducts()" style="margin-top:15px; padding:8px 16px; background:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer;">
                            Try Again
                        </button>
                    </div>`;
            } finally {
                // --- Hide loading overlay after products are rendered ---
                hideLoading();
            }
        }
        // Initial render
        fetchAndRenderProducts();
        // Search form
        document.getElementById('search-form').onsubmit = function(e) {
            e.preventDefault();
            const filter = document.getElementById('search-input').value.trim().toLowerCase();
            fetchAndRenderProducts(filter);
        };

        // Cart icon click
        document.getElementById('cartIcon').onclick = withLoading(function(e) {
            e.preventDefault();
            window.location.href = 'cart.html';
        });

        // Mailbox open
        document.getElementById('mailIcon').onclick = withLoading(async function(e) {
            e.preventDefault();

            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const hasToken = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            // If we have a token but no isLoggedIn flag, set it
            if (hasToken && !isLoggedIn) {
                localStorage.setItem('isLoggedIn', 'true');
            }

            // Check login status after potential update
            const isActuallyLoggedIn = localStorage.getItem('isLoggedIn') || hasToken;

            if (!isActuallyLoggedIn) {
                alert('You must login to view your mailbox.');
                window.location.href = 'login.html';
                return;
            }

            // Fetch announcements from server including user-specific ones
            let messages = [];
            try {
                const response = await fetch(`https://tridex1.onrender.com/announcements?username=${encodeURIComponent(username)}`);
                if (response.ok) {
                    messages = await response.json();
                } else {
                    console.error('Failed to fetch announcements:', response.status);
                    // Fallback to local storage if server fetch fails
                    messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
                }
            } catch (e) {
                console.error('Error fetching announcements:', e);
                // Fallback to local storage
                messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
            }

            const lastSeenKey = username ? `mailLastSeen_${username}` : 'mailLastSeen_guest';
            localStorage.setItem(lastSeenKey, messages.length);
            updateMailCount();

            const mailbox = document.getElementById('mailbox-modal');
            const messagesDiv = document.getElementById('mailbox-messages');

            if (messages.length === 0) {
                messagesDiv.innerHTML = '<p style="color:#888;">No messages.</p>';
            } else {
                messagesDiv.innerHTML = messages.map(msg => {
                    // Check if it's a welcome message that hasn't been read
                    const isWelcomeMessage = msg.isWelcomeMessage && !msg.isRead;
                    const welcomeClass = isWelcomeMessage ? 'welcome-message' : '';
                    const welcomeStyle = isWelcomeMessage ? 'background-color:#f8f9fa; border-left:4px solid #28a745; padding-left:12px;' : '';

                    return `
                        <div class="message-item ${welcomeClass}" data-id="${msg._id}" style="border-bottom:1px solid #eee; padding:12px 0; ${welcomeStyle}">
                            <strong>${msg.title || 'Announcement'}</strong>
                            <div style="font-size:0.97em; margin-top:4px;">${msg.message || msg.body}</div>
                            <div style="font-size:0.85em; color:#888; margin-top:2px; display:flex; justify-content:space-between;">
                                <span>${new Date(msg.createdAt).toLocaleString() || msg.date || ''}</span>
                                ${isWelcomeMessage ?
                                    `<button class="mark-read-btn" data-id="${msg._id}" style="background:#28a745; color:white; border:none; border-radius:4px; padding:2px 8px; cursor:pointer; font-size:0.9em;">Mark as Read</button>`
                                    : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                // Add event listeners to "Mark as Read" buttons
                const markReadButtons = document.querySelectorAll('.mark-read-btn');
                markReadButtons.forEach(button => {
                    button.addEventListener('click', async function(e) {
                        e.stopPropagation(); // Prevent event bubbling

                        const messageId = this.getAttribute('data-id');
                        try {
                            const response = await fetch(`https://tridex1.onrender.com/announcements/${messageId}/read`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });

                            if (response.ok) {
                                // Remove the welcome message styling
                                const messageItem = this.closest('.message-item');
                                messageItem.classList.remove('welcome-message');
                                messageItem.style.backgroundColor = '';
                                messageItem.style.borderLeft = '';
                                messageItem.style.paddingLeft = '';

                                // Remove the button
                                this.remove();

                                // Update the count
                                updateMailCount();
                            } else {
                                console.error('Failed to mark message as read:', response.status);
                            }
                        } catch (error) {
                            console.error('Error marking message as read:', error);
                        }
                    });
                });
            }

            mailbox.style.display = 'flex';
        });

        // Close mailbox
        document.getElementById('close-mailbox').onclick = withLoading(function() {
            document.getElementById('mailbox-modal').style.display = 'none';
        });

        // Logout popup
        document.getElementById('logout-btn').onclick = withLoading(function() {
            document.getElementById('logout-popup').style.display = 'flex';
        });
        document.getElementById('popup-logout-no').onclick = withLoading(function() {
            document.getElementById('logout-popup').style.display = 'none';
        });
        document.getElementById('popup-logout-yes').onclick = withLoading(function() {
            localStorage.removeItem('isLoggedIn');
            window.location.href = 'login.html';
        });

        // Mail notification count logic
    async function updateMailCount() {
        // Check login status with both methods
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const hasToken = localStorage.getItem('token');
        const isActuallyLoggedIn = isLoggedIn || hasToken;

        // Use username from either source
        const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

        // If we have a token but no isLoggedIn flag, set it
        if (hasToken && !isLoggedIn) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // If not logged in, hide the mail count
        const mailCount = document.getElementById('mail-count');
        if (!isActuallyLoggedIn || !username) {
            mailCount.style.display = 'none';
            return;
        }

        // Try to fetch from server first
        let messages = [];
        let unreadCount = 0;

        try {
            const response = await fetch(`https://tridex1.onrender.com/announcements?username=${encodeURIComponent(username)}`);
            if (response.ok) {
                messages = await response.json();

                // Count unread welcome messages
                unreadCount = messages.filter(msg => msg.isWelcomeMessage && !msg.isRead).length;

                // Store the messages in localStorage for offline access
                localStorage.setItem('adminMessages', JSON.stringify(messages));
            } else {
                console.error('Failed to fetch announcements for count:', response.status);
                // Fallback to local storage
                messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
            }
        } catch (e) {
            console.error('Error fetching announcements for count:', e);
            // Fallback to local storage
            try {
                messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
            } catch (e) {
                messages = [];
            }
        }

        // If we didn't get unread count from server, calculate from local storage
        if (unreadCount === 0) {
            const lastSeenKey = username ? `mailLastSeen_${username}` : 'mailLastSeen_guest';
            const lastSeen = Number(localStorage.getItem(lastSeenKey) || 0);
            unreadCount = Math.max(messages.length - lastSeen, 0);
        }

        // Update the badge
        if (unreadCount > 0) {
            mailCount.textContent = unreadCount;
            mailCount.style.display = '';
        } else {
            mailCount.style.display = 'none';
        }
    }
    updateMailCount();

    // This mailbox click handler is now handled above with the enhanced implementation

    // Fix: Ensure close button works even if DOMContentLoaded is not fired yet
    document.getElementById('close-mailbox').onclick = function() {
        document.getElementById('mailbox-modal').style.display = 'none';
    };

    // Update mail count when messages change (from other tabs)
    window.addEventListener('storage', function(e) {
        if (e.key === 'adminMessages') updateMailCount();
    });

        // Enhanced Chatbot logic
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotBox = document.getElementById('chatbot-box');
        const chatbotForm = document.getElementById('chatbot-form');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotTyping = document.getElementById('chatbot-typing');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotStatus = document.getElementById('chatbot-status');

        // Ensure all chatbot elements exist before adding event listeners
        if (chatbotToggle && chatbotBox && chatbotForm && chatbotInput && chatbotMessages) {
            // Show welcome message when chatbot is first opened
            let chatbotInitialized = false;

            // Toggle chatbot visibility
            chatbotToggle.onclick = function() {
                const isVisible = chatbotBox.style.display === 'block';
                chatbotBox.style.display = isVisible ? 'none' : 'block';

                if (!isVisible && !chatbotInitialized) {
                    // First time opening the chatbot
                    setTimeout(() => {
                        showTypingIndicator();
                        setTimeout(() => {
                            hideTypingIndicator();
                            addBotMessage("üëã Hi there! I'm the Tridex AI assistant. How can I help you today?");

                            // Add suggestion chips
                            addSuggestionChips([
                                "Products",
                                "How to buy",
                                "Account help",
                                "Contact us"
                            ]);

                            chatbotInitialized = true;
                        }, 1500);
                    }, 500);
                }
            };

            // Close button functionality
            if (chatbotClose) {
                chatbotClose.onclick = function() {
                    chatbotBox.style.display = 'none';
                };
            }

            // Function to show typing indicator
            function showTypingIndicator() {
                if (chatbotTyping) {
                    chatbotTyping.style.display = 'block';
                    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                    chatbotStatus.textContent = 'Typing...';
                }
            }

            // Function to hide typing indicator
            function hideTypingIndicator() {
                if (chatbotTyping) {
                    chatbotTyping.style.display = 'none';
                    chatbotStatus.textContent = 'Online';
                }
            }

            // Function to add user message
            function addUserMessage(text) {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'user-message';
                msgDiv.textContent = text;
                chatbotMessages.appendChild(msgDiv);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            // Function to add bot message
            function addBotMessage(text) {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'bot-message';
                msgDiv.innerHTML = text;
                chatbotMessages.appendChild(msgDiv);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            // Function to add suggestion chips
            function addSuggestionChips(suggestions) {
                const chipsDiv = document.createElement('div');
                chipsDiv.className = 'suggestion-chips';

                suggestions.forEach(suggestion => {
                    const chip = document.createElement('button');
                    chip.className = 'suggestion-chip';
                    chip.textContent = suggestion;
                    chip.onclick = function() {
                        const userMsg = this.textContent;
                        addUserMessage(userMsg);
                        processUserMessage(userMsg);

                        // Remove the chips after selection
                        chipsDiv.remove();
                    };
                    chipsDiv.appendChild(chip);
                });

                chatbotMessages.appendChild(chipsDiv);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            // Enhanced AI response with more patterns and helpful links
            function aiResponse(question) {
                const q = question.trim().toLowerCase();

                // Greeting patterns
                if (q.match(/^(hi|hello|hey|greetings|howdy)/i)) {
                    return "Hello! How can I help you today?";
                }

                // Help command
                if (q === 'help' || q === 'commands' || q === 'options') {
                    return `
                        Here are some things you can ask me about:<br>
                        - Products and pricing<br>
                        - How to place an order<br>
                        - Account management<br>
                        - Payment methods<br>
                        - Shipping and delivery<br>
                        - Returns and refunds<br>
                        - Contact information
                    `;
                }

                // Product related queries
                if (q.includes('product') || q.includes('item') || q.includes('catalog')) {
                    return `
                        You can browse our products on the main page. We offer a wide range of items
                        in various categories. <a href="#" onclick="scrollToProducts(); return false;">Click here</a>
                        to see our featured products.
                    `;
                }

                // Price related queries
                if (q.includes('price') || q.includes('cost') || q.includes('how much')) {
                    return `
                        Product prices are displayed on each product card. We offer competitive pricing
                        and occasional discounts. You can also filter products by price range.
                    `;
                }

                // Purchase related queries
                if (q.includes('buy') || q.includes('purchase') || q.includes('order') || q.includes('checkout')) {
                    return `
                        To purchase a product:<br>
                        1. Log in to your account<br>
                        2. Browse and select the product you want<br>
                        3. Click "Add to Cart" or "Buy Now"<br>
                        4. Follow the checkout process<br>
                        5. Complete payment<br><br>
                        Your order will be processed immediately after payment confirmation.
                    `;
                }

                // Account related queries
                if (q.includes('account') || q.includes('profile') || q.includes('sign up') || q.includes('login')) {
                    return `
                        For account management:<br>
                        - <a href="login.html">Login</a> to your existing account<br>
                        - <a href="signup.html">Create a new account</a><br>
                        - <a href="profile.html">View your profile</a> (when logged in)<br>
                        - <a href="forgotpassword.html">Reset your password</a> if forgotten
                    `;
                }

                // Payment related queries
                if (q.includes('payment') || q.includes('pay') || q.includes('credit card') || q.includes('debit card')) {
                    return `
                        We accept various payment methods:<br>
                        - Credit/Debit cards<br>
                        - PayPal<br>
                        - Bank transfers<br>
                        - Cash on delivery (for eligible locations)<br><br>
                        All payment information is securely processed and encrypted.
                    `;
                }

                // Shipping related queries
                if (q.includes('shipping') || q.includes('delivery') || q.includes('track')) {
                    return `
                        Shipping information:<br>
                        - Standard delivery: 3-5 business days<br>
                        - Express delivery: 1-2 business days (additional fee)<br>
                        - Free shipping on orders over $50<br><br>
                        You can track your order from your account dashboard once shipped.
                    `;
                }

                // Return related queries
                if (q.includes('return') || q.includes('refund') || q.includes('exchange')) {
                    return `
                        Our return policy:<br>
                        - 30-day return window for most products<br>
                        - Item must be in original condition<br>
                        - Refunds are processed within 7-10 business days<br><br>
                        To initiate a return, please contact customer service.
                    `;
                }

                // Contact related queries
                if (q.includes('contact') || q.includes('support') || q.includes('help desk') || q.includes('customer service')) {
                    return `
                        Contact information:<br>
                        - Email: support@tridex.com<br>
                        - Phone: (555) 123-4567<br>
                        - Hours: Monday-Friday, 9am-5pm EST<br><br>
                        You can also use our <a href="#" onclick="alert('Contact form would open here'); return false;">contact form</a> for inquiries.
                    `;
                }

                // Password reset queries
                if (q.includes('reset password') || q.includes('forgot password') || q.includes('change password')) {
                    return `
                        To reset your password:<br>
                        1. Go to the <a href="forgotpassword.html">Forgot Password</a> page<br>
                        2. Enter your email and phone number<br>
                        3. Follow the verification process<br>
                        4. Create a new password<br><br>
                        You can also change your password from your profile page when logged in.
                    `;
                }

                // About us queries
                if (q.includes('about') || q.includes('company') || q.includes('who are you')) {
                    return `
                        Tridex is an e-commerce platform offering a wide range of products.
                        We're committed to providing excellent customer service and high-quality products
                        at competitive prices. Founded in 2025, we've been serving customers worldwide.
                    `;
                }

                // Fallback response with suggestions
                return `
                    I'm not sure I understand. Could you try rephrasing or check these topics?<br><br>
                    <div class="suggestion-chips">
                        <button class="suggestion-chip" onclick="document.getElementById('chatbot-input').value='How to buy'; document.getElementById('chatbot-form').dispatchEvent(new Event('submit'));">How to buy</button>
                        <button class="suggestion-chip" onclick="document.getElementById('chatbot-input').value='Contact info'; document.getElementById('chatbot-form').dispatchEvent(new Event('submit'));">Contact info</button>
                        <button class="suggestion-chip" onclick="document.getElementById('chatbot-input').value='Help'; document.getElementById('chatbot-form').dispatchEvent(new Event('submit'));">Help</button>
                    </div>
                `;
            }

            // Process user message and generate response
            function processUserMessage(userMsg) {
                // Show typing indicator
                showTypingIndicator();

                // Simulate thinking time based on message length
                const thinkTime = Math.min(Math.max(userMsg.length * 50, 500), 2000);

                setTimeout(() => {
                    // Hide typing indicator
                    hideTypingIndicator();

                    // Get AI response
                    const reply = aiResponse(userMsg);

                    // Add bot message
                    addBotMessage(reply);

                    // Add follow-up suggestions based on the query
                    const q = userMsg.trim().toLowerCase();

                    if (q.includes('product') || q.includes('price')) {
                        addSuggestionChips(["How to buy", "Payment methods", "Shipping info"]);
                    } else if (q.includes('account') || q.includes('login')) {
                        addSuggestionChips(["Reset password", "Create account", "Profile help"]);
                    } else if (q.includes('shipping') || q.includes('delivery')) {
                        addSuggestionChips(["Track order", "Return policy", "Contact support"]);
                    }
                }, thinkTime);
            }

            // Handle form submission
            chatbotForm.onsubmit = function(e) {
                e.preventDefault();
                const userMsg = chatbotInput.value.trim();

                if (userMsg === '') return;

                // Add user message
                addUserMessage(userMsg);

                // Process the message
                processUserMessage(userMsg);

                // Clear input
                chatbotInput.value = '';
            };

            // Function to scroll to products section
            window.scrollToProducts = function() {
                const productsSection = document.querySelector('.product-grid');
                if (productsSection) {
                    productsSection.scrollIntoView({ behavior: 'smooth' });
                }
            };
        }

        // Cart icon logic
    function updateCartCount() {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        // Check for token as well (for backward compatibility)
        const hasToken = localStorage.getItem('token');
        // Use username from either source
        const username = localStorage.getItem('currentUser') || localStorage.getItem('username');

        // If we have a token but no isLoggedIn flag, set it
        if (hasToken && !isLoggedIn) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // If we have a username but no currentUser, set it
        if (localStorage.getItem('username') && !localStorage.getItem('currentUser')) {
            localStorage.setItem('currentUser', localStorage.getItem('username'));
        }

        // Recheck login status after potential updates
        const isActuallyLoggedIn = localStorage.getItem('isLoggedIn') || hasToken;

        if (!isActuallyLoggedIn || !username) {
            document.getElementById('cart-count').style.display = 'none';
            return;
        }
        // Ensure cart is isolated per user
        const cartUser = localStorage.getItem('cartUser');
        if (cartUser !== username) {
            const userCart = localStorage.getItem('cart_' + username);
            if (userCart) {
                localStorage.setItem('cart', userCart);
            } else {
                localStorage.removeItem('cart');
            }
            localStorage.setItem('cartUser', username);
        }
        let cart = [];
        try { cart = JSON.parse(localStorage.getItem('cart')) || []; } catch (e) { cart = []; }
        const count = cart.length;
        const cartCount = document.getElementById('cart-count');
        if (count > 0) {
            cartCount.textContent = count;
            cartCount.style.display = '';
        } else {
            cartCount.style.display = 'none';
        }
    }
    updateCartCount();

    // Listen for cart changes from other tabs/windows
    window.addEventListener('storage', function(e) {
        if (e.key === 'cart') updateCartCount();
    });

    // Cart icon click: show cart page or popup (redirect to cart.html)
    document.getElementById('cartIcon').onclick = function(e) {
        e.preventDefault();
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const hasToken = localStorage.getItem('token');

        // If we have a token but no isLoggedIn flag, set it
        if (hasToken && !isLoggedIn) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // Check login status after potential update
        const isActuallyLoggedIn = localStorage.getItem('isLoggedIn') || hasToken;

        if (!isActuallyLoggedIn) {
            alert('You must login to view your cart.');
            window.location.href = 'login.html';
            return;
        }

        window.location.href = 'cart.html';
    };

    // If you want to update cart count after adding to cart from product-details.html,
    // you must call updateCartCount() after adding to cart, or reload the index page.

    // Simple hamburger menu implementation
    document.addEventListener('DOMContentLoaded', function() {
        const hamburger = document.getElementById('hamburger-menu');
        const nav = document.getElementById('main-nav');

        // Function to check window size and adjust menu visibility
        function checkWindowSize() {
            if (window.innerWidth <= 768) {
                // Mobile view
                hamburger.style.display = 'block';
                nav.style.display = 'none';
            } else {
                // Desktop view
                hamburger.style.display = 'none';
                nav.style.display = 'flex';
            }
        }

        // Initial check
        checkWindowSize();

        // Check on window resize
        window.addEventListener('resize', checkWindowSize);

        // Toggle menu when hamburger is clicked
        hamburger.addEventListener('click', function() {
            if (nav.style.display === 'none' || nav.style.display === '') {
                nav.style.display = 'flex';
                nav.style.position = 'absolute';
                nav.style.top = '60px';
                nav.style.left = '0';
                nav.style.width = '100%';
                nav.style.backgroundColor = '#333';
                nav.style.flexDirection = 'column';
                nav.style.zIndex = '1000';

                // Make the nav items stack vertically
                document.getElementById('nav').style.flexDirection = 'column';
                document.getElementById('nav').style.width = '100%';

                // Add some styling to nav items
                const navItems = document.querySelectorAll('#nav li');
                navItems.forEach(item => {
                    item.style.width = '100%';
                    item.style.textAlign = 'center';
                    item.style.padding = '10px 0';
                    item.style.borderBottom = '1px solid #444';
                });
            } else {
                nav.style.display = 'none';
            }
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768 &&
                nav.style.display === 'flex' &&
                !nav.contains(event.target) &&
                event.target !== hamburger &&
                !hamburger.contains(event.target)) {
                nav.style.display = 'none';
            }
        });
    });

    // This event listener is now handled in the DOMContentLoaded block above
    </script>
</body>
</html>