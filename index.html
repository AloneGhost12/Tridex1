<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>Tridex</title>
   <link rel="stylesheet" href="style.css">
   <link rel="stylesheet" href="chatbot.css">
   <link rel="stylesheet" href="css/responsive.css">
   <link rel="stylesheet" href="css/navigation.css">
   <!-- Include the ban system script -->
   <script src="ban-system.js"></script>
   <!-- Include enhanced chatbot scripts -->
   <script src="chatbot.js" defer></script>
   <script src="chatbot-ai.js" defer></script>
   <!-- Include responsive behavior script -->
   <script src="js/responsive.js" defer></script>
   <!-- Include navigation state management script -->
   <script src="js/navigation-state.js" defer></script>
   <style>
       /* Additional page-specific styles */
       /* Any page-specific styles that aren't covered by responsive.css can go here */
   </style>
</head>
<body>
    <!-- Loading animation overlay -->
    <div id="loading-overlay" style="display:flex; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:99999; align-items:center; justify-content:center;">
        <div style="border:6px solid #f3f3f3; border-top:6px solid #007bff; border-radius:50%; width:48px; height:48px; animation:spin 1s linear infinite;"></div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
   <header>
       <div class="container">
           <!-- New Navigation Structure -->
           <div class="header-wrapper">
               <!-- Logo -->
               <div class="logo-container">
                   <h1>Tridex</h1>
                   <span id="username-display"></span>
               </div>

               <!-- Hamburger Menu Button -->
               <div class="hamburger-container">
                   <button id="hamburger-btn" aria-label="Menu">
                       <span></span>
                       <span></span>
                       <span></span>
                   </button>
               </div>

               <!-- Navigation Menu -->
               <nav id="site-navigation">
                   <ul class="nav-menu">
                       <li><a href="index.html" class="nav-link">Home</a></li>
                       <li><a href="about.html" class="nav-link">About</a></li>
                       <li><a href="more.html" class="nav-link">More</a></li>
                       <li><a href="contact.html" class="nav-link">Contact Us</a></li>
                   </ul>

                   <!-- Mobile Icons Container (visible only on mobile) -->
                   <div class="mobile-icon-container">
                       <div class="nav-icon-item">
                           <a href="#" class="nav-icon" id="userIcon" title="User Profile">
                               <i class="fas fa-user"></i>
                           </a>
                       </div>
                       <div class="nav-icon-item">
                           <a href="#" class="nav-icon" id="mailIcon" title="Mailbox">
                               <i class="fas fa-envelope"></i>
                               <span id="mail-count" class="badge">0</span>
                           </a>
                       </div>
                       <div class="nav-icon-item">
                           <a href="cart.html" class="nav-icon" id="cartIcon" title="Cart">
                               <i class="fas fa-shopping-cart"></i>
                               <span id="cart-count" class="badge">0</span>
                           </a>
                       </div>
                   </div>
               </nav>
           </div>

           <!-- Search Bar -->
           <form class="search-bar" id="search-form">
               <input type="text" id="search-input" placeholder="Search products...">
               <button type="submit" aria-label="Search">
                   <i class="fas fa-search search-icon"></i>
               </button>
           </form>

           <!-- User Dropdown Menu -->
           <div class="dropdown-menu" id="userDropdown" style="display:none;">
               <a href="login.html" class="dropdown-btn">Login</a>
               <a href="signup.html" class="dropdown-btn">Sign Up</a>
           </div>
       </div>
   </header>

   <!-- Category Navigation -->
   <div class="category-nav">
       <div class="container">
           <h2>Shop by Category</h2>
           <div id="category-icons" class="category-icons-container">
               <!-- Category icons will be rendered here by JS -->
               <div class="category-loading">
                   <div class="loading-spinner"></div>
                   <p>Loading categories...</p>
               </div>
           </div>
       </div>
   </div>

   <section class="product-grid" id="product-grid">
       <!-- Product cards will be rendered here by JS -->
   </section>

   <style>
       /* Category Navigation Styles */
       .category-item {
           display: flex;
           flex-direction: column;
           align-items: center;
           cursor: pointer;
           transition: transform 0.3s ease;
           padding: 10px;
           min-width: 100px;
       }

       .category-item:hover {
           transform: translateY(-5px);
       }

       .category-icon {
           width: 80px;
           height: 80px;
           border-radius: 50%;
           background: #fff;
           display: flex;
           align-items: center;
           justify-content: center;
           margin-bottom: 8px;
           box-shadow: 0 4px 10px rgba(0,0,0,0.1);
           overflow: hidden;
           transition: all 0.3s ease;
           border: 2px solid #e0e0e0;
       }

       .category-icon img {
           width: 100%;
           height: 100%;
           object-fit: cover;
           border-radius: 50%;
       }

       .category-item:hover .category-icon {
           box-shadow: 0 6px 15px rgba(0,123,255,0.3);
           border-color: #007bff;
       }

       .category-name {
           font-size: 0.9rem;
           color: #333;
           margin-top: 5px;
           text-align: center;
           font-weight: 500;
       }

       /* Hide scrollbar but keep functionality */
       .category-nav::-webkit-scrollbar {
           display: none;
       }

       @media (max-width: 768px) {
           .category-icon {
               width: 70px;
               height: 70px;
           }

           .category-name {
               font-size: 0.8rem;
           }
       }

       @media (max-width: 480px) {
           .category-icon {
               width: 60px;
               height: 60px;
           }

           .category-name {
               font-size: 0.75rem;
           }

           .category-nav {
               padding: 15px 0;
           }
       }
   </style>

    <!-- Ban popup for banned users -->
    <div id="ban-message" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999999; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:280px; max-width:90%; text-align:center;">
            <div style="margin-bottom:10px; font-size:3em; color:#d32f2f;">⚠️</div>
            <h2 style="margin-bottom:10px; color:#d32f2f; font-size:1.5em;">Account Banned</h2>
            <p style="margin-bottom:24px; font-size:1.1em; color:#555; line-height:1.5;">Your account has been banned by the administrator. You no longer have access to this site.</p>
            <p style="margin-bottom:24px; font-size:0.9em; color:#777;">For more information, please contact support.</p>
            <button id="ban-ok-btn" style="padding:10px 24px; background:#dc3545; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer; font-weight:bold; transition:all 0.2s ease;">OK</button>
        </div>
    </div>

    <script>
        // Add click handler for the ban message OK button
        document.addEventListener('DOMContentLoaded', function() {
            const banOkBtn = document.getElementById('ban-ok-btn');
            if (banOkBtn) {
                banOkBtn.addEventListener('click', function() {
                    // Clear all login data
                    localStorage.removeItem('token');
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('username');
                    localStorage.removeItem('currentUser');

                    // Allow scrolling again
                    document.body.style.overflow = '';

                    // Redirect to login page with banned parameter
                    window.location.href = 'login.html?banned=true';
                });
            }
        });
    </script>
    <!-- Mailbox Modal -->
    <div id="mailbox-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); min-width:320px; max-width:90vw;">
            <h2 style="margin-top:0;">Mailbox</h2>
            <div id="mailbox-messages" style="max-height:300px; overflow-y:auto; margin-bottom:18px;"></div>
            <button id="close-mailbox" style="padding:8px 18px; background:#007bff; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer;">Close</button>
        </div>
    </div>
    <!-- Enhanced Chatbot Widget with Responsive Design -->
    <div id="chatbot-widget" style="position:fixed; bottom:80px; right:24px; z-index:5000;">
        <button id="chatbot-toggle" style="background:#007bff; color:#fff; border:none; border-radius:50%; width:56px; height:56px; font-size:2em; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.2); transition:all 0.3s ease;">💬</button>
        <div id="chatbot-box" style="display:none; width:350px; max-width:calc(100vw - 48px); background:#fff; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.2); padding:0 0 12px 0; transition:all 0.3s ease; max-height:80vh;">
            <div style="background:#007bff; color:#fff; border-radius:12px 12px 0 0; padding:14px 18px; font-size:1.2em; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <span style="font-weight:600;">AI Chatbot</span>
                    <span id="chatbot-status" style="font-size:0.8em; margin-left:8px; opacity:0.8;">Online</span>
                </div>
                <button id="chatbot-close" style="background:none; border:none; color:white; font-size:1.2em; cursor:pointer; padding:0; line-height:1;">×</button>
            </div>
            <div id="chatbot-messages" style="height:320px; max-height:50vh; overflow-y:auto; padding:16px; scroll-behavior:smooth;"></div>
            <div id="chatbot-typing" style="display:none; padding:0 16px 8px; font-size:0.9em; color:#666;">
                <div style="display:flex; align-items:center;">
                    <div style="width:8px; height:8px; background:#007bff; border-radius:50%; margin-right:4px; animation:typing-dot 1s infinite;"></div>
                    <div style="width:8px; height:8px; background:#007bff; border-radius:50%; margin-right:4px; animation:typing-dot 1s infinite 0.2s;"></div>
                    <div style="width:8px; height:8px; background:#007bff; border-radius:50%; animation:typing-dot 1s infinite 0.4s;"></div>
                </div>
            </div>
            <form id="chatbot-form" style="display:flex; flex-wrap:wrap; border-top:1px solid #eee; padding:12px;">
                <input id="chatbot-input" type="text" placeholder="Ask me anything..." style="flex:1; min-width:150px; border:1px solid #ccc; border-radius:20px; padding:10px 16px; font-size:1em; outline:none; transition:border 0.3s ease; margin-bottom:8px;" required>
                <button type="submit" style="margin-left:8px; background:#007bff; color:#fff; border:none; border-radius:20px; padding:10px 16px; font-size:1em; cursor:pointer; transition:background 0.3s ease;">Send</button>
            </form>
            <div style="text-align:center; font-size:0.8em; color:#888; padding:0 16px;">
                <p style="margin:4px 0;">Type 'help' to see available commands</p>
            </div>
        </div>
    </div>

    <!-- Chatbot styles moved to chatbot.css -->
    </style>
    <!-- Footer (fixed at bottom) -->
    <footer style="position:fixed; left:0; bottom:0; width:100vw; background:#222; color:#fff; text-align:center; padding:12px 0; font-size:1rem; z-index:9999;">
        &copy; 2025 Tridex. All rights reserved. Made with <span style="color:#e25555;">&#10084;&#65039;</span> by Tridex.
    </footer>
    <script>
        // --- Loading overlay helper functions ---
function showLoading() {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) loadingOverlay.style.display = 'flex';
}

function hideLoading() {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) loadingOverlay.style.display = 'none';
}

// --- withLoading helper for loading overlay ---
function withLoading(action) {
    return async function(...args) {
        showLoading();
        try {
            await action(...args);
        } catch (error) {
            console.error('Error during action:', error);
        } finally {
            hideLoading();
        }
    };
}

// Add event listeners for page load/unload
window.addEventListener('load', function() {
    hideLoading();
});
window.addEventListener('beforeunload', function() {
    showLoading();
});
// Cart count update function
function updateCartCount() {
    const cartCountElement = document.getElementById('cart-count');
    if (cartCountElement) {
        const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
        let cart = [];
        try {
            cart = JSON.parse(localStorage.getItem('cart')) || [];
        } catch (e) {
            cart = [];
        }
        cartCountElement.textContent = cart.length || '';
        cartCountElement.style.display = cart.length ? 'inline-block' : 'none';
    }
}

// --- Navigation System ---
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing navigation system');

    // Get navigation elements
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const siteNavigation = document.getElementById('site-navigation');

    // Check if elements exist
    if (!hamburgerBtn) {
        console.error('Hamburger button not found!');
        return;
    }

    if (!siteNavigation) {
        console.error('Site navigation not found!');
        return;
    }

    // Toggle navigation when hamburger is clicked
    hamburgerBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Toggle active classes
        hamburgerBtn.classList.toggle('active');
        siteNavigation.classList.toggle('active');

        console.log('Navigation toggled:', siteNavigation.classList.contains('active'));
    });

    // Close navigation when clicking outside
    document.addEventListener('click', function(event) {
        if (siteNavigation.classList.contains('active') &&
            !hamburgerBtn.contains(event.target) &&
            !siteNavigation.contains(event.target)) {

            hamburgerBtn.classList.remove('active');
            siteNavigation.classList.remove('active');

            console.log('Navigation closed (clicked outside)');
        }
    });

    // Handle window resize
    window.addEventListener('resize', function() {
        if (window.innerWidth > 992) {
            // Reset for desktop view
            if (siteNavigation.classList.contains('active')) {
                hamburgerBtn.classList.remove('active');
                siteNavigation.classList.remove('active');
            }
        }
    });

    // Initialize navigation based on screen size
    function initNavigation() {
        if (window.innerWidth <= 992) {
            console.log('Initial setup: mobile navigation');
        } else {
            console.log('Initial setup: desktop navigation');
        }
    }

    // Run initial setup
    initNavigation();
});

// Ban check logic (must be first in script)
(function() {
    // Get the current username
    const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

    console.log('Index page loaded, checking ban status for user:', username);

    // Function to check if the user is banned
    function checkUserBan() {
        try {
            // Check if the ban system is available
            if (window.banSystem) {
                // Check if the user is banned or if there's a ban flag in sessionStorage
                if (window.banSystem.isUserBanned(username) || sessionStorage.getItem('userBanned') === 'true') {
                    console.log('User is banned or ban flag found, showing ban message');

                    // Use the ban system to handle the ban
                    window.banSystem.checkCurrentUserBan();

                    // Stop further script execution
                    throw new Error('User is banned');
                }
            } else if (sessionStorage.getItem('userBanned') === 'true') {
                // If the ban system isn't loaded yet but we have a ban flag, show a basic ban message
                console.log('Ban flag found in sessionStorage but ban system not loaded');

                // Clear all login data
                localStorage.removeItem('token');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                localStorage.removeItem('currentUser');

                // Redirect to login page with banned parameter
                window.location.href = 'login.html?banned=true';

                // Stop further script execution
                throw new Error('User is banned (from sessionStorage)');
            }
        } catch (error) {
            if (error.message.includes('User is banned')) {
                throw error; // Re-throw ban-related errors
            }
            console.error('Error checking ban status:', error);
        }
    }

    // Function to wait for the ban system to load
    function waitForBanSystem() {
        // Check if the ban system is already loaded
        if (window.banSystem) {
            checkUserBan();
            return;
        }

        console.log('Ban system not loaded yet, waiting...');

        // Set up a polling mechanism to check for the ban system
        let attempts = 0;
        const maxAttempts = 50; // 5 seconds at 100ms intervals

        const checkInterval = setInterval(function() {
            attempts++;

            if (window.banSystem) {
                console.log('Ban system loaded after', attempts, 'attempts');
                clearInterval(checkInterval);
                checkUserBan();
            } else if (attempts >= maxAttempts) {
                console.log('Ban system failed to load after', maxAttempts, 'attempts');
                clearInterval(checkInterval);

                // Check if we have a ban flag in sessionStorage even though the ban system failed to load
                if (sessionStorage.getItem('userBanned') === 'true') {
                    console.log('Ban flag found in sessionStorage but ban system failed to load');

                    // Clear all login data
                    localStorage.removeItem('token');
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('username');
                    localStorage.removeItem('currentUser');

                    // Redirect to login page with banned parameter
                    window.location.href = 'login.html?banned=true';
                }
            }
        }, 100);
    }

    // Check ban status immediately
    waitForBanSystem();

    // Also check after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking ban status again');
        checkUserBan();
    });

    // Check again after a short delay to catch any race conditions
    setTimeout(checkUserBan, 1000);

    // Check again after the page is fully loaded
    window.addEventListener('load', function() {
        console.log('Window loaded, checking ban status again');
        checkUserBan();
    });
})();

// Fix: define verifiedUsers as an empty array to prevent JS errors
const verifiedUsers = [];

// Show/hide buttons based on login status
const isLoggedIn = localStorage.getItem('isLoggedIn');
// Get username from localStorage
const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

// Display name if available (for personalization), fallback to username
if (isLoggedIn && username) {
    // Try to get the user's name from localStorage for personalization
    const userName = localStorage.getItem('name') || username;

    document.getElementById('username-display').innerHTML =
        `Welcome, <span style="text-transform:uppercase; letter-spacing:0.5px; font-weight:500;">${userName}</span> ${verifiedUsers.includes(username) ? '<span title="Verified" style="color:#1da1f2; font-size:1.1em;">&#10004;&#65039;</span>' : ''}`;
}
// Hide or show login/signup in dropdown and handle profile icon click
document.addEventListener('DOMContentLoaded', function() {
    const userIcon = document.getElementById('userIcon');
    const dropdown = document.getElementById('userDropdown');
    if (isLoggedIn) {
        // Remove login and signup links if logged in
        dropdown.innerHTML = '';
        // Redirect to profile page on profile icon click
        userIcon.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'profile.html';
        });
    } else {
        userIcon.addEventListener('click', function(e) {
            e.preventDefault();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
    }
    document.addEventListener('click', function(e) {
        if (!userIcon.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
});

// Redirect to login if not logged in
if (!isLoggedIn) {
    // User is not logged in
}

// Render products function with detailed error logging
        function renderProducts(products) {
            try {
                const grid = document.getElementById('product-grid');
                grid.innerHTML = '';
                if (!products || products.length === 0) {
                    grid.innerHTML = '<div style="text-align:center; color:#888; font-size:1.2em; padding:32px 0;">No results found.</div>';
                    return;
                }
                products.forEach(product => {
                    try {
                        const div = document.createElement('div');
                        div.className = 'product-card';
                        div.innerHTML = `
                            <div class="product-image-container">
                                <img src="${product.image || ''}" alt="${product.name}" style="cursor:pointer;" data-id="${product._id}">
                            </div>
                            <h3>${product.name}</h3>
                            <p>₹${product.price}</p>
                        `;
                        div.querySelector('img').onclick = function(e) {
                            // Save current page state before navigating
                            history.pushState({ page: 'index', scrollPos: window.scrollY }, '', window.location.href);

                            // Navigate to product details
                            window.location.href = `product-details.html?id=${product._id}`;
                        };
                        grid.appendChild(div);
                    } catch (err) {
                        console.error('Error rendering product:', product, err);
                    }
                });
            } catch (err) {
                console.error('Error in renderProducts:', err);
                document.getElementById('product-grid').innerHTML = '<div style="text-align:center; color:#888; font-size:1.2em; padding:32px 0;">Failed to render products.<br>' + err + '</div>';
            }
        }
        async function fetchAndRenderProducts(filter = "") {
            try {
                // Use the production server URL instead of localhost
                const res = await fetch('https://tridex1.onrender.com/products');

                // Log the response for debugging
                console.log('Product fetch response status:', res.status);

                let products = await res.json();
                console.log('Products loaded:', products.length);

                const filtered = products.filter(product =>
                    !filter ||
                    product.name.toLowerCase().includes(filter.toLowerCase()) ||
                    (product.desc && product.desc.toLowerCase().includes(filter.toLowerCase()))
                );

                console.log('Filtered products:', filtered.length);
                renderProducts(filtered);
            } catch (e) {
                console.error('Product fetch error:', e);

                // Show a more user-friendly error message
                document.getElementById('product-grid').innerHTML = `
                    <div style="text-align:center; color:#888; font-size:1.2em; padding:32px 0;">
                        <p>Unable to load products at this time.</p>
                        <p style="font-size:0.9em; margin-top:10px;">Please try again later or contact support.</p>
                        <button onclick="fetchAndRenderProducts()" style="margin-top:15px; padding:8px 16px; background:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer;">
                            Try Again
                        </button>
                    </div>`;
            } finally {
                // --- Hide loading overlay after products are rendered ---
                hideLoading();
            }
        }
        // Fetch and render categories
        async function fetchAndRenderCategories() {
            try {
                const res = await fetch('https://tridex1.onrender.com/categories');
                const categories = await res.json();

                const categoryContainer = document.getElementById('category-icons');

                // Remove loading indicator
                const loadingElement = document.querySelector('.category-loading');
                if (loadingElement) {
                    loadingElement.remove();
                }

                if (!categories || categories.length === 0) {
                    categoryContainer.innerHTML = '<p style="text-align:center; color:#888; padding:10px;">No categories available.</p>';
                    return;
                }

                // Render each category
                categories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item';
                    categoryItem.innerHTML = `
                        <div class="category-icon">
                            <img src="${category.icon || 'https://via.placeholder.com/80?text=' + category.name.charAt(0)}"
                                 alt="${category.name}"
                                 onerror="this.src='https://via.placeholder.com/80?text=${category.name.charAt(0)}'">
                        </div>
                        <div class="category-name">${category.name}</div>
                    `;

                    // Add click handler to redirect to category page
                    categoryItem.addEventListener('click', () => {
                        // Save current page state before navigating
                        history.pushState({ page: 'index', scrollPos: window.scrollY }, '', window.location.href);

                        // Navigate to category page
                        window.location.href = `category.html?id=${category._id}`;
                    });

                    categoryContainer.appendChild(categoryItem);
                });
            } catch (error) {
                console.error('Error fetching categories:', error);
                const categoryContainer = document.getElementById('category-icons');
                categoryContainer.innerHTML = '<p style="text-align:center; color:#888; padding:10px;">Failed to load categories.</p>';
            }
        }

        // Initial render
        fetchAndRenderProducts();
        fetchAndRenderCategories();

        // Handle browser back button navigation
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.page === 'index') {
                // Restore scroll position if available
                if (event.state.scrollPos) {
                    setTimeout(() => {
                        window.scrollTo(0, event.state.scrollPos);
                    }, 100);
                }
            }
        });

        // Search form
        document.getElementById('search-form').onsubmit = function(e) {
            e.preventDefault();
            const filter = document.getElementById('search-input').value.trim().toLowerCase();
            fetchAndRenderProducts(filter);
        };

        // Cart icon click
        document.getElementById('cartIcon').onclick = withLoading(function(e) {
            e.preventDefault();
            window.location.href = 'cart.html';
        });

        // Mailbox open
        document.getElementById('mailIcon').onclick = withLoading(async function(e) {
            e.preventDefault();

            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const hasToken = localStorage.getItem('token');
            const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

            // If we have a token but no isLoggedIn flag, set it
            if (hasToken && !isLoggedIn) {
                localStorage.setItem('isLoggedIn', 'true');
            }

            // Check login status after potential update
            const isActuallyLoggedIn = localStorage.getItem('isLoggedIn') || hasToken;

            if (!isActuallyLoggedIn) {
                alert('You must login to view your mailbox.');
                window.location.href = 'login.html';
                return;
            }

            // Fetch announcements from server including user-specific ones
            let messages = [];
            try {
                const response = await fetch(`https://tridex1.onrender.com/announcements?username=${encodeURIComponent(username)}`);
                if (response.ok) {
                    messages = await response.json();
                } else {
                    console.error('Failed to fetch announcements:', response.status);
                    // Fallback to local storage if server fetch fails
                    messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
                }
            } catch (e) {
                console.error('Error fetching announcements:', e);
                // Fallback to local storage
                messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
            }

            const lastSeenKey = username ? `mailLastSeen_${username}` : 'mailLastSeen_guest';
            localStorage.setItem(lastSeenKey, messages.length);
            updateMailCount();

            const mailbox = document.getElementById('mailbox-modal');
            const messagesDiv = document.getElementById('mailbox-messages');

            if (messages.length === 0) {
                messagesDiv.innerHTML = '<p style="color:#888;">No messages.</p>';
            } else {
                messagesDiv.innerHTML = messages.map(msg => {
                    // Check if it's a welcome message
                    const isWelcomeMessage = msg.isWelcomeMessage;
                    // Only show the special styling and "Mark as Read" button if it hasn't been read
                    const isUnreadWelcome = isWelcomeMessage && !msg.isRead;
                    const welcomeClass = isUnreadWelcome ? 'welcome-message' : '';
                    const welcomeStyle = isUnreadWelcome ? 'background-color:#f8f9fa; border-left:4px solid #28a745; padding-left:12px;' : '';

                    return `
                        <div class="message-item ${welcomeClass}" data-id="${msg._id}" style="border-bottom:1px solid #eee; padding:12px 0; ${welcomeStyle}">
                            <strong>${msg.title || 'Announcement'}</strong>
                            <div style="font-size:0.97em; margin-top:4px;">${msg.message || msg.body}</div>
                            <div style="font-size:0.85em; color:#888; margin-top:2px; display:flex; justify-content:space-between;">
                                <span>${new Date(msg.createdAt).toLocaleString() || msg.date || ''}</span>
                                ${isUnreadWelcome ?
                                    `<button class="mark-read-btn" data-id="${msg._id}" style="background:#28a745; color:white; border:none; border-radius:4px; padding:2px 8px; cursor:pointer; font-size:0.9em;">Mark as Read</button>`
                                    : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                // Add event listeners to "Mark as Read" buttons
                const markReadButtons = document.querySelectorAll('.mark-read-btn');
                markReadButtons.forEach(button => {
                    button.addEventListener('click', async function(e) {
                        e.stopPropagation(); // Prevent event bubbling

                        const messageId = this.getAttribute('data-id');
                        try {
                            const response = await fetch(`https://tridex1.onrender.com/announcements/${messageId}/read`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });

                            if (response.ok) {
                                // Remove the welcome message styling
                                const messageItem = this.closest('.message-item');
                                messageItem.classList.remove('welcome-message');
                                messageItem.style.backgroundColor = '';
                                messageItem.style.borderLeft = '';
                                messageItem.style.paddingLeft = '';

                                // Remove the button
                                this.remove();

                                // Update the count
                                updateMailCount();
                            } else {
                                console.error('Failed to mark message as read:', response.status);
                            }
                        } catch (error) {
                            console.error('Error marking message as read:', error);
                        }
                    });
                });
            }

            mailbox.style.display = 'flex';
        });

        // Close mailbox
        document.getElementById('close-mailbox').onclick = withLoading(function() {
            document.getElementById('mailbox-modal').style.display = 'none';
        });



        // Mail notification count logic
    async function updateMailCount() {
        // Check login status with both methods
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const hasToken = localStorage.getItem('token');
        const isActuallyLoggedIn = isLoggedIn || hasToken;

        // Use username from either source
        const username = localStorage.getItem('username') || localStorage.getItem('currentUser');

        // If we have a token but no isLoggedIn flag, set it
        if (hasToken && !isLoggedIn) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // If not logged in, hide the mail count
        const mailCount = document.getElementById('mail-count');

        if (!isActuallyLoggedIn || !username) {
            if (mailCount) mailCount.style.display = 'none';
            return;
        }

        // Try to fetch from server first
        let messages = [];
        let unreadCount = 0;

        try {
            const response = await fetch(`https://tridex1.onrender.com/announcements?username=${encodeURIComponent(username)}`);
            if (response.ok) {
                messages = await response.json();

                // Count unread welcome messages that are specifically for this user
                unreadCount = messages.filter(msg =>
                    msg.isWelcomeMessage &&
                    !msg.isRead &&
                    msg.forUser === username
                ).length;

                // Store the messages in localStorage for offline access
                localStorage.setItem('adminMessages', JSON.stringify(messages));
            } else {
                console.error('Failed to fetch announcements for count:', response.status);
                // Fallback to local storage
                messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
            }
        } catch (e) {
            console.error('Error fetching announcements for count:', e);
            // Fallback to local storage
            try {
                messages = JSON.parse(localStorage.getItem('adminMessages')) || [];
            } catch (e) {
                messages = [];
            }
        }

        // If we didn't get unread count from server, calculate from local storage
        if (unreadCount === 0) {
            const lastSeenKey = username ? `mailLastSeen_${username}` : 'mailLastSeen_guest';
            const lastSeen = Number(localStorage.getItem(lastSeenKey) || 0);
            unreadCount = Math.max(messages.length - lastSeen, 0);
        }

        // Update the badge
        if (unreadCount > 0) {
            if (mailCount) {
                mailCount.textContent = unreadCount;
                mailCount.style.display = '';
            }
        } else {
            if (mailCount) mailCount.style.display = 'none';
        }
    }
    updateMailCount();

    // This mailbox click handler is now handled above with the enhanced implementation

    // Fix: Ensure close button works even if DOMContentLoaded is not fired yet
    document.getElementById('close-mailbox').onclick = function() {
        document.getElementById('mailbox-modal').style.display = 'none';
    };

    // Update mail count when messages change (from other tabs)
    window.addEventListener('storage', function(e) {
        if (e.key === 'adminMessages') updateMailCount();
    });

        // Chatbot logic moved to chatbot.js and chatbot-ai.js
        // The chatbot will be initialized when the DOM is fully loaded

        // Cart icon logic
    function updateCartCount() {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        // Check for token as well (for backward compatibility)
        const hasToken = localStorage.getItem('token');
        // Use username from either source
        const username = localStorage.getItem('currentUser') || localStorage.getItem('username');

        // If we have a token but no isLoggedIn flag, set it
        if (hasToken && !isLoggedIn) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // If we have a username but no currentUser, set it
        if (localStorage.getItem('username') && !localStorage.getItem('currentUser')) {
            localStorage.setItem('currentUser', localStorage.getItem('username'));
        }

        // Recheck login status after potential updates
        const isActuallyLoggedIn = localStorage.getItem('isLoggedIn') || hasToken;

        const cartCount = document.getElementById('cart-count');

        if (!isActuallyLoggedIn || !username) {
            if (cartCount) cartCount.style.display = 'none';
            return;
        }
        // Ensure cart is isolated per user
        const cartUser = localStorage.getItem('cartUser');
        if (cartUser !== username) {
            const userCart = localStorage.getItem('cart_' + username);
            if (userCart) {
                localStorage.setItem('cart', userCart);
            } else {
                localStorage.removeItem('cart');
            }
            localStorage.setItem('cartUser', username);
        }
        let cart = [];
        try { cart = JSON.parse(localStorage.getItem('cart')) || []; } catch (e) { cart = []; }
        const count = cart.length;

        // Update cart count badge
        if (count > 0) {
            if (cartCount) {
                cartCount.textContent = count;
                cartCount.style.display = '';
            }
        } else {
            if (cartCount) cartCount.style.display = 'none';
        }
    }
    updateCartCount();

    // Listen for cart changes from other tabs/windows
    window.addEventListener('storage', function(e) {
        if (e.key === 'cart') updateCartCount();
    });

    // Cart icon click handler function
    function handleCartIconClick(e) {
        e.preventDefault();
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const hasToken = localStorage.getItem('token');

        // If we have a token but no isLoggedIn flag, set it
        if (hasToken && !isLoggedIn) {
            localStorage.setItem('isLoggedIn', 'true');
        }

        // Check login status after potential update
        const isActuallyLoggedIn = localStorage.getItem('isLoggedIn') || hasToken;

        if (!isActuallyLoggedIn) {
            alert('You must login to view your cart.');
            window.location.href = 'login.html';
            return;
        }

        window.location.href = 'cart.html';
    }

    // Attach click handler to cart icon
    const cartIcon = document.getElementById('cartIcon');
    if (cartIcon) {
        cartIcon.onclick = handleCartIconClick;
    }

    // User icon click handler function
    function handleUserIconClick(e) {
        e.preventDefault();
        const userDropdown = document.getElementById('userDropdown');

        if (userDropdown) {
            // Toggle dropdown visibility
            if (userDropdown.style.display === 'none' || userDropdown.style.display === '') {
                userDropdown.style.display = 'block';
            } else {
                userDropdown.style.display = 'none';
            }
        }
    }

    // Attach click handler to user icon
    const userIcon = document.getElementById('userIcon');
    if (userIcon) {
        userIcon.onclick = handleUserIconClick;
    }

    // Mail icon click handler function
    function handleMailIconClick(e) {
        e.preventDefault();
        const mailboxModal = document.getElementById('mailbox-modal');

        if (mailboxModal) {
            mailboxModal.style.display = 'block';

            // Update the last seen count
            const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
            if (username) {
                const lastSeenKey = `mailLastSeen_${username}`;
                const messages = JSON.parse(localStorage.getItem('adminMessages') || '[]');
                localStorage.setItem(lastSeenKey, messages.length.toString());

                // Update the mail count display
                updateMailCount();
            }
        }
    }

    // Attach click handler to mail icon
    const mailIcon = document.getElementById('mailIcon');
    if (mailIcon) {
        mailIcon.onclick = handleMailIconClick;
    }

    // If you want to update cart count after adding to cart from product-details.html,
    // you must call updateCartCount() after adding to cart, or reload the index page.

    // This event listener is now handled in the DOMContentLoaded block above
    </script>
</body>
</html>