<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <link rel="stylesheet" href="auth.css">
    <!-- Include the ban system script -->
    <script src="ban-system.js"></script>
</head>
<body>
    <!-- Loading animation overlay -->
    <div id="loading-overlay" style="display:flex; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:99999; align-items:center; justify-content:center;">
        <div style="border:6px solid #f3f3f3; border-top:6px solid #007bff; border-radius:50%; width:48px; height:48px; animation:spin 1s linear infinite;"></div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
    <div class="login-container">
        <h2>Login</h2>
        <!-- Ban message for banned users -->
        <div id="login-ban-message" style="display:none; background:#ffebee; border:1px solid #f44336; padding:15px; margin-bottom:20px; border-radius:5px; text-align:center; z-index:999999;">
            <p style="margin:0 0 10px 0; font-size:1.1em; color:#d32f2f; font-weight:bold;">This account has been banned</p>
            <p style="margin:0; font-size:0.9em; color:#555;">For more information, please contact support.</p>
        </div>
        <form id="login-form" action="index.html" method="get">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required placeholder="Username / Email / Phone Number">
            <label for="password">Password</label>
            <div style="display:flex; align-items:center; position:relative;">
                <input type="password" id="password" name="password" required style="padding-right:32px; flex:1;">
                <span id="toggle-login-password"
                    style="position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; user-select:none; font-size:1.1em; color:#888;">
                    üëÅÔ∏è
                </span>
            </div>
            <button type="submit">Login</button>
        </form>
        <div id="login-error" style="color:red; margin-top:10px; display:none;">
            Incorrect username or password.
        </div>
        <a href="#" id="forgot-password-link" style="display:block; margin-top:10px; text-align:right; color:#007bff; text-decoration:underline; cursor:pointer;">Forgot Password?</a>
        <a href="signup.html"><button class="signup-btn" type="button">Sign Up</button></a>
    </div>
    <script>
    // No need to prevent default on signup button - it should navigate to signup.html

    // Check if the server is running
    async function checkServerStatus() {
        try {
            // Add timeout to prevent hanging requests
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

            // First try with mode: 'no-cors' to at least check if server is reachable
            try {
                const pingResponse = await fetch('https://tridex1.onrender.com/', {
                    method: 'GET',
                    mode: 'no-cors', // This allows the request to be sent even if CORS is not configured
                    signal: controller.signal
                });

                console.log('Server ping successful with no-cors mode');
                // If we get here, the server is at least reachable
            } catch (pingError) {
                console.error('Server completely unreachable:', pingError);
                // If we can't even reach with no-cors, the server is likely down
                clearTimeout(timeoutId);
                return false;
            }

            // Now try a normal request to check CORS
            try {
                const response = await fetch('https://tridex1.onrender.com/', {
                    method: 'GET',
                    signal: controller.signal
                });

                // Clear the timeout if the request completes
                clearTimeout(timeoutId);

                console.log('Server status check:', response.status);
                if (response.ok) {
                    console.log('Server is running with proper CORS');
                    return true;
                } else {
                    console.error('Server returned error:', response.status);
                    return false;
                }
            } catch (corsError) {
                // If this fails but the ping worked, it's likely a CORS issue
                console.error('CORS error when connecting to server:', corsError);

                // Show CORS-specific message
                document.getElementById('login-error').textContent =
                    'The server is reachable but has CORS restrictions. This is a security setting that needs to be fixed on the server.';
                document.getElementById('login-error').style.display = 'block';

                // We'll return true since the server is technically running
                return true;
            }
        } catch (err) {
            console.error('Server check failed:', err);
            return false;
        } finally {
            clearTimeout(timeoutId);
        }
    }

    // Check server status on page load
    checkServerStatus().then(isRunning => {
        if (!isRunning) {
            document.getElementById('login-error').textContent =
                'Server appears to be offline. Please try again later or contact support.';
            document.getElementById('login-error').style.display = 'block';
        }
    });

    // Check for banned users on page load
    window.addEventListener('load', function() {
        // Check if the user was redirected here due to a ban
        const banRedirect = new URLSearchParams(window.location.search).get('banned');
        if (banRedirect === 'true') {
            document.getElementById('login-ban-message').style.display = 'block';
            // Scroll to the ban message
            document.getElementById('login-ban-message').scrollIntoView({ behavior: 'smooth' });

            // Hide loading overlay if it's visible
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // Check if the current user is banned
        const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
        if (username && window.banSystem && window.banSystem.isUserBanned(username)) {
            document.getElementById('login-ban-message').style.display = 'block';
            // Scroll to the ban message
            document.getElementById('login-ban-message').scrollIntoView({ behavior: 'smooth' });

            // Hide loading overlay if it's visible
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }
    });

    document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Hide any previous error messages
        document.getElementById('login-error').style.display = 'none';
        document.getElementById('login-ban-message').style.display = 'none';

        // Show loading indicator
        showLoading();

        const userInput = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        // Basic validation
        if (!userInput || !password) {
            document.getElementById('login-error').textContent = 'Please enter both username and password.';
            document.getElementById('login-error').style.display = 'block';
            hideLoading();
            return;
        }

        // Check if user is banned using our ban system
        if (window.banSystem && window.banSystem.isUserBanned(userInput)) {
            document.getElementById('login-ban-message').style.display = 'block';
            document.getElementById('login-ban-message').scrollIntoView({ behavior: 'smooth' });
            hideLoading();
            return;
        }

        try {
            // We'll focus on connecting to the remote server
            // No local fallbacks since we're using a remote server

            console.log('Attempting to login with:', { username: userInput });

            // Use the correct server URL
            const apiUrl = 'https://tridex1.onrender.com/login';
            console.log('Connecting to server:', apiUrl);

            // Add timeout to prevent hanging requests
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

            try {
                // First try with credentials included
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ username: userInput, password }),
                    credentials: 'include', // Include credentials like cookies
                    signal: controller.signal
                });

                // Clear the timeout if the request completes
                clearTimeout(timeoutId);

                console.log('Login response status:', res.status);

                // If server returns 500, show a specific message
                if (res.status === 500) {
                    throw new Error('The server is experiencing issues. Please try again later or contact support.');
                }

                // For debugging - log the raw response text
                const responseText = await res.text();
                console.log('Raw response:', responseText);

                // Try to parse the JSON response
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('Parsed response:', result);
                } catch (parseError) {
                    console.error('Error parsing response:', parseError);
                    throw new Error('Invalid response from server');
                }

                if (res.ok && result.token) {
                    // Check if user is banned (from server response)
                    if (result.isBanned) {
                        // Ban the user using our ban system
                        if (window.banSystem) {
                            window.banSystem.banUser(result.username || userInput);
                        }

                        // Show ban message
                        document.getElementById('login-ban-message').style.display = 'block';
                        document.getElementById('login-ban-message').scrollIntoView({ behavior: 'smooth' });

                        // Clear any existing login data
                        localStorage.removeItem('token');
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('username');
                        localStorage.removeItem('currentUser');

                        console.error('Login failed: User is banned');
                        return;
                    }

                    localStorage.setItem('token', result.token);
                    // Store isAdmin as a string for consistent checking
                    localStorage.setItem('isAdmin', result.isAdmin ? 'true' : 'false');
                    localStorage.setItem('username', result.username || userInput);
                    // Store verified status
                    localStorage.setItem('verified', result.verified ? 'true' : 'false');
                    // Set isLoggedIn flag to true - this is needed for cart and mailbox access
                    localStorage.setItem('isLoggedIn', 'true');
                    // Also set currentUser for cart functionality
                    localStorage.setItem('currentUser', result.username || userInput);
                    console.log('Login successful, redirecting...');

                    // Redirect based on user type
                    if (result.isAdmin) {
                        window.location.href = 'admin.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                } else {
                    console.error('Login failed:', result);

                    // Check if the error is due to a ban
                    if (result.isBanned) {
                        // Ban the user using our ban system
                        if (window.banSystem) {
                            window.banSystem.banUser(userInput);
                        }

                        // Show ban message
                        document.getElementById('login-ban-message').style.display = 'block';
                        document.getElementById('login-ban-message').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        // Show regular error message
                        document.getElementById('login-error').textContent = result.message || 'Incorrect username or password.';
                        document.getElementById('login-error').style.display = 'block';
                    }
                }
            } catch (fetchError) {
                // Handle fetch errors (network issues, timeouts, etc.)
                console.error('Fetch error:', fetchError);
                if (fetchError.name === 'AbortError') {
                    throw new Error('Login request timed out. Please check your internet connection and try again.');
                }
                throw fetchError;
            }
        } catch (err) {
            console.error('Login error:', err);

            // Display a user-friendly error message based on the error type
            let errorMessage = 'An unexpected error occurred. Please try again later.';

            if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
                errorMessage = 'Unable to connect to the server. Please check your internet connection and try again.';
            } else if (err.name === 'AbortError') {
                errorMessage = 'The request timed out. Please try again later.';
            } else if (err.message && err.message.includes('CORS')) {
                errorMessage = 'Cross-Origin Request Blocked: The server needs CORS configuration. Please contact the administrator.';
            } else if (err.message && err.message.includes('NetworkError')) {
                errorMessage = 'Network Error: This might be due to CORS restrictions. Please contact the administrator.';
            } else if (err.message) {
                errorMessage = err.message;
            }

            document.getElementById('login-error').textContent = errorMessage;
            document.getElementById('login-error').style.display = 'block';
        } finally {
            // Hide loading indicator
            hideLoading();
        }
    });

    // Toggle password visibility for login
    document.getElementById('toggle-login-password').addEventListener('click', function() {
        const pwd = document.getElementById('password');
        if (pwd.type === 'password') {
            pwd.type = 'text';
            this.textContent = 'üôà';
        } else {
            pwd.type = 'password';
            this.textContent = 'üëÅÔ∏è';
        }
    });

    // Signup functionality moved to signup.html

    // Forgot password link
    document.getElementById('forgot-password-link').onclick = function(e) {
        e.preventDefault();
        window.location.href = 'forgotpassword.html';
    };

    // Signup functionality moved to signup.html

    function showLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
    }
    function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }
    window.addEventListener('load', function() {
        hideLoading();
    });
    window.addEventListener('beforeunload', function() {
        showLoading();
    });
    </script>
</body>
</html>
