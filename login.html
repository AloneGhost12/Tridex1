<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <title>Login Page</title>
    <link rel="stylesheet" href="auth.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Custom Popup System -->
    <link rel="stylesheet" href="css/custom-popups.css">
    <script src="js/custom-popups.js"></script>
    <script>
        // Fallback functions in case custom popups don't load
        window.tridexConfirm = window.tridexConfirm || function(message) { return Promise.resolve(confirm(message)); };
        window.tridexSuccess = window.tridexSuccess || function(message) { alert(message); return Promise.resolve(); };
        window.tridexError = window.tridexError || function(message) { alert(message); return Promise.resolve(); };
        window.tridexWarning = window.tridexWarning || function(message) { alert(message); return Promise.resolve(); };
        window.tridexInfo = window.tridexInfo || function(message) { alert(message); return Promise.resolve(); };
    </script>
    <!-- Include the ban system script -->
    <script src="ban-system.js"></script>
    <!-- Include responsive behavior script -->
    <script src="js/responsive.js" defer></script>
    <!-- Include navigation state management script -->
    <script src="js/navigation-state.js" defer></script>
</head>
<body>
    <!-- Loading animation overlay -->
    <div id="loading-overlay" style="display:flex; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:99999; align-items:center; justify-content:center;">
        <div style="border:6px solid #f3f3f3; border-top:6px solid #007bff; border-radius:50%; width:48px; height:48px; animation:spin 1s linear infinite;"></div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
    <div class="login-container">
        <h2>Login</h2>
        <!-- Ban message for banned users -->
        <div id="login-ban-message" style="display:none; background:#ffebee; border:2px solid #f44336; padding:20px; margin-bottom:20px; border-radius:5px; text-align:center; z-index:999999; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
            <div style="font-size:2.5em; color:#d32f2f; margin-bottom:10px;">‚ö†Ô∏è</div>
            <p style="margin:0 0 10px 0; font-size:1.3em; color:#d32f2f; font-weight:bold;">Account Banned</p>
            <p style="margin:0 0 15px 0; font-size:1.1em; color:#555; line-height:1.5;">Your account has been banned by the administrator. You no longer have access to this site.</p>
            <p style="margin:0; font-size:0.9em; color:#777;">For more information, please contact support at <a href="mailto:tridex1332@gmail.com" style="color:#007bff;">tridex1332@gmail.com</a></p>
            <div id="banned-username" style="margin-top:15px; font-size:0.9em; color:#555; font-style:italic; display:none;">
                Username: <span id="banned-username-value" style="font-weight:bold;"></span>
            </div>
        </div>
        <form id="login-form" action="index.html" method="get">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required placeholder="Username / Email / Phone Number">
            <label for="password">Password</label>
            <div style="display:flex; align-items:center; position:relative;">
                <input type="password" id="password" name="password" required style="padding-right:32px; flex:1;">
                <span id="toggle-login-password"
                    style="position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; user-select:none; font-size:1.1em; color:#888;">
                    üëÅÔ∏è
                </span>
            </div>

            <button type="submit">Login</button>
        </form>
        <div id="login-error" style="color:red; margin-top:10px; display:none;">
            Incorrect username or password.
        </div>
        <a href="#" id="forgot-password-link" style="display:block; margin-top:10px; text-align:right; color:#007bff; text-decoration:underline; cursor:pointer;">Forgot Password?</a>
        <a href="signup.html"><button class="signup-btn" type="button">Sign Up</button></a>

        <!-- Google Sign-In Section (Login) -->
        <div style="text-align:center; margin: 20px 0;">
            <div style="margin-bottom: 10px; color: #666; font-size: 0.9em;">Or continue with:</div>
            <div id="g_id_onload"
                 data-client_id="511326319939-431231ifhs4239598gc0d7ba2vc97lms.apps.googleusercontent.com"
                 data-context="signin"
                 data-ux_mode="popup"
                 data-callback="onGoogleSignIn"
                 data-auto_prompt="false"
                 data-itp_support="true">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-shape="rectangular"
                 data-theme="outline"
                 data-text="signin_with"
                 data-size="large"
                 data-logo_alignment="left">
            </div>
        </div>
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <script src="js/config.js"></script>
        <script>
        // Handle COOP errors
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('Cross-Origin-Opener-Policy')) {
                console.warn('COOP error detected, this is expected and can be ignored');
                return true; // Prevent the error from being logged
            }
        });

        function onGoogleSignIn(response) {
            console.log('Google Sign-In response received');

            // Show loading
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }

            // Try production server first, then fallback to localhost
            let apiUrl = 'https://tridex1.onrender.com/auth/google';
            console.log('Using API URL:', apiUrl);

            // Send the Google token to your backend for verification and login
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                body: JSON.stringify({ credential: response.credential, mode: 'login' })
            }).catch(error => {
                console.log('Production server failed, trying localhost...');
                // If production fails, try localhost
                apiUrl = 'http://localhost:3000/auth/google';
                return fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({ credential: response.credential, mode: 'login' })
                });
            })
            .then(res => res.json())
            .then(async (data) => {
                console.log('Google login response:', data);

                // Hide loading
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }

                if (data.success) {
                    // Save user data to localStorage
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('currentUser', data.username);
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('isAdmin', data.isAdmin ? 'true' : 'false');
                    localStorage.setItem('verified', data.verified ? 'true' : 'false');
                    localStorage.setItem('isGoogleUser', 'true');

                    // Clear any ban flags
                    localStorage.removeItem('bannedUsername');
                    sessionStorage.removeItem('userBanned');
                    sessionStorage.removeItem('showBanMessage');

                    // Redirect to home page
                    window.location.href = 'index.html';
                } else {
                    // Handle different error cases
                    if (data.isBanned) {
                        // User is banned
                        localStorage.setItem('bannedUsername', data.username);
                        sessionStorage.setItem('userBanned', 'true');
                        window.location.href = 'login.html?banned=true&bannedUser=' + encodeURIComponent(data.username);
                    } else if (data.message && data.message.includes('No account found')) {
                        // No account found, suggest sign up
                        const createAccount = await tridexConfirm(
                            'No account found with this Google email. Would you like to create a new account?',
                            'Account Not Found'
                        );
                        if (createAccount) {
                            window.location.href = 'signup.html';
                        }
                    } else {
                        await tridexError(data.message || 'Google login failed. Please try again.', 'Login Failed');
                    }
                }
            })
            .catch(async (error) => {
                console.error('Google login error:', error);

                // Hide loading
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }

                // Provide more specific error handling
                if (error.message && error.message.includes('Failed to fetch')) {
                    // Server is offline, provide fallback option
                    const useLocalStorage = await tridexConfirm(
                        'Server is currently offline. Would you like to continue with local storage mode?\n\nNote: Your login will only work on this device until the server comes back online.',
                        'Server Offline'
                    );

                    if (useLocalStorage) {
                        // Decode the Google credential to get user info
                        try {
                            const payload = JSON.parse(atob(response.credential.split('.')[1]));
                            const googleUser = {
                                email: payload.email,
                                name: payload.name,
                                picture: payload.picture,
                                sub: payload.sub
                            };

                            // Check if user exists in local storage
                            const users = JSON.parse(localStorage.getItem('users') || '[]');
                            const existingUser = users.find(u => u.email === googleUser.email);

                            if (existingUser) {
                                // User exists, log them in
                                localStorage.setItem('token', 'google_' + googleUser.sub);
                                localStorage.setItem('username', existingUser.username || googleUser.email);
                                localStorage.setItem('currentUser', existingUser.username || googleUser.email);
                                localStorage.setItem('isLoggedIn', 'true');
                                localStorage.setItem('isAdmin', 'false');
                                localStorage.setItem('verified', 'false');
                                localStorage.setItem('isGoogleUser', 'true');

                                await tridexSuccess('Google login successful! (Local storage mode)', 'Login Successful');
                                window.location.href = 'index.html';
                            } else {
                                // User doesn't exist, suggest signup
                                const createAccount = await tridexConfirm(
                                    'No account found with this Google email. Would you like to create a new account?',
                                    'Account Not Found'
                                );
                                if (createAccount) {
                                    window.location.href = 'signup.html';
                                }
                            }
                        } catch (decodeError) {
                            console.error('Error decoding Google credential:', decodeError);
                            await tridexError('Google login failed: Unable to process Google account information.', 'Login Failed');
                        }
                    }
                } else {
                    await tridexError('Google login failed. Please check your internet connection and try again.', 'Connection Error');
                }
            });
        }
        </script>
    </div>
    <script>
    // --- Prevent back navigation to login page after login ---
    // If user is already logged in, redirect to index.html
    if (localStorage.getItem('token') && (localStorage.getItem('isLoggedIn') === 'true')) {
        window.location.replace('index.html');
    }

    // Check if the server is running
    async function checkServerStatus() {
        // Add timeout to prevent hanging requests
        const controller = new AbortController();
        let timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

        try {
            // Use no-cors mode to check if server is reachable
            try {
                console.log('Checking server with no-cors mode...');
                const pingResponse = await fetch('https://tridex1.onrender.com/', {
                    method: 'GET',
                    mode: 'no-cors', // This allows the request to be sent even if CORS is not configured
                    signal: controller.signal
                });

                console.log('Server ping successful with no-cors mode');

                // If we get here, the server is at least reachable
                // We won't try a normal CORS request since we know it will likely fail
                // Instead, we'll assume the server is running but has CORS restrictions

                // Clear the timeout
                clearTimeout(timeoutId);
                timeoutId = null;

                // CORS message removed

                return true; // Server is running, even with CORS issues
            } catch (pingError) {
                console.error('Server completely unreachable:', pingError);
                // If we can't even reach with no-cors, the server is likely down
                clearTimeout(timeoutId);
                timeoutId = null;
                return false;
            }
        } catch (err) {
            console.error('Server check failed:', err);
            return false;
        } finally {
            // Make sure to clear the timeout if it still exists
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
        }
    }

    // Check server status on page load with 60-second countdown timer
    checkServerStatus().then(isRunning => {
        if (!isRunning) {
            // Show enhanced server startup message with 60-second countdown timer
            document.getElementById('login-error').innerHTML = `
                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 2px solid #ffc107; border-radius: 12px; margin: 15px 0; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);">
                    <div style="font-size: 2em; margin-bottom: 12px; animation: bounce 2s infinite;">üöÄ</div>
                    <div style="font-weight: bold; color: #856404; margin-bottom: 10px; font-size: 1.2em;">Server Starting Up</div>
                    <div style="color: #856404; font-size: 0.95em; margin-bottom: 15px; line-height: 1.4;">
                        Our free server takes about 60 seconds to wake up from sleep mode.<br>
                        <span style="font-size: 0.85em; opacity: 0.8;">Please wait while we bring the server online...</span>
                    </div>
                    <div style="background: #ff6b35; color: white; padding: 12px 20px; border-radius: 25px; display: inline-block; font-weight: bold; font-size: 1.3em; box-shadow: 0 2px 8px rgba(255, 107, 53, 0.4); min-width: 80px;" id="login-server-countdown">
                        60s
                    </div>
                    <div style="color: #856404; font-size: 0.85em; margin-top: 12px; font-style: italic;">
                        ‚è±Ô∏è Server will be ready soon! Thank you for your patience.
                    </div>
                </div>
            `;
            document.getElementById('login-error').style.display = 'block';

            // Add bounce animation for the rocket emoji
            if (!document.getElementById('bounce-animation')) {
                const style = document.createElement('style');
                style.id = 'bounce-animation';
                style.textContent = `
                    @keyframes bounce {
                        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                        40% { transform: translateY(-10px); }
                        60% { transform: translateY(-5px); }
                    }
                `;
                document.head.appendChild(style);
            }

            // Start 60-second countdown timer
            let countdown = 60;
            const countdownElement = document.getElementById('login-server-countdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownElement) {
                    countdownElement.textContent = countdown + 's';

                    // Change colors as time decreases
                    if (countdown <= 10) {
                        countdownElement.style.background = '#dc3545'; // Red for final 10 seconds
                        countdownElement.style.boxShadow = '0 2px 8px rgba(220, 53, 69, 0.5)';
                    } else if (countdown <= 20) {
                        countdownElement.style.background = '#ffc107'; // Yellow for 20-11 seconds
                        countdownElement.style.color = '#000';
                        countdownElement.style.boxShadow = '0 2px 8px rgba(255, 193, 7, 0.5)';
                    } else if (countdown <= 40) {
                        countdownElement.style.background = '#fd7e14'; // Orange for 40-21 seconds
                        countdownElement.style.boxShadow = '0 2px 8px rgba(253, 126, 20, 0.5)';
                    }
                }

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    if (countdownElement) {
                        countdownElement.textContent = 'Ready!';
                        countdownElement.style.background = '#28a745'; // Green when complete
                        countdownElement.style.color = '#fff';
                        countdownElement.style.boxShadow = '0 2px 8px rgba(40, 167, 69, 0.5)';
                    }

                    // Show "Server should be ready!" message briefly
                    setTimeout(() => {
                        if (document.getElementById('login-error')) {
                            document.getElementById('login-error').innerHTML = `
                                <div style="text-align: center; padding: 15px; background: #d4edda; border: 2px solid #28a745; border-radius: 8px; margin: 10px 0;">
                                    <div style="font-size: 1.5em; margin-bottom: 8px;">‚úÖ</div>
                                    <div style="font-weight: bold; color: #155724; margin-bottom: 5px;">Server Should Be Ready!</div>
                                    <div style="color: #155724; font-size: 0.9em;">You can now try logging in.</div>
                                </div>
                            `;

                            // Hide the message completely after 5 seconds
                            setTimeout(() => {
                                document.getElementById('login-error').style.display = 'none';
                            }, 5000);
                        }
                    }, 2000);
                }
            }, 1000);
        }
    });

    // Ban check logic for login page
    (function() {
        console.log('Login page ban check initializing');

        // Function to show the ban message
        function showBanMessage(username) {
            console.log('Showing ban message on login page');

            // Show the ban message
            const banMessage = document.getElementById('login-ban-message');
            if (banMessage) {
                banMessage.style.display = 'block';

                // Add a subtle animation to make it more noticeable
                banMessage.style.animation = 'none';
                void banMessage.offsetWidth; // Trigger reflow
                banMessage.style.animation = 'pulse 1s ease-in-out';

                // Add a pulse animation if it doesn't exist
                if (!document.getElementById('ban-pulse-animation')) {
                    const style = document.createElement('style');
                    style.id = 'ban-pulse-animation';
                    style.textContent = `
                        @keyframes pulse {
                            0% { transform: scale(1); }
                            50% { transform: scale(1.02); }
                            100% { transform: scale(1); }
                        }
                    `;
                    document.head.appendChild(style);
                }

                // Show the banned username if available
                if (username) {
                    const bannedUsernameElement = document.getElementById('banned-username');
                    const bannedUsernameValue = document.getElementById('banned-username-value');

                    if (bannedUsernameElement && bannedUsernameValue) {
                        bannedUsernameValue.textContent = username;
                        bannedUsernameElement.style.display = 'block';
                    }
                }

                // Scroll to the ban message
                banMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                console.error('Ban message element not found on login page');
            }

            // Hide loading overlay if it's visible
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }

            // Clear all login data to prevent auto-login
            localStorage.removeItem('token');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            localStorage.removeItem('currentUser');

            // Store the ban status in localStorage to ensure it persists across page refreshes
            localStorage.setItem('loginPageBanMessageShown', 'true');

            // Keep the ban flags in sessionStorage to ensure they're available for other pages
            sessionStorage.setItem('userBanned', 'true');
        }

        // Function to check if the user is banned
        async function checkBanStatus() {
            try {
                console.log('Checking ban status on login page');

                // Get any banned username from URL or storage
                let bannedUsername = new URLSearchParams(window.location.search).get('bannedUser');
                if (!bannedUsername) {
                    bannedUsername = localStorage.getItem('bannedUsername') || sessionStorage.getItem('bannedUsername');
                } else {
                    // Store the banned username for future reference
                    localStorage.setItem('bannedUsername', bannedUsername);
                }

                // If we have a banned username, verify with the server first
                if (bannedUsername) {
                    console.log(`Verifying ban status with server for username: ${bannedUsername}`);

                    try {
                        // Check with the server if this user is actually banned
                        const response = await fetch(`https://tridex1.onrender.com/users/check-ban/${bannedUsername}`);

                        if (response.ok) {
                            const data = await response.json();
                            console.log(`Server says user ${bannedUsername} ban status is: ${data.isBanned}`);

                            // If the server says the user is not banned, clear all ban flags
                            if (!data.isBanned) {
                                console.log(`Server confirms ${bannedUsername} is NOT banned, clearing all ban flags`);
                                localStorage.removeItem('loginPageBanMessageShown');
                                localStorage.removeItem('bannedUsername');
                                sessionStorage.removeItem('userBanned');
                                sessionStorage.removeItem('showBanMessage');

                                // Also update the bannedUsers list
                                try {
                                    const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                                    const updatedList = bannedUsers.filter(user => user !== bannedUsername);
                                    localStorage.setItem('bannedUsers', JSON.stringify(updatedList));
                                    sessionStorage.setItem('bannedUsers', JSON.stringify(updatedList));
                                } catch (error) {
                                    console.error('Error updating banned users list:', error);
                                }

                                // If the ban system is available, update it
                                if (window.banSystem && typeof window.banSystem.unbanUser === 'function') {
                                    window.banSystem.unbanUser(bannedUsername);
                                }

                                return false; // User is not banned according to server
                            }
                        }
                    } catch (error) {
                        console.error('Error checking ban status with server:', error);
                        // Continue with local checks if server check fails
                    }
                }

                // Check if the ban message was already shown on this page
                if (localStorage.getItem('loginPageBanMessageShown') === 'true') {
                    console.log('Ban message already shown on login page');

                    // Double-check with the server if we have a username
                    if (bannedUsername) {
                        try {
                            const response = await fetch(`https://tridex1.onrender.com/users/check-ban/${bannedUsername}`);
                            if (response.ok) {
                                const data = await response.json();
                                if (!data.isBanned) {
                                    console.log(`Server confirms ${bannedUsername} is NOT banned, clearing ban message flag`);
                                    localStorage.removeItem('loginPageBanMessageShown');
                                    return false;
                                }
                            }
                        } catch (error) {
                            console.error('Error verifying ban status with server:', error);
                        }
                    }

                    showBanMessage(bannedUsername);
                    return true;
                }

                // Check if the user was redirected here due to a ban
                const banRedirect = new URLSearchParams(window.location.search).get('banned');
                if (banRedirect === 'true') {
                    console.log('User was redirected here due to a ban parameter in URL');

                    // Verify with the server if we have a username
                    if (bannedUsername) {
                        try {
                            const response = await fetch(`https://tridex1.onrender.com/users/check-ban/${bannedUsername}`);
                            if (response.ok) {
                                const data = await response.json();
                                if (!data.isBanned) {
                                    console.log(`Server confirms ${bannedUsername} is NOT banned, ignoring ban redirect`);
                                    return false;
                                }
                            }
                        } catch (error) {
                            console.error('Error verifying ban status with server:', error);
                        }
                    }

                    showBanMessage(bannedUsername);
                    return true;
                }

                // Check if there's a flag to show the ban message
                if (sessionStorage.getItem('showBanMessage') === 'true' || sessionStorage.getItem('userBanned') === 'true') {
                    console.log('Ban flag found in sessionStorage');

                    // Verify with the server if we have a username
                    if (bannedUsername) {
                        try {
                            const response = await fetch(`https://tridex1.onrender.com/users/check-ban/${bannedUsername}`);
                            if (response.ok) {
                                const data = await response.json();
                                if (!data.isBanned) {
                                    console.log(`Server confirms ${bannedUsername} is NOT banned, clearing session flags`);
                                    sessionStorage.removeItem('showBanMessage');
                                    sessionStorage.removeItem('userBanned');
                                    return false;
                                }
                            }
                        } catch (error) {
                            console.error('Error verifying ban status with server:', error);
                        }
                    }

                    showBanMessage(bannedUsername);
                    return true;
                }

                // Check if the current user is banned using the ban system
                const username = localStorage.getItem('username') || localStorage.getItem('currentUser');
                if (username) {
                    // First check with the server
                    try {
                        const response = await fetch(`https://tridex1.onrender.com/users/check-ban/${username}`);
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`Server says user ${username} ban status is: ${data.isBanned}`);

                            if (data.isBanned) {
                                console.log(`Server confirms ${username} IS banned`);
                                showBanMessage(username);
                                // Store the banned username for future reference
                                localStorage.setItem('bannedUsername', username);
                                return true;
                            } else {
                                // Server says user is not banned, make sure local storage reflects this
                                console.log(`Server confirms ${username} is NOT banned, updating local storage`);

                                // Update the bannedUsers list
                                try {
                                    const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                                    if (bannedUsers.includes(username)) {
                                        const updatedList = bannedUsers.filter(user => user !== username);
                                        localStorage.setItem('bannedUsers', JSON.stringify(updatedList));
                                        sessionStorage.setItem('bannedUsers', JSON.stringify(updatedList));
                                    }
                                } catch (error) {
                                    console.error('Error updating banned users list:', error);
                                }

                                // If the ban system is available, update it
                                if (window.banSystem && typeof window.banSystem.unbanUser === 'function') {
                                    window.banSystem.unbanUser(username);
                                }

                                // Clear all ban flags
                                localStorage.removeItem('loginPageBanMessageShown');
                                localStorage.removeItem('bannedUsername');
                                sessionStorage.removeItem('userBanned');
                                sessionStorage.removeItem('showBanMessage');

                                return false; // User is not banned according to server
                            }
                        }
                    } catch (error) {
                        console.error('Error checking ban status with server:', error);
                        // Continue with local checks if server check fails
                    }

                    // Fall back to local checks if server check fails
                    if (window.banSystem && window.banSystem.isUserBanned(username)) {
                        console.log(`User ${username} is banned according to ban system`);
                        showBanMessage(username);
                        // Store the banned username for future reference
                        localStorage.setItem('bannedUsername', username);
                        return true;
                    }

                    // Check if the user is in the banned users list in localStorage
                    try {
                        const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                        if (bannedUsers.includes(username)) {
                            console.log(`User ${username} found in banned users list`);
                            showBanMessage(username);
                            // Store the banned username for future reference
                            localStorage.setItem('bannedUsername', username);
                            return true;
                        }
                    } catch (error) {
                        console.error('Error parsing banned users list:', error);
                    }
                }

                // If we get here, the user is not banned, so clear any ban flags
                localStorage.removeItem('loginPageBanMessageShown');
                localStorage.removeItem('bannedUsername');
                sessionStorage.removeItem('userBanned');
                sessionStorage.removeItem('showBanMessage');

                return false;
            } catch (error) {
                console.error('Error checking ban status:', error);
                return false;
            }
        }

        // Function to handle async ban status checking
        function performBanCheck() {
            console.log('Performing ban status check');
            // Show loading indicator while checking
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }

            checkBanStatus().then(isBanned => {
                console.log('Ban check completed, user is banned:', isBanned);

                // Hide loading indicator
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }

                // If not banned, enable the form
                if (!isBanned) {
                    const usernameInput = document.getElementById('username');
                    const passwordInput = document.getElementById('password');
                    const submitButton = document.querySelector('#login-form button[type="submit"]');

                    if (usernameInput) usernameInput.disabled = false;
                    if (passwordInput) passwordInput.disabled = false;
                    if (submitButton) submitButton.disabled = false;
                }
            }).catch(error => {
                console.error('Error during ban check:', error);

                // Hide loading indicator
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            });
        }

        // Check ban status immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', performBanCheck);
        } else {
            performBanCheck();
        }

        // Also check on window load
        window.addEventListener('load', function() {
            console.log('Login page loaded, checking for banned status');
            performBanCheck();
        });

        // Check again after a short delay to catch any race conditions
        setTimeout(performBanCheck, 500);
    })();

    document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Hide any previous error messages
        document.getElementById('login-error').style.display = 'none';

        // Don't hide the ban message if it's already shown
        // document.getElementById('login-ban-message').style.display = 'none';

        // Show loading indicator
        showLoading();

        const userInput = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        // Basic validation
        if (!userInput || !password) {
            document.getElementById('login-error').textContent = 'Please enter both username and password.';
            document.getElementById('login-error').style.display = 'block';
            hideLoading();
            return;
        }

        // Function to handle banned user login attempt
        function handleBannedUser(username) {
            console.log(`Login attempt by banned user: ${username}`);

            // Show the ban message prominently
            const banMessage = document.getElementById('login-ban-message');
            if (banMessage) {
                banMessage.style.display = 'block';

                // Add a subtle animation to make it more noticeable
                banMessage.style.animation = 'none';
                void banMessage.offsetWidth; // Trigger reflow
                banMessage.style.animation = 'pulse 1s ease-in-out';

                // Show the banned username if available
                if (username) {
                    const bannedUsernameElement = document.getElementById('banned-username');
                    const bannedUsernameValue = document.getElementById('banned-username-value');

                    if (bannedUsernameElement && bannedUsernameValue) {
                        bannedUsernameValue.textContent = username;
                        bannedUsernameElement.style.display = 'block';
                    }
                }

                // Scroll to the ban message
                banMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Clear any existing login data
            localStorage.removeItem('token');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            localStorage.removeItem('currentUser');

            // Set flags to remember the ban status
            sessionStorage.setItem('userBanned', 'true');
            localStorage.setItem('loginPageBanMessageShown', 'true');

            // Store the banned username for future reference
            localStorage.setItem('bannedUsername', username);

            // Hide loading overlay
            hideLoading();

            // Disable the login form
            document.getElementById('username').disabled = true;
            document.getElementById('password').disabled = true;
            document.querySelector('#login-form button[type="submit"]').disabled = true;
        }

        // Always check if user is banned before attempting to log in

        // First check with the server
        try {
            // Show a temporary loading message
            const tempLoadingMsg = document.createElement('div');
            tempLoadingMsg.style.cssText = 'color:#007bff; margin-top:10px; font-size:0.9em;';
            tempLoadingMsg.textContent = 'Verifying account status...';
            document.getElementById('login-error').after(tempLoadingMsg);

            // Check with the server
            const response = await fetch(`https://tridex1.onrender.com/users/check-ban/${userInput}`);

            // Remove the temporary message
            tempLoadingMsg.remove();

            if (response.ok) {
                const data = await response.json();
                console.log(`Server says user ${userInput} ban status is: ${data.isBanned}`);

                if (data.isBanned) {
                    console.log(`Server confirms ${userInput} IS banned`);

                    // Update local storage to match server
                    if (window.banSystem) {
                        window.banSystem.banUser(userInput);
                    } else {
                        // If ban system is not available, add to banned users list directly
                        try {
                            const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                            if (!bannedUsers.includes(userInput)) {
                                bannedUsers.push(userInput);
                                localStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                                sessionStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                            }
                        } catch (error) {
                            console.error('Error updating banned users list:', error);
                        }
                    }

                    handleBannedUser(userInput);
                    return;
                } else {
                    // Server says user is not banned, make sure local storage reflects this
                    console.log(`Server confirms ${userInput} is NOT banned, updating local storage`);

                    // Clear all ban flags
                    localStorage.removeItem('loginPageBanMessageShown');
                    localStorage.removeItem('bannedUsername');
                    sessionStorage.removeItem('userBanned');
                    sessionStorage.removeItem('showBanMessage');

                    // Update the bannedUsers list
                    try {
                        const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                        if (bannedUsers.includes(userInput)) {
                            const updatedList = bannedUsers.filter(user => user !== userInput);
                            localStorage.setItem('bannedUsers', JSON.stringify(updatedList));
                            sessionStorage.setItem('bannedUsers', JSON.stringify(updatedList));
                        }
                    } catch (error) {
                        console.error('Error updating banned users list:', error);
                    }

                    // If the ban system is available, update it
                    if (window.banSystem && typeof window.banSystem.unbanUser === 'function') {
                        window.banSystem.unbanUser(userInput);
                    }
                }
            }
        } catch (error) {
            console.error('Error checking ban status with server:', error);

            // Fall back to local checks if server check fails

            // Check if the ban message is already shown
            if (localStorage.getItem('loginPageBanMessageShown') === 'true') {
                console.log('Ban message already shown on login page');
                handleBannedUser(userInput);
                return;
            }

            // Check using the ban system
            if (window.banSystem && window.banSystem.isUserBanned(userInput)) {
                console.log(`User ${userInput} is banned according to ban system`);
                handleBannedUser(userInput);
                return;
            }

            // Check the banned users list directly
            try {
                const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                if (bannedUsers.includes(userInput)) {
                    console.log(`User ${userInput} found in banned users list`);

                    // If the user is in the banned list but not detected by the ban system,
                    // make sure the ban system is updated
                    if (window.banSystem) {
                        window.banSystem.banUser(userInput);
                    }

                    handleBannedUser(userInput);
                    return;
                }
            } catch (error) {
                console.error('Error checking banned users list:', error);
            }
        }

        try {
            console.log('Attempting to login with:', { username: userInput });

            // First try to connect to the remote server
            try {
                // Use the correct server URL
                const apiUrl = 'https://tridex1.onrender.com/login';
                console.log('Connecting to server:', apiUrl);

                // Add timeout to prevent hanging requests
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                // Don't use credentials mode with wildcard CORS
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ username: userInput, password }),
                    // Don't use credentials: 'include' with wildcard CORS
                    signal: controller.signal
                });

                // Clear the timeout if the request completes
                clearTimeout(timeoutId);

                console.log('Login response status:', res.status);

                // If server returns 500, show a specific message
                if (res.status === 500) {
                    throw new Error('The server is experiencing issues. Please try again later or contact support.');
                }

                // For debugging - log the raw response text
                const responseText = await res.text();
                console.log('Raw response:', responseText);

                // Try to parse the JSON response
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('Parsed response:', result);
                } catch (parseError) {
                    console.error('Error parsing response:', parseError);
                    throw new Error('Invalid response from server');
                }

                if (res.ok && result.token) {
                    // Check if user is banned (from server response)
                    if (result.isBanned) {
                        console.log('Server response indicates user is banned');

                        // Ban the user using our ban system
                        if (window.banSystem) {
                            window.banSystem.banUser(result.username || userInput);
                        } else {
                            // If ban system is not available, add to banned users list directly
                            try {
                                const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                                if (!bannedUsers.includes(userInput)) {
                                    bannedUsers.push(userInput);
                                    localStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                                    sessionStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                                }
                            } catch (error) {
                                console.error('Error updating banned users list:', error);
                            }
                        }

                        // Handle the banned user
                        handleBannedUser(result.username || userInput);
                        console.error('Login failed: User is banned');
                        return;
                    }

                    // After successful login, replaceState to remove login from history
                    function handleSuccessfulLogin(userInput, isAdmin, verified) {
                        const token = 'fake-jwt-token-' + Date.now();
                        localStorage.setItem('token', token);
                        localStorage.setItem('isAdmin', isAdmin ? 'true' : 'false');
                        localStorage.setItem('username', userInput);
                        localStorage.setItem('verified', verified ? 'true' : 'false');
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('currentUser', userInput);
                        // Replace login page in history
                        window.location.replace('index.html');
                    }

                    // For local testing - bypass actual login
                    // handleSuccessfulLogin(userInput, false, true);

                    // Regular login flow
                    localStorage.setItem('token', result.token);
                    // Store isAdmin as a string for consistent checking
                    localStorage.setItem('isAdmin', result.isAdmin ? 'true' : 'false');
                    localStorage.setItem('username', result.username || userInput);
                    // Store verified status
                    localStorage.setItem('verified', result.verified ? 'true' : 'false');
                    // Set isLoggedIn flag to true - this is needed for cart and mailbox access
                    localStorage.setItem('isLoggedIn', 'true');
                    // Also set currentUser for cart functionality
                    localStorage.setItem('currentUser', result.username || userInput);
                    console.log('Login successful, redirecting...');

                    // Redirect based on user type
                    if (result.isAdmin) {
                        window.location.href = 'admin.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                } else {
                    console.error('Login failed:', result);

                    // Check if the error is due to a ban
                    if (result.isBanned) {
                        console.log('Server error response indicates user is banned');

                        // Ban the user using our ban system
                        if (window.banSystem) {
                            window.banSystem.banUser(userInput);
                        } else {
                            // If ban system is not available, add to banned users list directly
                            try {
                                const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                                if (!bannedUsers.includes(userInput)) {
                                    bannedUsers.push(userInput);
                                    localStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                                    sessionStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
                                }
                            } catch (error) {
                                console.error('Error updating banned users list:', error);
                            }
                        }

                        // Handle the banned user
                        handleBannedUser(userInput);
                    } else {
                        // Show regular error message
                        document.getElementById('login-error').textContent = result.message || 'Incorrect username or password.';
                        document.getElementById('login-error').style.display = 'block';
                    }
                }
            } catch (serverError) {
                // Server connection failed (could be CORS, network issues, etc.)
                console.error('Server connection failed:', serverError);

                // Fall back to local storage authentication
                console.log('Falling back to local storage authentication');

                // Try to authenticate using localStorage
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.username === userInput && u.password === password);

                if (user) {
                    // Check if user is banned
                    if (window.banSystem && window.banSystem.isUserBanned(userInput)) {
                        console.log(`Local login attempt by banned user: ${userInput}`);
                        document.getElementById('login-ban-message').style.display = 'block';
                        document.getElementById('login-ban-message').scrollIntoView({ behavior: 'smooth' });

                        // Clear any existing login data
                        localStorage.removeItem('token');
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('username');
                        localStorage.removeItem('currentUser');

                        return;
                    }

                    // Create a fake token
                    const token = 'fake-jwt-token-' + Date.now();

                    // Set user data in localStorage
                    localStorage.setItem('token', token);
                    localStorage.setItem('isAdmin', userInput === 'admin' ? 'true' : 'false');
                    localStorage.setItem('username', userInput);
                    localStorage.setItem('verified', user.verified ? 'true' : 'false');
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('currentUser', userInput);

                    console.log('Local login successful, redirecting...');

                    // Redirect based on user type
                    if (userInput === 'admin') {
                        window.location.href = 'admin.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                } else {
                    // Check hardcoded admin/user credentials as a last resort
                    if ((userInput === 'admin' && password === 'admin123') ||
                        (userInput === 'user' && password === 'user123')) {

                        // Check if user is banned using multiple methods

                        // Method 1: Check using the ban system
                        if (window.banSystem && window.banSystem.isUserBanned(userInput)) {
                            console.log(`Hardcoded login attempt by banned user: ${userInput}`);
                            handleBannedUser(userInput);
                            return;
                        }

                        // Method 2: Check the banned users list directly
                        try {
                            const bannedUsers = JSON.parse(localStorage.getItem('bannedUsers') || '[]');
                            if (bannedUsers.includes(userInput)) {
                                console.log(`Hardcoded login attempt by banned user (from list): ${userInput}`);

                                // If the user is in the banned list but not detected by the ban system,
                                // make sure the ban system is updated
                                if (window.banSystem) {
                                    window.banSystem.banUser(userInput);
                                }

                                handleBannedUser(userInput);
                                return;
                            }
                        } catch (error) {
                            console.error('Error checking banned users list:', error);
                        }

                        // Method 3: Check sessionStorage for ban flags
                        if (sessionStorage.getItem('userBanned') === 'true') {
                            console.log(`Hardcoded login attempt while ban flag is set`);
                            handleBannedUser(userInput);
                            return;
                        }

                        // Create a fake token
                        const token = 'fake-jwt-token-' + Date.now();

                        // Set user data in localStorage
                        localStorage.setItem('token', token);
                        localStorage.setItem('isAdmin', userInput === 'admin' ? 'true' : 'false');
                        localStorage.setItem('username', userInput);
                        localStorage.setItem('verified', userInput === 'admin' ? 'true' : 'false');
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('currentUser', userInput);

                        console.log('Hardcoded login successful, redirecting...');

                        // Redirect based on user type
                        if (userInput === 'admin') {
                            window.location.href = 'admin.html';
                        } else {
                            window.location.href = 'index.html';
                        }
                    } else {
                        // No valid user found
                        document.getElementById('login-error').textContent = 'Incorrect username or password.';
                        document.getElementById('login-error').style.display = 'block';
                    }
                }
            }
        } catch (err) {
            console.error('Login error:', err);

            // Display a user-friendly error message based on the error type
            let errorMessage = 'An unexpected error occurred. Please try again later.';

            if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
                errorMessage = 'Unable to connect to the server. The application will use local storage instead.';
            } else if (err.name === 'AbortError') {
                errorMessage = 'The request timed out. Please try again later.';
            } else if (err.message && err.message.includes('CORS')) {
                errorMessage = 'CORS restrictions detected. The application will use local storage instead.';
            } else if (err.message && err.message.includes('NetworkError')) {
                errorMessage = 'Network error detected. The application will use local storage instead.';
            } else if (err.message) {
                errorMessage = err.message;
            }

            document.getElementById('login-error').textContent = errorMessage;
            document.getElementById('login-error').style.display = 'block';
        } finally {
            // Hide loading indicator
            hideLoading();
        }
    });

    // Toggle password visibility for login
    document.getElementById('toggle-login-password').addEventListener('click', function() {
        const pwd = document.getElementById('password');
        if (pwd.type === 'password') {
            pwd.type = 'text';
            this.textContent = 'üôà';
        } else {
            pwd.type = 'password';
            this.textContent = 'üëÅÔ∏è';
        }
    });

    // Signup functionality moved to signup.html

    // Forgot password link
    document.getElementById('forgot-password-link').onclick = function(e) {
        e.preventDefault();
        window.location.href = 'forgotpassword.html';
    };

    // Signup functionality moved to signup.html

    function showLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
    }
    function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }
    window.addEventListener('load', function() {
        hideLoading();
    });
    window.addEventListener('beforeunload', function() {
        showLoading();
    });
    </script>
</body>
</html>
