<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <link rel="stylesheet" href="auth.css">
</head>
<body>
    <!-- Loading animation overlay -->
    <div id="loading-overlay" style="display:flex; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:99999; align-items:center; justify-content:center;">
        <div style="border:6px solid #f3f3f3; border-top:6px solid #007bff; border-radius:50%; width:48px; height:48px; animation:spin 1s linear infinite;"></div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
    <div class="login-container">
        <h2>Login</h2>
        <form id="login-form" action="index.html" method="get">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required placeholder="Username / Email / Phone Number">
            <label for="password">Password</label>
            <div style="display:flex; align-items:center; position:relative;">
                <input type="password" id="password" name="password" required style="padding-right:32px; flex:1;">
                <span id="toggle-login-password"
                    style="position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; user-select:none; font-size:1.1em; color:#888;">
                    üëÅÔ∏è
                </span>
            </div>
            <button type="submit">Login</button>
        </form>
        <div id="login-error" style="color:red; margin-top:10px; display:none;">
            Incorrect username or password.
        </div>
        <a href="#" id="forgot-password-link" style="display:block; margin-top:10px; text-align:right; color:#007bff; text-decoration:underline; cursor:pointer;">Forgot Password?</a>
        <a href="signup.html"><button class="signup-btn" type="button">Sign Up</button></a>
        <div id="signup-form" style="display:none; margin-top:20px;">
            <h2>Sign Up</h2>
            <form id="signup-inner-form" action="#" method="post">
                <label for="new-name">Full Name</label>
                <input type="text" id="new-name" name="new-name" required placeholder="Your full name">

                <label for="new-age">Age</label>
                <input type="number" id="new-age" name="new-age" required min="13" max="120" placeholder="Your age">

                <label for="new-gender">Gender</label>
                <select id="new-gender" name="new-gender" required style="padding:10px 14px; margin-bottom:12px; border:1.5px solid #bdbdbd; border-radius:8px; font-size:1rem; background:#f9f9f9;">
                    <option value="">Select gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                </select>

                <label for="new-username">Username</label>
                <input type="text" id="new-username" name="new-username" required placeholder="Choose a username">

                <label for="new-email">Email</label>
                <input type="email" id="new-email" name="new-email" required placeholder="Your email address">

                <label for="new-phone">Phone</label>
                <input type="tel" id="new-phone" name="new-phone" required placeholder="Your phone number">

                <label for="new-password">Password</label>
                <div style="display:flex; align-items:center; position:relative;">
                    <input type="password" id="new-password" required style="padding-right:32px; flex:1;" placeholder="Choose a password">
                    <span id="toggle-signup-password"
                        style="position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; user-select:none; font-size:1.1em; color:#888;">
                        üëÅÔ∏è
                    </span>
                </div>
                <button type="submit">Create Account</button>
            </form>
            <div id="signup-success" style="color:green; margin-top:10px; display:none;">Account created! Please login.</div>
        </div>
    </div>
    <script>
    // Show signup form when signup button is clicked
    document.querySelector('.signup-btn').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('signup-form').style.display = 'block';
        // Scroll to the signup form
        document.getElementById('signup-form').scrollIntoView({ behavior: 'smooth' });
    });

    // Check if the server is running
    async function checkServerStatus() {
        try {
            const response = await fetch('https://tridex1.onrender.com/', { method: 'GET' });
            console.log('Server status check:', response.status);
            if (response.ok) {
                console.log('Server is running');
                return true;
            } else {
                console.error('Server returned error:', response.status);
                return false;
            }
        } catch (err) {
            console.error('Server check failed:', err);
            return false;
        }
    }

    // Check server status on page load
    checkServerStatus().then(isRunning => {
        if (!isRunning) {
            document.getElementById('login-error').textContent =
                'Server appears to be offline. Try using admin/admin123 or user/user123 for testing.';
            document.getElementById('login-error').style.display = 'block';
        }
    });

    document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Hide any previous error messages
        document.getElementById('login-error').style.display = 'none';

        // Show loading indicator
        showLoading();

        const userInput = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        // Basic validation
        if (!userInput || !password) {
            document.getElementById('login-error').textContent = 'Please enter both username and password.';
            document.getElementById('login-error').style.display = 'block';
            hideLoading();
            return;
        }

        try {
            console.log('Attempting to login with:', { username: userInput });

            // Try multiple URLs in case one is not working
            let apiUrl = 'https://tridex1.onrender.com/login';
            console.log('Trying API URL:', apiUrl);

            const res = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ username: userInput, password })
            });

            console.log('Login response status:', res.status);

            // For debugging - log the raw response text
            const responseText = await res.text();
            console.log('Raw response:', responseText);

            // Try to parse the JSON response
            let result;
            try {
                result = JSON.parse(responseText);
                console.log('Parsed response:', result);
            } catch (parseError) {
                console.error('Error parsing response:', parseError);
                throw new Error('Invalid response from server');
            }

            if (res.ok && result.token) {
                localStorage.setItem('token', result.token);
                // Store isAdmin as a string for consistent checking
                localStorage.setItem('isAdmin', result.isAdmin ? 'true' : 'false');
                console.log('Login successful, redirecting...');

                // Optionally, check if user is admin and redirect accordingly
                if (result.isAdmin) {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                console.error('Login failed:', result);
                document.getElementById('login-error').textContent = result.message || 'Incorrect username or password.';
                document.getElementById('login-error').style.display = 'block';
            }
        } catch (err) {
            console.error('Login error:', err);

            // FALLBACK: If server is unavailable, try local login for testing
            // This is a temporary solution for development/testing
            if (userInput === 'admin' && password === 'admin123') {
                console.log('Using fallback admin login');
                localStorage.setItem('token', 'local-dev-token');
                localStorage.setItem('isAdmin', 'true');
                window.location.href = 'admin.html';
                return;
            } else if (userInput === 'user' && password === 'user123') {
                console.log('Using fallback user login');
                localStorage.setItem('token', 'local-dev-token');
                localStorage.setItem('isAdmin', 'false');
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('login-error').textContent = 'Connection error: ' + err.message +
                '. Try using admin/admin123 or user/user123 for testing.';
            document.getElementById('login-error').style.display = 'block';
        } finally {
            // Hide loading indicator
            hideLoading();
        }
    });

    // Toggle password visibility for login
    document.getElementById('toggle-login-password').addEventListener('click', function() {
        const pwd = document.getElementById('password');
        if (pwd.type === 'password') {
            pwd.type = 'text';
            this.textContent = 'üôà';
        } else {
            pwd.type = 'password';
            this.textContent = 'üëÅÔ∏è';
        }
    });

    // Toggle password visibility for signup
    document.getElementById('toggle-signup-password').addEventListener('click', function() {
        const pwd = document.getElementById('new-password');
        if (pwd.type === 'password') {
            pwd.type = 'text';
            this.textContent = 'üôà';
        } else {
            pwd.type = 'password';
            this.textContent = 'üëÅÔ∏è';
        }
    });

    // Forgot password link
    document.getElementById('forgot-password-link').onclick = function(e) {
        e.preventDefault();
        window.location.href = 'forgotpassword.html';
    };

    // Sign up logic for the embedded form
    document.getElementById('signup-inner-form').onsubmit = async function(e) {
        e.preventDefault();

        // Show loading indicator
        showLoading();

        const name = document.getElementById('new-name').value.trim();
        const age = document.getElementById('new-age').value.trim();
        const gender = document.getElementById('new-gender').value;
        const username = document.getElementById('new-username').value.trim();
        const email = document.getElementById('new-email').value.trim();
        const phone = document.getElementById('new-phone').value.trim();
        const password = document.getElementById('new-password').value;

        // Basic validation
        if (!name || !age || !gender || !username || !email || !phone || !password) {
            alert('Please fill in all required fields');
            hideLoading();
            return;
        }

        // Email validation
        if (!email.includes('@') || !email.includes('.')) {
            alert('Please enter a valid email address');
            hideLoading();
            return;
        }

        try {
            const response = await fetch('https://tridex1.onrender.com/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    age: parseInt(age),
                    gender,
                    username,
                    email,
                    phone,
                    password
                })
            });

            const result = await response.json();

            if (response.ok) {
                document.getElementById('signup-success').textContent = 'Account created! Please login.';
                document.getElementById('signup-success').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('signup-form').style.display = 'none';
                    document.getElementById('signup-success').style.display = 'none';
                }, 2000);
            } else {
                alert(result.message || 'Signup failed. Please try again.');
            }
        } catch (err) {
            console.error('Signup error:', err);
            alert('Connection error. Please try again later.');
        } finally {
            hideLoading();
        }
    };

    function showLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
    }
    function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }
    window.addEventListener('load', function() {
        hideLoading();
    });
    window.addEventListener('beforeunload', function() {
        showLoading();
    });
    </script>
</body>
</html>
